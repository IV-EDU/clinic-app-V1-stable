<div id="schedule-modal" class="schedule-modal" hidden>
  <div class="schedule-modal__backdrop" data-modal-close></div>
  <div class="schedule-modal__panel" role="dialog" aria-modal="true" aria-labelledby="schedule-modal-title">
    <div class="schedule-modal__header">
      <h3 id="schedule-modal-title">{{ t('appointments') }}</h3>
      <button type="button" class="schedule-modal__close" aria-label="{{ t('close') if t('close') != 'close' else 'Close' }}" data-modal-close>&times;</button>
    </div>
    <div class="schedule-modal__body">
      <dl>
        <div>
          <dt>{{ t('name') }}</dt>
          <dd id="modal-patient-name"></dd>
        </div>
        <div>
          <dt>{{ t('file_no') }}</dt>
          <dd id="modal-file-no"></dd>
        </div>
        <div>
          <dt>{{ t('phone') }}</dt>
          <dd id="modal-phone"></dd>
        </div>
        <div>
          <dt>{{ t('appointments_doctor_label') }}</dt>
          <dd id="modal-doctor"></dd>
        </div>
        <div>
          <dt>{{ t('appointments_slot_label') }}</dt>
          <dd id="modal-time"></dd>
        </div>
        <div>
          <dt>{{ t('appointments_title_label') }}</dt>
          <dd id="modal-title"></dd>
        </div>
        <div>
          <dt>{{ t('status') }}</dt>
          <dd id="modal-status"></dd>
        </div>
        <div>
          <dt>{{ t('appointments_notes_label') }}</dt>
          <dd id="modal-notes"></dd>
        </div>
      </dl>
      <div class="modal-section">
        <h4>{{ t('appointments_today') }}</h4>
        <div id="modal-schedule-list" class="modal-schedule-list"></div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const modal = document.getElementById('schedule-modal');
  if (!modal) return;
  const backdrop = modal.querySelector('.schedule-modal__backdrop');
  const fields = {
    patient: document.getElementById('modal-patient-name'),
    file: document.getElementById('modal-file-no'),
    phone: document.getElementById('modal-phone'),
    doctor: document.getElementById('modal-doctor'),
    time: document.getElementById('modal-time'),
    title: document.getElementById('modal-title'),
    status: document.getElementById('modal-status'),
    notes: document.getElementById('modal-notes'),
  };
  const scheduleList = document.getElementById('modal-schedule-list');
  const viewLabels = {
    edit: {{ t('edit')|tojson }},
    noNotes: {{ (t('appointments_no_notes') if t('appointments_no_notes') != 'appointments_no_notes' else 'No notes')|tojson }},
    noSchedules: {{ (t('appointments_empty_hour') if t('appointments_empty_hour') != 'appointments_empty_hour' else 'No schedules for today')|tojson }}
  };
  const escapeHtml = (str = '') => String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');

  const openModal = (group) => {
    const selected = group.selected || {};
    fields.patient.textContent = group.patient_name || '—';
    fields.file.textContent = group.file_no || '—';
    fields.phone.textContent = group.phone || '—';
    fields.doctor.textContent = selected.doctor || '—';
    fields.time.textContent = selected.time || '—';
    fields.title.textContent = selected.title || '—';
    fields.status.textContent = selected.status_label || '—';
    fields.notes.textContent = selected.notes || viewLabels.noNotes;
    if (scheduleList) {
      const schedules = group.schedules || [];
      if (!schedules.length) {
        scheduleList.innerHTML = `<p class="no-appointments">${viewLabels.noSchedules}</p>`;
      } else {
        scheduleList.innerHTML = schedules.map((s) => `
          <div class="modal-schedule-item">
            <div class="modal-schedule-item__chips">
              <span class="info-chip info-chip--time info-chip--tiny">${escapeHtml(s.time)}</span>
              <span class="info-chip info-chip--tiny">${escapeHtml(s.doctor)}</span>
              <span class="info-chip info-chip--tiny status-pill">${escapeHtml(s.status_label)}</span>
            </div>
            <div class="title">${escapeHtml(s.title)}</div>
            <div class="notes">${escapeHtml(s.notes || viewLabels.noNotes)}</div>
            <div class="modal-schedule-item__chips" style="margin-top:10px;">
              <a class="btn-link" href="${escapeHtml(s.edit_url)}">${escapeHtml(viewLabels.edit)}</a>
            </div>
          </div>
        `).join('');
      }
    }
    modal.hidden = false;
    modal.classList.add('open');
  };

  const closeModal = () => {
    modal.classList.remove('open');
    modal.hidden = true;
  };

  document.addEventListener('click', (event) => {
    const trigger = event.target.closest('[data-group]');
    if (!trigger) {
      return;
    }
    const payload = trigger.getAttribute('data-group');
    if (!payload) return;
    try {
      const details = JSON.parse(payload);
      openModal(details);
    } catch (err) {
      console.error('Failed to open schedule modal', err);
    }
  });

  modal.querySelectorAll('[data-modal-close]').forEach((btn) => btn.addEventListener('click', closeModal));
  backdrop?.addEventListener('click', closeModal);
  document.addEventListener('keydown', function(e) {
    if (modal.classList.contains('open') && e.key === 'Escape') {
      closeModal();
    }
  });
})();
</script>
