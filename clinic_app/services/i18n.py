from __future__ import annotations
from typing import Dict

from flask import current_app, has_request_context, request

SUPPORTED_LOCALES = ("en", "ar")
FALLBACK_LOCALE = "en"

I18N: Dict[str, Dict[str, str]] = {
    "en": {
        "app_title": "Clinic App",
        "home": "Home",
        "add_patient": "+ Patient",
        "export_patients": "Export Patients (CSV)",
        "export_payments": "Export Payments (CSV)",
        "backup": "Backup DB (ZIP)",
        "login": "Login",
        "logout": "Logout",
        "lang_en": "English",
        "lang_ar": "العربية",
        "search_placeholder": "Search name or phone",
        "search": "Search",
        "clear": "Clear",
        "patients": "Patients",
        "total_received": "Today’s Collected",
        "no_patients": "No patients yet. Add one.",
        "file_no": "File Number",
        "file_no_hint": "Leave empty to auto-generate (e.g. P000123).",
        "file_no_exists": "File Number already exists. Choose another.",
        "dup_patient_name": "A patient with this name already exists.",
        "dup_patient_name_allowed": "Duplicate name detected. Saved anyway.",
        "auto_short_id": "Provided file number exists. Auto-generated a new one.",
        "name": "Name",
        "phone": "Phone",
        "notes": "Notes",
        "cancel": "Cancel",
        "save": "Save",
        "update": "Update",
        "new_patient": "New Patient",
        "open": "Open",
        "edit_patient": "Edit Patient",
        "payments": "Payments",
        "diagnosis": "Diagnosis",
        "date": "Date",
        "method": "Method",
        "amount": "Paid Today",
        "total": "Total",
        "new_payment": "Add Payment",
        "optional": "optional",
        "created_patient": "Patient created",
        "updated_patient": "Patient updated",
        "payment_recorded": "Payment added",
        "edit_payment": "Edit",
        "delete_payment": "Delete",
        "edit_payment_title": "Edit Payment",
        "delete_payment_title": "Confirm Delete Payment",
        "delete_payment_warn": "This will permanently remove this payment entry.",
        "deleted_payment_ok": "Payment deleted",
        "updated_payment_ok": "Payment updated",
        "patient_header": "Patient",
        "submit_add_payment": "Add Payment",
        "back_to_patient": "Back to Patient",
        "total_amount": "Total Amount",
        "down_payment": "Paid Today",
        "remaining_amount": "Remaining Amount",
        "discount": "Discount",
        "discount_hint": "Deducted from total before remaining is calculated",
        "treatment_type": "Treatment Type",
        "sheet_notes": "Notes",
        "actions": "Actions",
        "balance": "Balance",
        "view": "View",
        "hide": "Hide",
        "summary_total": "Total",
        "summary_paid": "Paid",
        "summary_remaining": "Remaining",
        "summary_discount": "Discount",
        "delete_patient": "Delete Patient",
        "delete_title": "Delete Patient",
        "delete_warn": "This will permanently delete the patient and all their payments.",
        "delete_cancel": "Cancel",
        "delete_yes": "Yes, delete",
        "deleted_patient_ok": "Patient deleted",
        "err_money_too_large": "Amount is too large. Maximum is 10,000,000.00",
        "err_overpaid": "Paid Today cannot exceed Due (Total + diagnosis - discount).",
        "err_discount_gt_total": "Discount cannot exceed Total (plus diagnosis)",
        "visit_type": "Visit Type",
        "vt_none": "—",
        "vt_exam": "Diagnosis (+100)",
        "vt_follow": "Follow-up",
        "exam_bonus": "diagnosis +100",
        "overall_balance": "Overall Balance",
        "back": "Back",
        "visit": "Visit",
        "collections": "Collections",
        "tab_daily": "Daily",
        "tab_monthly": "Monthly",
        "from": "From",
        "to": "To",
        "filter": "Filter",
        "reset": "Reset",
        "collected": "Collected",
        "month": "Month",
        "view_day": "View day",
        "view_month": "View month",
        "export": "Export CSV",
        "no_rows": "—",
        "dup_found_title": "Possible duplicate found",
        "dup_found_msg": "A patient with the same name/phone/file may exist.",
        "save_anyway": "Save anyway",
        "try_again": "Try again",
        "images_page_title": "Patient Images",
        "import_images": "Import",
        "select_all": "Select all",
        "clear_selection": "Clear selection",
        "export_selected": "Export selected",
        "export_all": "Export all images",
        "open_images_manager": "Images",
        "no_images_yet": "No images yet",
        "exam_bonus_hint": "Diagnosis adds 100 before discounts.",
        "method_cash": "Cash",
        "method_card": "Card",
        "method_transfer": "Transfer",
        "method_other": "Other",
        "appointments": "Appointments",
        "appointments_today": "Today's schedules",
        "appointments_new": "Plan Appointment",
        "appointments_filters": "Filters",
        "appointments_day_label": "Day",
        "appointments_doctor_label": "Doctor",
        "appointments_doctor_all": "All doctors",
        "appointments_slot_label": "Start time",
        "appointments_duration_label": "Duration (minutes)",
        "appointments_notes_label": "Visit notes",
        "appointments_patient_lookup": "Patient (file # or name)",
        "appointments_patient_name": "Patient name (optional)",
        "appointments_patient_phone": "Phone (optional)",
        "appointments_title_label": "Visit title",
        "appointments_submit": "Save appointment",
        "appointments_empty_hour": "No appointments booked for this hour.",
        "appointments_range_label": "Range",
        "appointments_range_today": "Today only",
        "appointments_range_next3": "Next 3 days",
        "appointments_range_next7": "Next 7 days",
        "appointments_range_all": "All upcoming",
        "appointments_show_label": "Show",
        "appointments_show_upcoming": "Upcoming only",
        "appointments_show_past": "Past only",
        "appointments_show_all": "All schedules",
        "appointments_search_label": "Search",
        "appointments_total_label": "Total schedules",
        "appointments_search_placeholder": "Patient name, phone, or file #",
        "appointments_no_notes": "No notes",
        "appointment_conflict": "Another visit already occupies this slot.",
        "appointment_status_scheduled": "Scheduled",
        "appointment_status_checked_in": "Checked in",
        "appointment_status_in_progress": "In progress",
        "appointment_status_done": "Done",
        "appointment_status_no_show": "No-show",
        "appointment_status_cancelled": "Cancelled",
        "appointments_more_chip": "+{count} more",
        "receipts": "Receipts",
        "receipts_new": "Issue Receipt",
        "receipts_recent": "Recent receipts",
        "receipts_patient_placeholder": "File # or name",
        "receipts_description_placeholder": "Description shown on the receipt",
        "receipts_amount": "Amount",
        "receipts_locale": "Language",
        "receipts_pdf": "Download PDF",
        "receipts_reprint": "Reprint",
        "receipts_success": "Receipt issued",
        "receipts_reprint_done": "Reprint saved",
        "receipt_heading": "Clinic Receipt",
        "receipt_number_label": "Receipt No.",
        "receipt_date_label": "Date",
        "receipt_patient_label": "Patient",
        "receipt_phone_label": "Phone",
        "receipt_description_label": "Description",
        "receipt_amount_label": "Amount",
        "receipt_qr_hint": "QR payload",
        "receipt_default_desc": "Dental services",
        "appointments_table_missing": "Run `flask db upgrade` to enable appointments.",
        "receipts_table_missing": "Run `flask db upgrade` to enable receipts.",
        "amount_required": "Enter a valid amount",
        "patient_not_found": "Patient not found",
        "receipt_not_found": "Receipt not found",
        "title_required": "Title is required",
        "invalid_status": "Invalid status",
        "invalid_datetime": "Invalid date or time",
        "roles_manage_title": "Roles & permissions",
        "roles_new_button": "New role",
        "roles_edit_heading": "Edit role",
        "role_form_name": "Role name",
        "role_form_description": "Description",
        "role_form_permissions": "Permissions",
        "role_permissions_hint": "Select the allowed actions for this role.",
        "role_created": "Role created",
        "role_updated": "Role updated",
        "role_exists": "Role name already exists.",
        "role_name_required": "Role name must be at least 2 characters.",
        "role_not_found": "Role not found",
        # Print Receipt Features
        "print_receipt": "Print Receipt",
        "print_receipt_title": "Print Payment Receipt",
        "receipt_format": "Receipt Format",
        "format_full": "Full",
        "format_summary": "Summary",
        "format_treatment": "Treatment",
        "format_payment": "Payment Only",
        "preview_receipt": "Preview Receipt",
        "print_confirmation": "Do you want to print the receipt?",
        "receipt_generation_error": "Error generating receipt: {error}",
        "receipt_downloaded": "Receipt downloaded successfully",
        "print_loading": "Generating receipt...",
        "print_success": "Receipt printed successfully",
        "print_error": "Failed to generate receipt. Please try again.",
        "include_qr": "Include QR Code",
        "include_notes": "Include Treatment Notes",
        "include_treatment": "Include treatment details",
        "add_watermark": "Add Copy Watermark",
        "download_pdf": "Download PDF",
        # PDF specific keys
        "patient_name": "Patient Name",
        "file_no": "File Number",
        "payment_date": "Payment Date",
        "payment_method": "Payment Method",
        "total_amount": "Total Amount",
        "discount": "Discount",
        "paid_amount": "Paid Amount",
        "remaining_balance": "Remaining Balance",
        "treatment": "Treatment",
        "patient": "Patient",
        "date": "Date",
        "amount_paid": "Amount Paid",
        "method": "Method",
        "treatment_date": "Treatment Date",
        "total_cost": "Total Cost",
        "amount": "Amount",
        "reference": "Reference",
        "paid": "Paid",
        "receipt_id_label": "Receipt ID: {receipt_id}",
        "generated_label": "Generated: {current_time}",
        "thank_you_message": "Thank you for choosing our clinic!",
        # Copy watermark feature
        "copy_watermark": "CLINIC COPY",
        "copy_watermark_description": "Marks receipts as clinic copies for internal use",
    },
    "ar": {
        "app_title": "تطبيق العيادة",
        "home": "الرئيسية",
        "add_patient": "+ مريض",
        "export_patients": "تصدير المرضى (CSV)",
        "export_payments": "تصدير المدفوعات (CSV)",
        "backup": "نسخة احتياطية (ZIP)",
        "login": "تسجيل الدخول",
        "logout": "تسجيل الخروج",
        "lang_en": "English",
        "lang_ar": "العربية",
        "search_placeholder": "ابحث بالاسم أو الهاتف",
        "search": "بحث",
        "clear": "مسح",
        "patients": "عدد المرضى",
        "total_received": "تحصيل اليوم",
        "no_patients": "لا يوجد مرضى بعد. أضف مريضًا.",
        "file_no": "رقم الملف",
        "file_no_hint": "اتركه فارغًا ليتم إنشاؤه تلقائيًا (مثل P000123).",
        "file_no_exists": "رقم الملف موجود بالفعل. اختر رقمًا آخر.",
        "dup_patient_name": "يوجد مريض بنفس الاسم بالفعل.",
        "dup_patient_name_allowed": "تم حفظ اسم مكرر.",
        "dup_patient_name_confirm": "يوجد مريض بنفس الاسم. هل تريد المتابعة؟",
        "auto_short_id": "رقم الملف مستخدم. تم إنشاء رقم تلقائي.",
        "name": "الاسم",
        "phone": "رقم التلفون",
        "notes": "ملاحظات",
        "cancel": "إلغاء",
        "save": "حفظ",
        "update": "تحديث",
        "new_patient": "مريض جديد",
        "open": "فتح",
        "edit_patient": "تعديل بيانات المريض",
        "payments": "المدفوعات",
        "diagnosis": "التشخيص",
        "date": "التاريخ",
        "method": "الطريقة",
        "amount": "مدفوع اليوم",
        "total": "الإجمالي",
        "new_payment": "إضافة دفعة",
        "optional": "اختياري",
        "created_patient": "تم إنشاء المريض",
        "updated_patient": "تم تحديث بيانات المريض",
        "payment_recorded": "تمت إضافة الدفعة",
        "edit_payment": "تعديل",
        "delete_payment": "حذف",
        "edit_payment_title": "تعديل الدفعة",
        "delete_payment_title": "تأكيد حذف الدفعة",
        "delete_payment_warn": "سيتم حذف الدفعة بشكل نهائي.",
        "deleted_payment_ok": "تم حذف الدفعة",
        "updated_payment_ok": "تم تحديث الدفعة",
        "patient_header": "المريض",
        "submit_add_payment": "إضافة الدفعة",
        "back_to_patient": "رجوع لملف المريض",
        "total_amount": "اجمالي المبلغ",
        "down_payment": "دفعة اليوم",
        "remaining_amount": "المتبقي",
        "discount": "خصم",
        "discount_hint": "يطرح من الإجمالي قبل حساب المتبقي",
        "treatment_type": "نوع العلاج",
        "sheet_notes": "ملاحظات",
        "actions": "إجراءات",
        "balance": "الرصيد",
        "view": "عرض",
        "hide": "إخفاء",
        "summary_total": "الإجمالي",
        "summary_paid": "المدفوع",
        "summary_remaining": "المتبقي",
        "summary_discount": "الخصم",
        "delete_patient": "حذف المريض",
        "delete_title": "حذف المريض",
        "delete_warn": "سيتم حذف المريض وكل مدفوعاته بشكل نهائي.",
        "delete_cancel": "إلغاء",
        "delete_yes": "نعم، حذف",
        "deleted_patient_ok": "تم حذف المريض",
        "err_money_too_large": "المبلغ كبير جدًا. الحد الأقصى 10,000,000.00",
        "err_overpaid": "لا يمكن أن تتجاوز دفعة اليوم المستحق (الإجمالي + التشخيص - الخصم).",
        "err_discount_gt_total": "لا يمكن أن يتجاوز الخصم الإجمالي (مع التشخيص)",
        "visit_type": "نوع الزيارة",
        "vt_none": "—",
        "vt_exam": "تشخيص (+100)",
        "vt_follow": "متابعة",
        "exam_bonus": "تشخيص +100",
        "overall_balance": "الرصيد الكلي",
        "back": "رجوع",
        "visit": "الزيارة",
        "collections": "التحصيلات",
        "tab_daily": "يومي",
        "tab_monthly": "شهري",
        "from": "من",
        "to": "إلى",
        "filter": "تصفية",
        "reset": "إعادة ضبط",
        "collected": "المتحصل",
        "month": "الشهر",
        "view_day": "عرض اليوم",
        "view_month": "عرض الشهر",
        "export": "تصدير CSV",
        "no_rows": "—",
        "dup_found_title": "تم العثور على تكرار محتمل",
        "dup_found_msg": "قد يوجد مريض بنفس الاسم/الهاتف/رقم الملف.",
        "save_anyway": "حفظ على أي حال",
        "try_again": "حاول مرة أخرى",
        "images_page_title": "صور المريض",
        "import_images": "استيراد",
        "select_all": "تحديد الكل",
        "clear_selection": "مسح التحديد",
        "export_selected": "تصدير المحدد",
        "export_all": "تصدير كل الصور",
        "open_images_manager": "الصور",
        "no_images_yet": "لا توجد صور بعد",
        "exam_bonus_hint": "إضافة التشخيص 100 قبل الخصم.",
        "method_cash": "نقدًا",
        "method_card": "بطاقة",
        "method_transfer": "تحويل",
        "method_other": "أخرى",
        "appointments": "المواعيد",
        "appointments_today": "مواعيد اليوم",
        "appointments_new": "موعد جديد",
        "appointments_filters": "عوامل التصفية",
        "appointments_day_label": "اليوم",
        "appointments_doctor_label": "الطبيب",
        "appointments_doctor_all": "جميع الأطباء",
        "appointments_slot_label": "وقت البدء",
        "appointments_duration_label": "المدة (بالدقائق)",
        "appointments_notes_label": "ملاحظات الزيارة",
        "appointments_patient_lookup": "المريض (رقم الملف أو الاسم)",
        "appointments_patient_name": "اسم المريض (اختياري)",
        "appointments_patient_phone": "رقم الهاتف (اختياري)",
        "appointments_title_label": "عنوان الزيارة",
        "appointments_submit": "حفظ الموعد",
        "appointments_empty_hour": "لا توجد مواعيد في هذه الساعة.",
        "appointments_range_label": "النطاق الزمني",
        "appointments_range_today": "اليوم فقط",
        "appointments_range_next3": "الأيام الثلاثة القادمة",
        "appointments_range_next7": "الأيام السبعة القادمة",
        "appointments_range_all": "كل المواعيد القادمة",
        "appointments_show_label": "عرض",
        "appointments_show_upcoming": "المواعيد القادمة",
        "appointments_show_past": "المواعيد السابقة",
        "appointments_show_all": "جميع المواعيد",
        "appointments_search_label": "بحث",
        "appointments_total_label": "إجمالي المواعيد",
        "appointments_search_placeholder": "ابحث بالاسم أو الهاتف أو رقم الملف",
        "appointments_no_notes": "لا توجد ملاحظات",
        "appointment_conflict": "يوجد موعد آخر في هذا الوقت.",
        "appointment_status_scheduled": "مجدول",
        "appointment_status_checked_in": "تم الوصول",
        "appointment_status_in_progress": "قيد التقديم",
        "appointment_status_done": "منتهي",
        "appointment_status_no_show": "لم يحضر",
        "appointment_status_cancelled": "ملغى",
        "appointments_more_chip": "+{count} مواعيد إضافية",
        "receipts": "الإيصالات",
        "receipts_new": "إصدار إيصال",
        "receipts_recent": "آخر الإيصالات",
        "receipts_patient_placeholder": "رقم الملف أو الاسم",
        "receipts_description_placeholder": "الوصف الظاهر في الإيصال",
        "receipts_amount": "المبلغ",
        "receipts_locale": "اللغة",
        "receipts_pdf": "تحميل PDF",
        "receipts_reprint": "إعادة الطباعة",
        "receipts_success": "تم إصدار الإيصال",
        "receipts_reprint_done": "تم تسجيل إعادة الطباعة",
        "receipt_heading": "إيصال العيادة",
        "receipt_number_label": "رقم الإيصال",
        "receipt_date_label": "التاريخ",
        "receipt_patient_label": "المريض",
        "receipt_phone_label": "الهاتف",
        "receipt_description_label": "الوصف",
        "receipt_amount_label": "المبلغ",
        "receipt_qr_hint": "رمز الاستجابة",
        "receipt_default_desc": "خدمات الأسنان",
        "appointments_table_missing": "يرجى تشغيل `flask db upgrade` لتفعيل جدول المواعيد.",
        "receipts_table_missing": "يرجى تشغيل `flask db upgrade` لتفعيل الإيصالات.",
        "amount_required": "يرجى إدخال مبلغ صالح",
        "patient_not_found": "المريض غير موجود",
        "receipt_not_found": "الإيصال غير موجود",
        "title_required": "العنوان مطلوب",
        "invalid_status": "حالة غير صحيحة",
        "invalid_datetime": "تاريخ أو وقت غير صحيح",
        "roles_manage_title": "الأدوار والصلاحيات",
        "roles_new_button": "دور جديد",
        "roles_edit_heading": "تعديل الدور",
        "role_form_name": "اسم الدور",
        "role_form_description": "الوصف",
        "role_form_permissions": "الصلاحيات",
        "role_permissions_hint": "اختر الصلاحيات المسموح بها لهذا الدور.",
        "role_created": "تم إنشاء الدور",
        "role_updated": "تم تحديث الدور",
        "role_exists": "اسم الدور موجود بالفعل.",
        "role_name_required": "يجب أن يحتوي اسم الدور على حرفين على الأقل.",
        "role_not_found": "لم يتم العثور على الدور",
        # Print Receipt Features
        "print_receipt": "طباعة الإيصال",
        "print_receipt_title": "طباعة إيصال الدفع",
        "receipt_format": "تنسيق الإيصال",
        "format_full": "كامل",
        "format_summary": "ملخص",
        "format_treatment": "علاج",
        "format_payment": "دفع فقط",
        "preview_receipt": "معاينة الإيصال",
        "print_confirmation": "هل تريد طباعة الإيصال؟",
        "receipt_generation_error": "خطأ في إنشاء الإيصال: {error}",
        "receipt_downloaded": "تم تحميل الإيصال بنجاح",
        "print_loading": "جاري إنشاء الإيصال...",
        "print_success": "تم طباعة الإيصال بنجاح",
        "print_error": "فشل في إنشاء الإيصال. حاول مرة أخرى.",
        "include_qr": "تضمين رمز الاستجابة",
        "include_notes": "تضمين ملاحظات العلاج",
        "include_treatment": "تضمين تفاصيل العلاج",
        "add_watermark": "إضافة علامة مائية للنسخة",
        "download_pdf": "تحميل PDF",
        # PDF specific keys
        "patient_name": "اسم المريض",
        "file_no": "رقم الملف",
        "payment_date": "تاريخ الدفع",
        "payment_method": "طريقة الدفع",
        "total_amount": "إجمالي المبلغ",
        "discount": "الخصم",
        "paid_amount": "المبلغ المدفوع",
        "remaining_balance": "الرصيد المتبقي",
        "treatment": "العلاج",
        "patient": "المريض",
        "date": "التاريخ",
        "amount_paid": "المبلغ المدفوع",
        "method": "الطريقة",
        "treatment_date": "تاريخ العلاج",
        "total_cost": "التكلفة الإجمالية",
        "amount": "المبلغ",
        "reference": "المرجع",
        "paid": "مدفوع",
        "receipt_id_label": "رقم الإيصال: {receipt_id}",
        "generated_label": "تاريخ الطباعة: {current_time}",
        "thank_you_message": "شكرا لاختيار عيادتنا!",
        # Copy watermark feature
        "copy_watermark": "نسخة العيادة",
        "copy_watermark_description": "يميز الإيصالات كنسخ داخلية للاستخدام في العيادة",
    },
}


def _normalize_locale(value: str | None) -> str | None:
    if not value:
        return None
    value = value.lower()
    return value if value in SUPPORTED_LOCALES else None


def resolve_locale(req=None, app=None) -> str:
    try:
        app = app or current_app  # type: ignore[assignment]
    except RuntimeError:
        app = None

    cookie_name = "lang"
    config_default = None
    if app is not None:
        cookie_name = app.config.get("LOCALE_COOKIE_NAME", cookie_name)
        config_default = _normalize_locale(app.config.get("DEFAULT_LOCALE"))

    if req is None and has_request_context():
        req = request

    if req is not None:
        cookie_lang = _normalize_locale(req.cookies.get(cookie_name))
        if cookie_lang:
            return cookie_lang
        query_lang = _normalize_locale(req.args.get("lang"))
        if query_lang:
            return query_lang

    if config_default:
        return config_default
    return FALLBACK_LOCALE


def get_lang() -> str:
    return resolve_locale()


def T(key: str, **fmt) -> str:
    lang = get_lang()
    text = I18N.get(lang, I18N["en"]).get(key, key)
    return text.format(**fmt) if fmt else text


def dir_attr(lang: str | None = None) -> str:
    if lang is None:
        lang = get_lang()
    return "rtl" if lang == "ar" else "ltr"


def translate_text(locale: str, key: str, **fmt) -> str:
    lang = locale if locale in SUPPORTED_LOCALES else FALLBACK_LOCALE
    text = I18N.get(lang, I18N["en"]).get(key, key)
    return text.format(**fmt) if fmt else text


def register_jinja(app) -> None:
    app.jinja_env.globals.setdefault("T", T)
    app.jinja_env.globals.setdefault("t", T)
    app.jinja_env.globals.setdefault("dir_attr", dir_attr)
