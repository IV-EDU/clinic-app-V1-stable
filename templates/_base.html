<!doctype html>
<html lang="{{ lang }}" dir="{{ dir }}">
<head>
  {% block head %}
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <title>{{ t('app_title') }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/design-system.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme-system.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/print-receipts.css') }}">
  <script>
    // Restore theme preference immediately (before page render) to prevent flash
    (function() {
      var savedTheme = localStorage.getItem('clinic-theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
    })();
  </script>
  <script src="{{ url_for('static', filename='js/patient-receipts.js') }}"></script>
  <script defer src="{{ url_for('static', filename='js/patient-form-repeaters.js') }}"></script>
  <script defer src="{{ url_for('static', filename='js/status-chip.js') }}"></script>
  <script defer src="{{ url_for('static', filename='js/modal-system.js') }}"></script>
  <script defer src="{{ url_for('static', filename='js/toast.js') }}"></script>
  {% if theme_css %}<style>{{ theme_css|safe }}</style>{% endif %}
  {% block extra_css %}{% endblock %}
  {% endblock %}

</head>
<body class="{{ 'rtl' if lang == 'ar' else '' }}">
  {% include '_nav.html' %}
  <div class="wrap">
    {% include '_flash.html' %}
    {% block content %}{% endblock %}
  </div>

  <!-- Theme Toggle Button (Fixed Position) -->
  <button id="theme-toggle"
          class="theme-toggle-btn"
          aria-label="Toggle dark mode"
          title="Toggle dark mode">
    <svg class="sun-icon" width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
    </svg>
    <svg class="moon-icon" width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
      <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
    </svg>
  </button>

  <script>
  // Theme toggle functionality
  (function() {
    var toggleBtn = document.getElementById('theme-toggle');
    if (!toggleBtn) return;

    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('clinic-theme', theme);
      updateToggleButton(theme);
    }

    function updateToggleButton(theme) {
      var sunIcon = toggleBtn.querySelector('.sun-icon');
      var moonIcon = toggleBtn.querySelector('.moon-icon');
      if (theme === 'dark') {
        if (sunIcon) sunIcon.style.display = 'block';
        if (moonIcon) moonIcon.style.display = 'none';
      } else {
        if (sunIcon) sunIcon.style.display = 'none';
        if (moonIcon) moonIcon.style.display = 'block';
      }
    }

    toggleBtn.addEventListener('click', function() {
      var currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      var newTheme = currentTheme === 'light' ? 'dark' : 'light';
      setTheme(newTheme);
    });

    // Initialize button state
    var savedTheme = localStorage.getItem('clinic-theme') || 'light';
    updateToggleButton(savedTheme);

    // Force light mode when printing â€” prevents dark backgrounds in print margins
    var _printThemeBackup = null;
    window.addEventListener('beforeprint', function() {
      _printThemeBackup = document.documentElement.getAttribute('data-theme');
      document.documentElement.setAttribute('data-theme', 'light');
    });
    window.addEventListener('afterprint', function() {
      if (_printThemeBackup) {
        document.documentElement.setAttribute('data-theme', _printThemeBackup);
      }
    });
  })();
  </script>
  <script>
  function toggleKebab(evt, btn){
    try{
      if(evt){ evt.preventDefault(); evt.stopPropagation(); }
      var k = btn.closest ? btn.closest('.kebab') : null;
      if(!k){ k = document.getElementById('kebab'); }
      if(!k) return;
      var menu = k.querySelector('.kebab-menu');
      if(!menu) return;
      document.querySelectorAll('.kebab.open').forEach(function(el){ if(el!==k) el.classList.remove('open'); });
      var isOpen = k.classList.contains('open');
      if(isOpen){ k.classList.remove('open'); return; }
      k.classList.add('open');
      menu.style.position = 'absolute';
      menu.style.left = ''; menu.style.right = ''; menu.style.top = '';
      var gap = 6;
      menu.style.top = (btn.offsetTop + btn.offsetHeight + gap) + 'px';
      var dirAttr = (document.documentElement.getAttribute('dir') || document.body.getAttribute('dir') || '').toLowerCase();
      if(dirAttr === 'rtl'){
        var right = (k.clientWidth - (btn.offsetLeft + btn.offsetWidth));
        menu.style.right = right + 'px';
        menu.style.left = 'auto';
      }else{
        menu.style.left = btn.offsetLeft + 'px';
        menu.style.right = 'auto';
      }
    }catch(e){
      if(window.console){ console.warn('toggleKebab error', e); }
    }
  }
  document.addEventListener('click', function(e){
    var open = document.querySelector('.kebab.open');
    if(!open) return;
    if(open.contains(e.target)) return;
    open.classList.remove('open');
  });
  (function(){
    window.__payToggle = function(id){
      var d = document.getElementById('details-'+id);
      var b = document.getElementById('view-'+id);
      if(!d||!b) return;
      var show = d.style.display!=='block';
      d.style.display = show ? 'block' : 'none';
      b.classList.toggle('active', show);
      b.textContent = show ? '{{ t("hide") }}' : '{{ t("view") }}';
    };

    function autogrowTA(ta){ ta.style.height='auto'; ta.style.height=ta.scrollHeight+'px'; }

    window.initializePaymentForm = function(scope){
      var root = scope || document;
      var total = root.querySelector('#total_amount');
      var vt = root.querySelector('#visit_type');
      var eff = root.querySelector('#total_amount_effective');
      var down = root.querySelector('input[name="down_payment"]');
      var disc = root.querySelector('input[name="discount"]');
      var rem  = root.querySelector('#remaining_amount');
      function parseMoney(v){ try { return parseFloat((v||'').replace(/,/g,'')) || 0; } catch(e){ return 0; } }
      function fmt2(n){ return (Math.round(n*100)/100).toFixed(2); }
      function update(){
        if(!total || !rem) return;
        var base = parseMoney(total.value);
        var totalEff = base;
        if(eff) eff.value = fmt2(totalEff);
        var discount = parseMoney(disc ? disc.value : '0');
        if(discount < 0) discount = 0;
        if(discount > totalEff) discount = totalEff;
        var due = totalEff - discount;
        var paid = parseMoney(down ? down.value : '0');
        var remaining = due - paid;
        if(remaining < 0) remaining = 0;
        rem.value = fmt2(remaining);
      }
      ['input','change'].forEach(function(evt){
        if(total && !total.__payBound){ total.addEventListener(evt, update); }
        if(vt && !vt.__payBound){ vt.addEventListener(evt, update); }
        if(down && !down.__payBound){ down.addEventListener(evt, update); }
        if(disc && !disc.__payBound){ disc.addEventListener(evt, update); }
      });
      if(total) total.__payBound = true;
      if(vt) vt.__payBound = true;
      if(down) down.__payBound = true;
      if(disc) disc.__payBound = true;
      update();
    };

    document.addEventListener('DOMContentLoaded', function(){
      document.querySelectorAll('textarea').forEach(function(ta){
        autogrowTA(ta); ta.addEventListener('input', function(){ autogrowTA(ta); });
      });
      if(window.initializePaymentForm){
        window.initializePaymentForm(document);
      }
    });
  })();
  </script>
  {% block extra_js %}{% endblock %}
</body>
</html>
