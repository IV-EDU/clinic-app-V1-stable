{% extends '_base.html' %}
{% block content %}
<style>
{# Override theme variables on this page using saved settings, since this view does not go through render_page() #}
{% set _primary = theme_settings.get('primary_color') if theme_settings else None %}
{% set _accent = theme_settings.get('accent_color') if theme_settings else None %}
{% set _text = theme_settings.get('text_color') if theme_settings else None %}
{% set _btn_text = theme_settings.get('btn_text_color') if theme_settings else None %}
{% set _metric = theme_settings.get('metric_text_color') if theme_settings else None %}
:root {
  {% if _primary %}--primary-color: {{ _primary }};{% endif %}
  {% if _accent %}--accent-color: {{ _accent }};{% endif %}
  {% if _text %}--ink: {{ _text }}; --text-primary: {{ _text }};{% endif %}
  {% if _btn_text %}--btn-text-on-primary: {{ _btn_text }};{% endif %}
  {% if _metric %}--metric-color: {{ _metric }};{% endif %}
}
{# In dark mode, reset light-mode text overrides so design-system dark tokens win #}
{% if _text or _metric %}
[data-theme="dark"] {
  {% if _text %}--ink: var(--color-text-primary); --text-primary: var(--color-text-primary);{% endif %}
  {% if _metric %}--metric-color: var(--primary-color, var(--color-accent));{% endif %}
}
{% endif %}

/* Admin Settings Styles */
.admin-settings-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem;
}

.admin-settings-header {
  background: linear-gradient(
    90deg,
    color-mix(in srgb, var(--primary-color, #3b82f6) 20%, #eff6ff) 0%,
    #fdfdfd 52%,
    color-mix(in srgb, var(--primary-color, #3b82f6) 20%, #eff6ff) 100%
  );
  color: var(--text-primary, var(--ink, #1f2937));
  padding: 2rem;
  border-radius: 12px;
  margin-bottom: 2rem;
  text-align: center;
}

.admin-settings-header h1 {
  margin: 0;
  font-size: 2.5rem;
  font-weight: 700;
}

.admin-settings-header p {
  margin: 0.5rem 0 0 0;
  opacity: 0.85;
  font-size: 1.1rem;
  color: var(--text-secondary, #475569);
}

/* Tab Navigation */
.admin-tabs {
  display: flex;
  background: white;
  border-radius: 12px 12px 0 0;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  overflow: hidden;
  margin-bottom: 0;
}

.admin-tab {
  flex: 1;
  padding: 1rem 1.5rem;
  text-align: center;
  background: #f8fafc;
  border: none;
  border-bottom: 3px solid transparent;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 600;
  color: #64748b;
  text-decoration: none;
  display: block;
}

.admin-tab:hover {
  background: #e2e8f0;
  color: #334155;
}

.admin-tab.active {
  background: white;
  color: #1e293b;
  border-bottom-color: var(--primary-color, #3b82f6);
}

/* Tab Content */
.admin-tab-content {
  background: white;
  border-radius: 0 0 12px 12px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  padding: 2rem;
  min-height: 600px;
}

.admin-tab-pane {
  display: none;
}

.admin-tab-pane.active {
  display: block;
}

/* Common Styles */
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  margin-bottom: 1rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid #e5e7eb;
}

.card-title {
  margin: 0;
  font-size: 1.25rem;
  font-weight: 600;
  color: #1f2937;
}

.btn-sm {
  padding: 0.35rem 0.75rem;
  font-size: 0.8rem;
}

.actions-row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  align-items: center;
}

.status-badge-row {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

/* Table Styles */
.admin-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 8px;
  margin-top: 1rem;
}

.admin-table th,
.admin-table td {
  padding: 0.75rem 0.9rem;
  text-align: start;
  vertical-align: middle;
}

.admin-table th {
  background: #f9fafb;
  font-weight: 600;
  color: #374151;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
}

.admin-table tbody td {
  background: #ffffff;
  border: 1px solid var(--border, #e5e7eb);
  font-size: 0.9rem;
}

.admin-table tbody td:first-child {
  border-radius: 999px 0 0 999px;
}

.admin-table tbody td:last-child {
  border-radius: 0 999px 999px 0;
}

.admin-table th:last-child,
.admin-table td:last-child {
  text-align: center;
}

.table-actions {
  white-space: nowrap;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
}

.admin-table tbody tr:hover td {
  background: #f9fafb;
}

.admin-table tr.protected td {
  background: #fffbeb;
  border-color: #facc15;
}

.admin-table tr.protected:hover td {
  background: #fef3c7;
}

/* Status Badges */
.status-badge {
  display: inline-flex;
  align-items: center;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 600;
}

.status-badge.active {
  background: #d1fae5;
  color: #065f46;
}

.status-badge.inactive {
  background: #fee2e2;
  color: #991b1b;
}

.status-badge.admin {
  background: #fef3c7;
  color: #92400e;
}

.status-badge.permission {
  background: #dbeafe;
  color: #1e3a8a;
}

.status-badge.more {
  background: #e5e7eb;
  color: #374151;
}

.permission-badge-group {
  display: flex;
  flex-wrap: wrap;
  gap: 0.25rem;
  max-width: 420px;
}

/* Duplicates (DB + after-import) */
.dup-group-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 10px;
  margin-top: 0.65rem;
}
.dup-cand-card {
  border: 1px solid var(--border, #e5e7eb);
  border-radius: 12px;
  padding: 0.75rem;
  background: rgba(255, 255, 255, 0.75);
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.dup-cand-top {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 10px;
}
.dup-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.dup-chip {
  display: inline-flex;
  align-items: center;
  padding: 0.18rem 0.5rem;
  border-radius: 999px;
  font-size: 0.78rem;
  border: 1px solid var(--border, #e5e7eb);
  background: #f8fafc;
  color: #0f172a;
}
.dup-chip.warn {
  background: #fff7ed;
  border-color: #fed7aa;
  color: #9a3412;
}
.dup-chip.info {
  background: #eff6ff;
  border-color: #bfdbfe;
  color: #1e3a8a;
}

/* Admin > Data tab: Simple/Advanced + sub-tabs */
#data-tab[data-data-mode="simple"] .data-advanced {
  display: none !important;
}
#data-tab[data-data-mode="advanced"] .data-simple-only {
  display: none !important;
}
.data-subtab-btn-active {
  background: color-mix(in srgb, var(--primary-color, #3b82f6) 10%, #ffffff) !important;
  border-color: color-mix(in srgb, var(--primary-color, #3b82f6) 30%, var(--border, #e5e7eb)) !important;
  color: var(--text-primary, var(--ink, #1f2937)) !important;
}
.data-step {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 0.85rem;
  color: var(--text-secondary, #475569);
}
.data-step .badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 64px;
  padding: 2px 8px;
  border-radius: 999px;
  background: rgba(255,255,255,0.7);
  border: 1px solid var(--border, #e5e7eb);
  color: var(--text-secondary, #475569);
  font-weight: 600;
}
.data-scroll-area {
  max-height: 55vh;
  overflow: auto;
  border: 1px solid var(--border, #e5e7eb);
  border-radius: 12px;
  background: rgba(255,255,255,0.85);
}

/* Doctor Colors Styles */
.color-preview {
  width: 30px;
  height: 30px;
  border-radius: 4px;
  border: 1px solid #d1d5db;
}

.color-input {
  width: 60px;
  height: 40px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  cursor: pointer;
}

.color-input::-webkit-color-swatch-wrapper {
  padding: 0;
}

.color-input::-webkit-color-swatch {
  border: none;
  border-radius: 4px;
}

.color-row {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  flex-wrap: nowrap;
}

.color-row .form-input {
  flex: 0 0 auto;
}

.color-row .color-preview {
  flex: 0 0 auto;
}

/* Modal Styles */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}

.modal-wide .modal-content {
  max-width: 980px;
}

.table-compact {
  width: 100%;
  border-collapse: collapse;
}

.table-compact th,
.table-compact td {
  padding: 0.6rem 0.75rem;
  border-bottom: 1px solid var(--border, #e5e7eb);
  text-align: start;
  vertical-align: top;
  font-size: 0.9rem;
}

.table-compact th {
  background: #f9fafb;
  font-weight: 700;
}

/* Audit pre block (used in JS-generated content) */
.audit-pre {
  margin-top: 8px;
  white-space: pre-wrap;
  background: #f9fafb;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #e5e7eb;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: white;
  border-radius: 12px;
  width: 90%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
}

.modal-header {
  padding: 1.5rem;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title {
  margin: 0;
  font-size: 1.25rem;
  font-weight: 600;
  color: #1f2937;
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: #6b7280;
  cursor: pointer;
  padding: 0.25rem;
  border-radius: 4px;
  transition: all 0.2s ease;
}

.modal-close:hover {
  background: #f3f4f6;
  color: #374151;
}

.modal-body {
  padding: 1.5rem;
}

.modal-footer {
  padding: 1.5rem;
  border-top: 1px solid #e5e7eb;
  display: flex;
  justify-content: flex-end;
  gap: 0.75rem;
}

/* Form Styles */
.admin-form {
  display: grid;
  gap: 1rem;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.form-label {
  font-size: 0.875rem;
  font-weight: 600;
  color: #374151;
}

.form-input,
.form-select {
  padding: 0.5rem;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 0.875rem;
  transition: border-color 0.2s ease;
}

.form-input:focus,
.form-select:focus {
  outline: none;
  border-color: var(--primary-color, #3b82f6);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-checkbox-group {
  display: grid;
  gap: 0.5rem;
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  padding: 0.75rem;
}

.checkbox-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.checkbox-item input[type="checkbox"] {
  width: 16px;
  height: 16px;
}

.checkbox-group-title {
  font-weight: 600;
  color: #374151;
  margin-bottom: 0.5rem;
  padding-bottom: 0.25rem;
  border-bottom: 1px solid #e5e7eb;
}

.logo-upload-row {
  display: flex;
  flex-direction: column;
  gap: 12px;
  align-items: flex-start;
}

.logo-preview {
  width: 180px;
  height: 180px;
  border: 1px dashed #cbd5e1;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #f9fafb;
  overflow: hidden;
  color: #6b7280;
  font-weight: 600;
  text-align: center;
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
}

.logo-preview img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  display: block;
}

.logo-placeholder {
  color: #6b7280;
  font-size: 0.9rem;
  text-align: center;
  padding: 0.5rem;
}

.logo-controls {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

[dir="rtl"] .logo-upload-row,
[dir="rtl"] .logo-controls {
  align-items: stretch;
}

[dir="rtl"] .logo-preview,
[dir="rtl"] .logo-controls .actions-row {
  align-self: center;
}

/* Permission Groups */
.permission-groups {
  display: grid;
  gap: 1rem;
}

.permission-group {
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 1rem;
}

.permission-group-title {
  font-weight: 600;
  color: #374151;
  margin-bottom: 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.permission-list {
  display: grid;
  gap: 0.5rem;
}

/* Alert Styles */
.alert {
  padding: 0.75rem;
  border-radius: 6px;
  margin-bottom: 1rem;
  font-size: 0.875rem;
}

.alert-error {
  background: #fef2f2;
  color: #991b1b;
  border: 1px solid #fecaca;
}

.alert-success {
  background: #f0fdf4;
  color: #166534;
  border: 1px solid #bbf7d0;
}

/* Loading States */
.loading {
  opacity: 0.6;
  pointer-events: none;
  position: relative;
}

.loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 20px;
  height: 20px;
  margin: -10px 0 0 -10px;
  border: 2px solid var(--primary-color, #3b82f6);
  border-radius: 50%;
  border-top-color: transparent;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 768px) {
  .admin-settings-container {
    padding: 1rem;
  }

  .admin-settings-header {
    padding: 1.5rem;
  }

  .admin-settings-header h1 {
    font-size: 2rem;
  }

  .admin-tabs {
    flex-direction: column;
  }

  .admin-tab {
    border-bottom: 1px solid #e2e8f0;
    border-right: none;
  }

  .admin-tab.active {
    border-bottom-color: #3b82f6;
    border-right: none;
  }

  .admin-tab-content {
    padding: 1rem;
  }

  .admin-table {
    font-size: 0.875rem;
  }

  .admin-table th,
  .admin-table td {
    padding: 0.5rem;
  }

  .modal-content {
    width: 95%;
    margin: 1rem;
  }

  .modal-footer {
    flex-direction: column;
  }

.modal-footer .btn {
  width: 100%;
  }
}

/* RTL tweaks */
[dir="rtl"] .admin-tabs { flex-direction: row-reverse; }
[dir="rtl"] .admin-tab { text-align: center; }
[dir="rtl"] .card-header, [dir="rtl"] .actions-row { flex-direction: row-reverse; }
[dir="rtl"] .admin-table thead th { text-align: center; }
[dir="rtl"] .admin-table tbody td:first-child { border-radius: 0 999px 999px 0; }
[dir="rtl"] .admin-table tbody td:last-child { border-radius: 999px 0 0 999px; }
[dir="rtl"] .permission-badge-group { direction: ltr; justify-content: flex-start; max-width: none; width: 100%; }
[dir="rtl"] .status-badge.permission,
[dir="rtl"] .status-badge.more { direction: ltr; unicode-bidi: plaintext; }
[dir="rtl"] .admin-table tbody td:last-child { text-align: center; }
[dir="rtl"] .admin-table tbody td:last-child .btn { direction: rtl; unicode-bidi: plaintext; }
[dir="rtl"] .table-actions { flex-direction: row-reverse; }
[dir="rtl"] .dup-chips { justify-content: flex-start; }
[dir="rtl"] .admin-tab-content { text-align: start; }
[dir="rtl"] .admin-settings-header { text-align: center; }

/* ========================================================================
   DARK MODE OVERRIDES
   ======================================================================== */

/* --- Header gradient --- */
[data-theme="dark"] .admin-settings-header {
  background: linear-gradient(
    90deg,
    color-mix(in srgb, var(--primary-color, #60a5fa) 12%, var(--color-surface-raised, #22252d)) 0%,
    var(--color-surface, #1a1d23) 52%,
    color-mix(in srgb, var(--primary-color, #60a5fa) 12%, var(--color-surface-raised, #22252d)) 100%
  ) !important;
  color: var(--color-text-primary, #f1f5f9) !important;
}
[data-theme="dark"] .admin-settings-header h1 {
  color: var(--color-text-primary, #f1f5f9) !important;
}
[data-theme="dark"] .admin-settings-header p {
  color: var(--color-text-secondary, #cbd5e1) !important;
}

/* --- Tab navigation --- */
[data-theme="dark"] .admin-tabs {
  background: var(--color-surface, #1a1d23) !important;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3) !important;
}
[data-theme="dark"] .admin-tab {
  background: var(--color-surface-sunken, #14171c) !important;
  color: var(--color-text-tertiary, #94a3b8) !important;
  border-bottom-color: transparent !important;
}
[data-theme="dark"] .admin-tab:hover {
  background: var(--color-surface-raised, #22252d) !important;
  color: var(--color-text-primary, #f1f5f9) !important;
}
[data-theme="dark"] .admin-tab.active {
  background: var(--color-surface-raised, #22252d) !important;
  color: var(--color-accent, #60a5fa) !important;
  border-bottom-color: var(--color-accent, #60a5fa) !important;
}
@media (max-width: 768px) {
  [data-theme="dark"] .admin-tab {
    border-bottom-color: var(--color-border, #374151) !important;
  }
}

/* --- Tab content panels --- */
[data-theme="dark"] .admin-tab-content {
  background: var(--color-surface, #1a1d23) !important;
  color: var(--color-text-primary, #f1f5f9) !important;
}

/* --- Cards inside admin --- */
[data-theme="dark"] .admin-card,
[data-theme="dark"] .card {
  background: var(--color-surface, #1a1d23) !important;
  border-color: var(--color-border, #374151) !important;
  color: var(--color-text-primary, #f1f5f9) !important;
}

/* --- Card headers --- */
[data-theme="dark"] .card-header {
  border-bottom-color: var(--color-border, #374151) !important;
}
[data-theme="dark"] .card-title {
  color: var(--color-text-primary, #f1f5f9) !important;
}

/* --- Modal --- */
[data-theme="dark"] .modal-content,
[data-theme="dark"] .modal {
  background: var(--color-surface-raised, #22252d) !important;
  border-color: var(--color-border, #374151) !important;
  color: var(--color-text-primary, #f1f5f9) !important;
}
[data-theme="dark"] .modal-header {
  border-bottom-color: var(--color-border, #374151) !important;
}
[data-theme="dark"] .modal-footer {
  border-top-color: var(--color-border, #374151) !important;
}

/* --- Status badges --- */
[data-theme="dark"] .status-badge {
  border-color: var(--color-border, #374151) !important;
}
[data-theme="dark"] .status-badge.permission {
  background: color-mix(in srgb, var(--color-accent, #60a5fa) 12%, var(--color-surface, #1a1d23)) !important;
  color: var(--color-accent, #60a5fa) !important;
  border-color: color-mix(in srgb, var(--color-accent, #60a5fa) 25%, transparent) !important;
}

/* --- Section descriptions --- */
[data-theme="dark"] .section-description,
[data-theme="dark"] .card p {
  color: var(--color-text-secondary, #cbd5e1) !important;
}

/* --- Forms & inputs --- */
[data-theme="dark"] .form-label {
  color: var(--color-text-primary, #f1f5f9) !important;
}
[data-theme="dark"] .form-input,
[data-theme="dark"] .form-select {
  background: var(--color-surface-overlay, #2a2d35) !important;
  border-color: var(--color-border-strong, #4b5563) !important;
  color: var(--color-text-primary, #f1f5f9) !important;
}
[data-theme="dark"] .form-checkbox-group {
  background: var(--color-surface, #1a1d23) !important;
  border-color: var(--color-border, #374151) !important;
}
[data-theme="dark"] .checkbox-group-title {
  color: var(--color-text-primary, #f1f5f9) !important;
  border-bottom-color: var(--color-border, #374151) !important;
}
[data-theme="dark"] .checkbox-item {
  color: var(--color-text-primary, #f1f5f9) !important;
}

/* --- Table compact (audit details) --- */
[data-theme="dark"] .table-compact th {
  background: var(--color-surface-overlay, #2a2d35) !important;
  color: var(--color-text-primary, #f1f5f9) !important;
}
[data-theme="dark"] .table-compact td {
  color: var(--color-text-primary, #f1f5f9) !important;
  border-bottom-color: var(--color-border, #374151) !important;
}
[data-theme="dark"] .table-compact th {
  border-bottom-color: var(--color-border, #374151) !important;
}

/* --- Audit pre/details blocks --- */
[data-theme="dark"] .audit-pre {
  background: var(--color-surface-overlay, #2a2d35) !important;
  border-color: var(--color-border, #374151) !important;
  color: var(--color-text-primary, #f1f5f9) !important;
}
[data-theme="dark"] details summary {
  color: var(--color-text-primary, #f1f5f9) !important;
}

/* --- Audit admin-table dark --- */
[data-theme="dark"] .admin-table thead th {
  background: var(--color-surface-overlay, #2a2d35) !important;
  color: var(--color-text-primary, #f1f5f9) !important;
  border-bottom-color: var(--color-border, #374151) !important;
}
[data-theme="dark"] .admin-table tbody td {
  color: var(--color-text-primary, #f1f5f9) !important;
}
[data-theme="dark"] .admin-table tbody tr:hover {
  background: var(--color-surface-overlay, #2a2d35) !important;
}

/* --- Alerts dark --- */
[data-theme="dark"] .alert-error {
  background: rgba(239, 68, 68, 0.15) !important;
  border-color: #991b1b !important;
  color: #f87171 !important;
}
[data-theme="dark"] .alert-success {
  background: rgba(34, 197, 94, 0.15) !important;
  border-color: #166534 !important;
  color: #4ade80 !important;
}

/* --- Modal overlay darker for better contrast --- */
[data-theme="dark"] .modal {
  background: rgba(0, 0, 0, 0.75) !important;
}
[data-theme="dark"] .modal-content {
  background: var(--color-surface-raised, #22252d) !important;
  border: 1px solid var(--color-border-strong, #4b5563) !important;
  box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5) !important;
}
[data-theme="dark"] .modal-title {
  color: var(--color-text-primary, #f1f5f9) !important;
}
[data-theme="dark"] .modal-close:hover {
  background: var(--color-surface-overlay, #2a2d35) !important;
  color: var(--color-text-primary, #f1f5f9) !important;
}

/* --- Logo preview dark --- */
[data-theme="dark"] .logo-preview {
  background: var(--color-surface, #1a1d23) !important;
  border-color: var(--color-border, #374151) !important;
  color: var(--color-text-tertiary, #94a3b8) !important;
}

/* --- u-text-muted dark --- */
[data-theme="dark"] .u-text-muted {
  color: var(--color-text-tertiary, #94a3b8) !important;
}
</style>

{% macro tf(key, default_text) -%}
  {%- set val = t(key) if t else default_text -%}
  {{ default_text if val == key else val }}
{%- endmacro %}

<div class="admin-settings-container">
  <!-- Header -->
  <div class="admin-settings-header">
    <h1>{{ tf('admin_settings', 'Admin Settings') }}</h1>
    <p>{{ tf('admin_settings_intro', 'Manage users, roles, permissions, and doctors you add') }}</p>
  </div>

  <!-- Tab Navigation -->
    <div class="admin-tabs">
      <button class="admin-tab active" onclick="switchTab(event, 'users')">
        üë• {{ tf('manage_users', 'Manage Users') }}
      </button>
      <button class="admin-tab" onclick="switchTab(event, 'roles')">
      üõ°Ô∏è {{ tf('roles_permissions', 'Roles & Permissions') }}
    </button>
    <button class="admin-tab" onclick="switchTab(event, 'colors')">
      ü©∫ {{ tf('doctors', 'Doctors') }}
      </button>
      <button class="admin-tab" onclick="switchTab(event, 'patients')">
        üë§ {{ tf('patients_tab', 'Patients') }}
      </button>
      <button class="admin-tab" onclick="switchTab(event, 'theme')">
        üé® {{ tf('theme', 'Theme') }}
      </button>
      <button class="admin-tab" onclick="switchTab(event, 'data')">
        üì¶ {{ tf('data_tab_title', 'Data') }}
      </button>
      <button class="admin-tab" onclick="switchTab(event, 'audit')">
        üßæ {{ tf('audit_tab_title', 'Audit') }}
      </button>
    </div>

  <!-- Tab Content -->
  <div class="admin-tab-content">
    <!-- Users Tab -->
    <div id="users-tab" class="admin-tab-pane active">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">{{ tf('users', 'Users') }}</h2>
          <button class="btn btn-primary" onclick="openUserModal()">
            + {{ tf('new_user', 'New User') }}
          </button>
        </div>

        <div style="overflow-x: auto;">
          <table class="admin-table">
            <thead>
              <tr>
                <th scope="col">{{ tf('username', 'Username') }}</th>
                <th scope="col">{{ tf('name', 'Name') }}</th>
                <th scope="col">{{ tf('phone', 'Phone') }}</th>
                <th scope="col">{{ tf('roles', 'Roles') }}</th>
                <th scope="col">{{ tf('status', 'Status') }}</th>
                <th scope="col">{{ tf('actions', 'Actions') }}</th>
              </tr>
            </thead>
            <tbody id="users-table-body">
              {% for user in users %}
              <tr class="{% if user.username == 'admin' or user.id.startswith('admin-') %}protected{% endif %}" data-user-id="{{ user.id }}">
                <td>{{ user.username }}</td>
                <td>{{ user.full_name or '‚Äî' }}</td>
                <td>{{ user.phone or '‚Äî' }}</td>
                <td>
                  {% if user.roles %}
                    <div class="status-badge-row">
                      {% for role in user.roles %}
                    <span class="status-badge {% if role.name == 'Admin' %}admin{% endif %}">{{ role.name }}</span>
                  {% endfor %}
                </div>
              {% elif user.primary_role_name %}
                    <span class="status-badge">{{ user.primary_role_name }}</span>
              {% else %}
                ‚Äî
              {% endif %}
                </td>
                <td>
                  <span class="status-badge {% if user.is_active %}active{% else %}inactive{% endif %}">
                    {{ tf('active', 'Active') if user.is_active else tf('disabled', 'Disabled') }}
                  </span>
                </td>
                <td class="table-actions">
                  <button class="btn btn-secondary btn-sm" onclick="editUser('{{ user.id }}')">{{ tf('edit', 'Edit') }}</button>
                  <button class="btn btn-danger btn-sm" onclick="deleteUser('{{ user.id }}', '{{ user.username }}')">{{ tf('delete', 'Delete') }}</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Roles Tab -->
    <div id="roles-tab" class="admin-tab-pane">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">{{ tf('roles_permissions', 'Roles & Permissions') }}</h2>
          <button class="btn btn-primary" onclick="openRoleModal()">
            + {{ tf('new_role', 'New Role') }}
          </button>
        </div>

        <div style="overflow-x: auto;">
          <table class="admin-table">
            <thead>
              <tr>
                <th scope="col">{{ tf('role', 'Role') }}</th>
                <th scope="col">{{ tf('description', 'Description') }}</th>
                <th scope="col">{{ tf('permissions', 'Permissions') }}</th>
                <th scope="col">{{ tf('actions', 'Actions') }}</th>
              </tr>
            </thead>
            <tbody id="roles-table-body">
              {% for role in roles %}
              <tr data-role-id="{{ role.id }}">
                <td>{{ role.name }}</td>
                <td>{{ role.description or '‚Äî' }}</td>
                <td>
                  {% set perms = role.permissions %}
                  {% if perms %}
                    <div class="permission-badge-group">
                      {% for perm in perms[:6] %}
                        <span class="status-badge permission" title="{{ perm.description or perm.code }}">{{ perm.code }}</span>
                      {% endfor %}
                      {% if perms|length > 6 %}
                        <span class="status-badge more">+{{ perms|length - 6 }} {{ tf('more', 'more') }}</span>
                      {% endif %}
                    </div>
                  {% else %}
                    <span class="status-badge inactive">{{ tf('no_permissions', 'No permissions') }}</span>
                  {% endif %}
                </td>
                <td class="table-actions">
                  <button class="btn btn-secondary btn-sm" onclick="editRole({{ role.id }})">{{ tf('edit', 'Edit') }}</button>
                  <button class="btn btn-danger btn-sm" onclick="deleteRole({{ role.id }}, '{{ role.name }}')">{{ tf('delete', 'Delete') }}</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Colors Tab -->
    <div id="colors-tab" class="admin-tab-pane">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">{{ tf('doctors', 'Doctors') }}</h2>
          <div class="actions-row">
            <button class="btn btn-primary" type="button" onclick="openDoctorModal()">{{ tf('add_doctor', 'Add Doctor') }}</button>
            <button class="btn btn-secondary" type="button" onclick="resetColors()">{{ tf('reset_to_defaults', 'Reset to Defaults') }}</button>
          </div>
        </div>

        <div id="doctor-status" class="alert" style="display:none;"></div>

        <div style="overflow-x: auto;">
          <table class="admin-table">
            <thead>
              <tr>
                <th scope="col">{{ tf('doctor', 'Doctor') }}</th>
                <th scope="col">{{ tf('current_color', 'Current Color') }}</th>
                <th scope="col">{{ tf('preview', 'Preview') }}</th>
                <th scope="col">{{ tf('actions', 'Actions') }}</th>
              </tr>
            </thead>
            <tbody id="colors-table-body">
              {% for doctor in doctors %}
              <tr data-doctor-id="{{ doctor.doctor_id }}" data-doctor-label="{{ doctor.doctor_label }}" data-doctor-color="{{ doctor.color }}" data-doctor-active="{{ doctor.is_active }}">
                <td>
                  <div class="doctor-name">{{ doctor.doctor_label }}</div>
                  <div class="u-text-muted doctor-id">{{ tf('doctor_id', 'Doctor ID') }}: {{ doctor.doctor_id }}</div>
                  {% if doctor.is_active == 0 %}
                    <div class="status-badge inactive">{{ tf('inactive', 'Inactive') }}</div>
                  {% endif %}
                </td>
                <td><code>{{ doctor.color|upper }}</code></td>
                <td>
                  <div class="color-preview" style="background-color: {{ doctor.color }};"></div>
                </td>
                <td class="table-actions">
                  <button class="btn btn-secondary btn-sm" type="button" onclick="openDoctorModal('{{ doctor.doctor_id }}')">{{ tf('edit', 'Edit') }}</button>
                  <button class="btn btn-danger btn-sm" type="button" onclick="deleteDoctor('{{ doctor.doctor_id }}', '{{ doctor.doctor_label }}')">{{ tf('delete', 'Delete') }}</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">{{ tf('deleted_doctors', 'Deleted Doctors') }}</h2>
        </div>
        <div id="deleted-status" class="alert" style="display:none;"></div>
        <div style="overflow-x:auto;">
          <table class="admin-table">
            <thead>
              <tr>
                <th scope="col">{{ tf('doctor', 'Doctor') }}</th>
                <th scope="col">{{ tf('last_color', 'Last Color') }}</th>
                <th scope="col">{{ tf('deleted_at', 'Deleted At') }}</th>
                <th scope="col">{{ tf('actions', 'Actions') }}</th>
              </tr>
            </thead>
            <tbody id="deleted-doctors-body">
              <tr><td colspan="4">{{ t('loading') }}</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Patients Tab -->
    <div id="patients-tab" class="admin-tab-pane">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">{{ tf('patient_settings', 'Patient Settings') }}</h2>
          <div class="actions-row">
            <button class="btn btn-primary" type="button" onclick="savePatientSettings()">{{ tf('save_settings', 'Save Settings') }}</button>
          </div>
        </div>

        <div id="patient-settings-status" class="alert" style="display:none;"></div>

        <div class="admin-form">
          <div class="form-group">
            <label class="form-label">
              <input type="checkbox" id="enable-file-numbers" {% if patient_settings.get('enable_file_numbers', False) %}checked{% endif %}>
              {{ tf('enable_file_numbers_simple', 'Show file & page numbers') }}
            </label>
            <small class="text-muted">
              {{ tf('enable_file_numbers_simple_hint', 'When enabled, file number and page number fields are shown on patient cards and forms. Turning this off hides the fields but does not delete any data.') }}
            </small>
          </div>
        </div>
      </div>
    </div>

    <!-- Theme Tab -->
    <div id="theme-tab" class="admin-tab-pane">
      <div class="theme-grid">
        <div class="card theme-card">
          <div class="card-header">
            <h2 class="card-title">{{ tf('colors', 'Colors') }}</h2>
          </div>
          <div class="admin-form">
            <div class="form-group">
              <label class="form-label" for="theme-primary">{{ tf('primary_color', 'Primary color') }}</label>
              <div class="color-row">
                <input type="color" id="theme-primary" class="form-input color-input" value="{{ theme_settings.get('primary_color', '#3b82f6') }}">
                <div id="theme-primary-preview" class="color-preview chip" style="background: {{ theme_settings.get('primary_color', '#3b82f6') }}"></div>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label" for="theme-accent">{{ tf('accent_color', 'Accent color') }}</label>
              <div class="color-row">
                <input type="color" id="theme-accent" class="form-input color-input" value="{{ theme_settings.get('accent_color', '#0ea5e9') }}">
                <div id="theme-accent-preview" class="color-preview chip" style="background: {{ theme_settings.get('accent_color', '#0ea5e9') }}"></div>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label" for="theme-font">{{ tf('base_font_size', 'Base font size (px)') }}</label>
              <input type="number" id="theme-font" class="form-input" min="14" max="18" step="1" value="{{ theme_settings.get('base_font_size', '16') }}">
              <small class="text-muted">{{ tf('font_clamp_hint', 'Clamped to 14‚Äì18px to protect layout.') }}</small>
            </div>
            <div class="form-group">
              <label class="form-label" for="theme-text-color">{{ tf('theme_text_color', 'Text color') }}</label>
              <div class="color-row">
                <input type="color" id="theme-text-color" class="form-input color-input" value="{{ theme_settings.get('text_color', '#111827') }}">
                <div id="theme-text-preview" class="color-preview chip" style="background: {{ theme_settings.get('text_color', '#111827') }}"></div>
              </div>
              <small class="text-muted">{{ tf('theme_text_color_hint', 'Used for main text and labels.') }}</small>
            </div>
            <div class="form-group">
              <label class="form-label" for="theme-btn-text-color">{{ tf('theme_btn_text_color', 'Button text color') }}</label>
              <div class="color-row">
                <input type="color" id="theme-btn-text-color" class="form-input color-input" value="{{ theme_settings.get('btn_text_color', '') or '#ffffff' }}">
                <div id="theme-btn-text-preview" class="color-preview chip" style="background: {{ theme_settings.get('btn_text_color', '') or '#ffffff' }}"></div>
              </div>
              <small class="text-muted">{{ tf('theme_btn_text_color_hint', 'Used for text on primary themed buttons and big numbers.') }}</small>
            </div>
            <div class="form-group">
              <label class="form-label" for="theme-metric-color">{{ tf('theme_metric_color', 'Highlight numbers color') }}</label>
              <div class="color-row">
                <input type="color" id="theme-metric-color" class="form-input color-input" value="{{ theme_settings.get('metric_text_color', '') or theme_settings.get('primary_color', '#2563eb') }}">
                <div id="theme-metric-preview" class="color-preview chip" style="background: {{ theme_settings.get('metric_text_color', '') or theme_settings.get('primary_color', '#2563eb') }}"></div>
              </div>
              <small class="text-muted">{{ tf('theme_metric_color_hint', 'Used for big numbers like patient count and totals.') }}</small>
            </div>
            <div class="form-group">
              <label class="form-label" for="theme-page-bg">{{ tf('theme_page_bg_tint', 'Page background tint') }}</label>
              <div class="color-row">
                <input type="color" id="theme-page-bg" class="form-input color-input" value="{{ theme_settings.get('page_bg_tint', '') or '#f7f7f8' }}">
                <div id="theme-page-bg-preview" class="color-preview chip" style="background: {{ theme_settings.get('page_bg_tint', '') or '#f7f7f8' }}"></div>
              </div>
              <small class="text-muted">{{ tf('theme_page_bg_tint_hint', 'Very light color mixed into the page background.') }}</small>
            </div>
            <div class="form-group">
              <label class="form-label" for="theme-card-bg">{{ tf('theme_card_bg_tint', 'Card accent tint') }}</label>
              <div class="color-row">
                <input type="color" id="theme-card-bg" class="form-input color-input" value="{{ theme_settings.get('card_bg_tint', '') or '#ffffff' }}">
                <div id="theme-card-bg-preview" class="color-preview chip" style="background: {{ theme_settings.get('card_bg_tint', '') or '#ffffff' }}"></div>
              </div>
              <small class="text-muted">{{ tf('theme_card_bg_tint_hint', 'Optional soft tint for special header cards. Regular cards stay mostly white.') }}</small>
            </div>
            <div class="theme-preview" id="theme-preview">
              <span class="status-badge" id="theme-chip">Aa</span>
              <div class="theme-preview-body">
                <div id="theme-preview-title" class="theme-preview-title">{{ tf('theme_preview_title', 'Theme Preview') }}</div>
                <div id="theme-preview-text" class="u-text-secondary">{{ tf('theme_preview_hint', 'Primary and accent applied here.') }}</div>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">{{ tf('theme_presets', 'Theme presets') }}</label>
              <div class="actions-row" style="gap:6px;flex-wrap:wrap;">
                <button type="button" class="btn secondary" onclick="applyThemePreset('calm')">{{ tf('theme_preset_calm', 'Calm blue') }}</button>
                <button type="button" class="btn secondary" onclick="applyThemePreset('warm')">{{ tf('theme_preset_warm', 'Warm gold') }}</button>
                <button type="button" class="btn secondary" onclick="applyThemePreset('mint')">{{ tf('theme_preset_mint', 'Soft mint') }}</button>
              </div>
            </div>
            <div id="theme-status-colors" class="alert" style="display:none;"></div>
            <div class="actions-row" style="margin-top:12px;">
              <button class="btn btn-secondary" type="button" onclick="resetThemeDefaults()">{{ tf('reset_theme_defaults', 'Reset to default') }}</button>
              <button class="btn btn-secondary" type="button" onclick="pickColorsFromLogo()">{{ tf('theme_pick_from_logo', 'Use colors from logo') }}</button>
              <button class="btn btn-primary" type="button" onclick="saveThemeColors()">{{ tf('save_theme', 'Save Theme') }}</button>
            </div>
          </div>
        </div>

        <div class="card theme-card">
          <div class="card-header">
            <h2 class="card-title">{{ tf('branding', 'Branding') }}</h2>
          </div>
          <div class="admin-form">
            <div class="form-group">
              <label class="form-label">
                <input type="checkbox" id="clinic-name-enabled" {% if clinic_name_enabled %}checked{% endif %}>
                {{ tf('show_clinic_name', 'Show clinic name next to logo') }}
              </label>
            </div>
            <div class="form-group">
              <label class="form-label" for="clinic-name">{{ tf('clinic_name_label', 'Clinic display name') }}</label>
              <input type="text" id="clinic-name" class="form-input" value="{{ clinic_name or '' }}" placeholder="{{ tf('clinic_name_placeholder', 'e.g., ISmile Dental Clinic') }}">
            </div>
            <div class="form-group">
              <label class="form-label">
                <input type="checkbox" id="clinic-tagline-enabled" {% if clinic_tagline_enabled %}checked{% endif %}>
                {{ tf('show_clinic_tagline', 'Show clinic tagline') }}
              </label>
            </div>
            <div class="form-group">
              <label class="form-label" for="clinic-tagline">{{ tf('clinic_tagline_label', 'Clinic tagline') }}</label>
              <input type="text" id="clinic-tagline" class="form-input" value="{{ clinic_tagline or '' }}" placeholder="{{ tf('clinic_tagline_placeholder', 'e.g., Dental Clinic') }}">
            </div>
            <div class="form-group">
              <label class="form-label" for="clinic-brand-color">{{ tf('clinic_brand_color', 'Clinic brand color') }}</label>
              <div class="color-row">
                <input type="color" id="clinic-brand-color" class="form-input color-input" value="{{ clinic_brand_color or theme_settings.get('primary_color', '#3b82f6') }}">
                <div id="clinic-brand-preview" class="color-preview chip" style="background: {{ clinic_brand_color or theme_settings.get('primary_color', '#3b82f6') }}"></div>
              </div>
              <small class="text-muted">{{ tf('clinic_brand_hint', 'Used for the clinic name text in the header.') }}</small>
            </div>
            <div class="form-group">
              <label class="form-label" for="logo-scale">{{ tf('logo_size', 'Logo size (%)') }}</label>
              <input type="range" id="logo-scale" name="logo-scale" min="60" max="140" step="2" value="{{ logo_scale or '100' }}" oninput="document.getElementById('logo-scale-display').textContent = this.value + '%'">
              <small class="text-muted">{{ tf('logo_size_hint', 'Adjust logo size; capped to fit the header.') }}</small>
              <div><strong id="logo-scale-display">{{ logo_scale or '100' }}%</strong></div>
            </div>
            <div id="theme-status-branding" class="alert" style="display:none;"></div>
            <div class="actions-row" style="margin-top:12px;">
              <button class="btn btn-secondary" type="button" onclick="pickBrandingFromLogo()">{{ tf('theme_pick_from_logo', 'Use colors from logo') }}</button>
              <button class="btn btn-primary" type="button" onclick="saveThemeBranding()">{{ tf('save_theme', 'Save Theme') }}</button>
            </div>
          </div>
        </div>

        <div class="card theme-card">
          <div class="card-header">
            <h2 class="card-title">{{ tf('clinic_logo', 'Clinic logo') }}</h2>
          </div>
          <div class="admin-form">
            <div class="logo-upload-row">
              <label class="form-label">{{ tf('current_logo', 'Current logo') }}</label>
              <div class="logo-preview" id="theme-logo-preview">
                {% if theme_logo_url %}
                  <img src="{{ theme_logo_url }}" alt="{{ tf('clinic_logo', 'Clinic logo') }}" />
                {% else %}
                  <div class="logo-placeholder">{{ tf('no_logo', 'No logo uploaded') }}</div>
                {% endif %}
              </div>
              <div class="logo-controls">
                <input type="file" id="theme-logo" accept="image/png,image/jpeg">
                <div class="actions-row" style="gap:6px;flex-wrap:wrap;">
                  <button type="button" class="btn btn-secondary" onclick="uploadLogo()">{{ tf('upload', 'Upload') }}</button>
                  <button type="button" class="btn btn-danger" onclick="resetLogo()">{{ tf('remove_logo', 'Remove logo') }}</button>
                </div>
              </div>
            </div>
            <small class="text-muted">{{ tf('logo_hint', 'PNG or JPG, max 2MB. Appears in the top bar.') }}</small>
            <div id="logo-status" class="alert" style="display:none;"></div>
            <div class="form-group" id="logo-history-wrapper" style="display: none;">
              <label class="form-label" for="logo-history">{{ tf('past_logos', 'Past logos') }}</label>
              <select id="logo-history" class="form-select"></select>
              <div class="actions-row" style="margin-top:8px;">
                <button type="button" class="btn btn-secondary" onclick="useSelectedLogo()">{{ tf('use_selected_logo', 'Use selected logo') }}</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card theme-card">
          <div class="card-header">
            <h2 class="card-title">{{ tf('pdf_branding', 'PDF branding') }}</h2>
          </div>
          <div class="admin-form">
            <div class="logo-upload-row">
              <label class="form-label">{{ tf('current_pdf_logo', 'Current PDF logo') }}</label>
              <div class="logo-preview" id="pdf-logo-preview">
                {% if pdf_logo_url %}
                  <img src="{{ pdf_logo_url }}" alt="{{ tf('clinic_logo', 'Clinic logo') }}">
                {% else %}
                  <div class="logo-placeholder">{{ tf('no_logo', 'No logo uploaded') }}</div>
                {% endif %}
              </div>
              <div class="logo-controls">
                <input type="file" id="pdf-logo" accept="image/png,image/jpeg">
                <div class="actions-row" style="gap:6px;flex-wrap:wrap;">
                  <button type="button" class="btn btn-secondary" onclick="uploadPdfLogo()">{{ tf('upload', 'Upload') }}</button>
                  <button type="button" class="btn btn-danger" onclick="resetPdfLogo()">{{ tf('remove_logo', 'Remove logo') }}</button>
                </div>
              </div>
            </div>
            <small class="text-muted">{{ tf('logo_hint', 'PNG or JPG, max 2MB. Appears on PDF receipts.') }}</small>
            <div id="pdf-logo-status" class="alert" style="display:none;"></div>
            <div class="form-group" id="pdf-logo-history-wrapper" style="display:none;">
              <label class="form-label" for="pdf-logo-history">{{ tf('past_logos', 'Past logos') }}</label>
              <select id="pdf-logo-history" class="form-select"></select>
              <div class="actions-row" style="margin-top:8px;">
                <button type="button" class="btn btn-secondary" onclick="useSelectedPdfLogo()">{{ tf('use_selected_logo', 'Use selected logo') }}</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Data Tab -->
    <div id="data-tab" class="admin-tab-pane">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">{{ tf('data_tab_title', 'Data') }}</h2>
        </div>
        <div class="admin-form">
          <div class="card" style="padding:0.75rem;border:1px solid var(--border, #e5e7eb);background:rgba(255,255,255,0.7);">
            <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;">
              <div class="actions-row" style="margin:0;gap:6px;">
                <button type="button" class="btn btn-secondary btn-sm" data-data-subtab-btn="import" onclick="switchDataSubtab('import')">
                  {{ tf('data_sub_import', 'Import') }}
                </button>
                <button type="button" class="btn btn-secondary btn-sm" data-data-subtab-btn="analyze" onclick="switchDataSubtab('analyze')">
                  {{ tf('data_sub_analyze', 'Analyze') }}
                </button>
                <button type="button" class="btn btn-secondary btn-sm" data-data-subtab-btn="duplicates" onclick="switchDataSubtab('duplicates')">
                  {{ tf('data_sub_duplicates', 'Duplicates') }}
                </button>
                <button type="button" class="btn btn-secondary btn-sm" data-data-subtab-btn="export" onclick="switchDataSubtab('export')">
                  {{ tf('data_sub_export', 'Export') }}
                </button>
                <button type="button" class="btn btn-secondary btn-sm data-advanced" data-data-subtab-btn="reports" onclick="switchDataSubtab('reports')">
                  {{ tf('data_sub_reports', 'Reports') }}
                </button>
                <button type="button" class="btn btn-secondary btn-sm data-advanced" data-data-subtab-btn="backups" onclick="switchDataSubtab('backups')">
                  {{ tf('data_sub_backups', 'Backups') }}
                </button>
              </div>

              <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                <div class="u-text-muted" style="font-size:0.9rem;">
                  {{ tf('data_tab_mode_hint', 'Use Advanced only when needed.') }}
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                  <span class="u-text-muted" style="font-size:0.9rem;">{{ tf('data_tab_simple', 'Simple') }}</span>
                  <label class="checkbox-item" style="margin:0;">
                    <input type="checkbox" id="data-advanced-toggle">
                    <span>{{ tf('data_tab_advanced', 'Advanced') }}</span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Selected file picker (the same input is moved between Import/Analyze via JS) -->
          <div class="card" id="data-file-card" style="margin-top:1rem;padding:0.75rem;border:1px solid var(--border, #e5e7eb);background:rgba(255,255,255,0.75);">
            <div class="card-header" style="margin-bottom:0.5rem;">
              <h3 class="card-title" style="font-size:1rem;margin:0;">
                {{ tf('data_file_title', 'Selected file') }}
              </h3>
            </div>
            <div class="form-group" style="margin-top:0;">
              <label class="form-label" for="data-import-file">
                {{ tf('data_import_file_label', 'Choose Excel or CSV file') }}
              </label>
              <input type="file"
                     id="data-import-file"
                     class="form-input"
                     accept=".xlsx,.xlsm,.csv">
              <small class="text-muted" id="data-selected-file-text">
                {{ tf('data_file_none', 'No file selected.') }}
              </small>
              <div class="actions-row" style="margin-top:0.5rem;">
                <a href="{{ url_for('admin_settings.download_import_template') }}" class="btn secondary">
                  {{ tf('data_import_download_template', 'Download CSV template') }}
                </a>
                <button type="button" class="btn btn-secondary" onclick="clearSelectedDataFile()">
                  {{ tf('data_file_clear', 'Clear') }}
                </button>
              </div>
            </div>
          </div>

          <div id="data-sub-import" class="data-subpane" style="margin-top:1rem;">
            <div id="data-file-slot-import"></div>
            <div class="data-step" style="margin-bottom:0.35rem;">
              <span class="badge">{{ tf('data_step_2', 'Step 2') }}</span>
              <span>{{ tf('data_sub_import', 'Import') }}</span>
            </div>
            <p>{{ tf('data_import_intro', 'Import clinic data from a file in a safe, two-step process.') }}</p>
            <p class="u-text-muted">
              {{ tf('data_import_first_stable_hint', 'Use the CSV template for best results. You can also upload your own Excel file if it matches the template columns.') }}
            </p>
            <p class="u-text-muted" style="margin-top:0.75rem;">
              {{ tf('data_import_preview_only_note', 'This step does not write anything to the database. After you review the preview we can enable a full import as a separate step.') }}
            </p>

            <div class="form-group" style="margin-top:1rem;">
              <div class="card" style="padding:0.75rem;border:1px dashed var(--border-color,#d9e1ee);background:rgba(255,255,255,0.7);">
                <div style="font-weight:600;margin-bottom:0.35rem;">{{ tf('data_import_commit_title', 'Import into clinic database') }}</div>
                <div class="u-text-muted" style="font-size:0.92rem;">
                  {{ tf('data_import_commit_help', 'This will add patients and payments to your real clinic database. A backup will be created automatically first.') }}
                </div>
                <div style="display:flex;gap:14px;flex-wrap:wrap;margin-top:0.6rem;" class="data-advanced">
	                  <label class="checkbox-item" style="margin:0;">
	                    <input type="checkbox" id="data-import-skip-duplicates" {% if patient_settings.get('import_skip_duplicates', True) %}checked{% endif %}>
	                    <span>{{ tf('data_import_skip_duplicates', 'Skip rows already imported (recommended)') }}</span>
	                  </label>
	                  <label class="checkbox-item" style="margin:0;">
	                    <input type="checkbox" id="data-import-import-zero" {% if patient_settings.get('import_import_zero_entries', True) %}checked{% endif %}>
	                    <span>{{ tf('data_import_import_zero_entries', 'Import zero-amount entries (history rows)') }}</span>
	                  </label>
                  <label class="checkbox-item" style="margin:0;">
                    <input type="checkbox" id="data-import-never-auto-merge" {% if patient_settings.get('import_never_auto_merge', True) %}checked{% endif %}>
                    <span>{{ tf('data_import_never_auto_merge', 'Never auto-merge patients (safer)') }}</span>
                  </label>
                </div>
                <small class="text-muted data-advanced" style="margin-top:0.35rem;">
                  {{ tf('data_import_never_auto_merge_hint', 'When enabled, the importer will only match existing patients by exact file number. Page number matching is disabled and potential duplicates should be reviewed in the duplicates panel.') }}
                </small>
                <div class="actions-row data-advanced" style="margin-top:0.5rem;">
                  <button type="button" class="btn btn-secondary" onclick="saveImportSettings()">
                    {{ tf('save_settings', 'Save Settings') }}
                  </button>
                </div>
                <div id="data-import-settings-status" class="alert" style="display:none;margin-top:0.5rem;"></div>
                <div class="actions-row" style="margin-top:0.75rem;">
                  <button type="button" class="btn btn-secondary data-advanced" onclick="preflightDataImport()">
                    {{ tf('data_import_preflight_btn', 'Check import (no changes)') }}
                  </button>
                  <button type="button" class="btn btn-danger" onclick="commitDataImport()">
                    {{ tf('data_import_commit_btn', 'Import to clinic (writes to database)') }}
                  </button>
                  <a id="data-import-report-link" class="btn secondary data-advanced" href="#" style="display:none;" target="_blank" rel="noopener">
                    {{ tf('data_import_download_report', 'Download import report') }}
                  </a>
                </div>
                <div id="data-import-commit-status" class="alert" style="display:none;margin-top:0.75rem;"></div>
              </div>
            </div>
          </div>

          <div id="data-sub-analyze" class="data-subpane" style="margin-top:1rem;display:none;">
            <div id="data-file-slot-analyze"></div>
            <div class="data-step" style="margin-bottom:0.35rem;">
              <span class="badge">{{ tf('data_step_1', 'Step 1') }}</span>
              <span>{{ tf('data_sub_analyze', 'Analyze') }}</span>
            </div>
            <p class="u-text-muted">
              {{ tf('data_import_preview_only_note', 'This step does not write anything to the database. After you review the preview we can enable a full import as a separate step.') }}
            </p>
            <div class="actions-row" style="margin-top:0.75rem;">
              <button type="button" class="btn btn-primary" onclick="previewFirstStableImport()">
                {{ tf('data_import_preview_btn', 'Analyze file (no changes)') }}
              </button>
            </div>
            <div id="data-import-status" class="alert" style="display:none;margin-top:1rem;"></div>

            <div id="data-analyze-controls" class="card" style="display:none;margin-top:1rem;padding:0.75rem;border:1px solid var(--border, #e5e7eb);background:rgba(255,255,255,0.75);">
              <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:end;">
                <div style="flex:1 1 260px;">
                  <label class="form-label" for="data-analyze-search">{{ tf('search', 'Search') }}</label>
                  <input id="data-analyze-search" class="form-input" type="text" placeholder="{{ tf('data_import_search_hint', 'Search name, phone, file #, or page #') }}">
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:6px;align-items:end;">
                  <span class="u-text-muted" style="font-size:0.9rem;">{{ tf('data_analyze_mode_label', 'Analyze mode') }}</span>
                  <div class="actions-row" id="data-analyze-mode" style="margin:0;gap:6px;">
                    <button type="button" class="btn btn-secondary btn-sm" data-analyze-mode="safe">{{ tf('data_analyze_mode_safe', 'Safe') }}</button>
                    <button type="button" class="btn btn-secondary btn-sm" data-analyze-mode="normal">{{ tf('data_analyze_mode_normal', 'Normal') }}</button>
                    <button type="button" class="btn btn-secondary btn-sm" data-analyze-mode="aggressive">{{ tf('data_analyze_mode_aggressive', 'Aggressive') }}</button>
                  </div>
                </div>
                <div class="actions-row" id="data-analyze-pagination" style="margin:0;gap:6px;align-self:end;"></div>
              </div>
              <div class="u-text-muted" style="margin-top:0.35rem;font-size:0.85rem;">
                {{ tf('data_analyze_mode_tip', 'Safe: page + exact name (phone when present). Normal: page + exact name (phone optional). Aggressive: name only.') }}
              </div>
              <div class="u-text-muted" id="data-analyze-status" style="margin-top:0.35rem;"></div>
            </div>

          <div id="data-import-summary" style="margin-top:1rem;display:none;">
            <h3 class="card-title" style="font-size:1rem;margin-bottom:0.5rem;">{{ tf('data_import_summary', 'Preview of rows') }}</h3>
            <p class="u-text-muted" id="data-import-summary-text"></p>
            <div class="data-scroll-area">
              <table class="admin-table">
                <thead>
                  <tr>
                    <th scope="col">{{ tf('file_number', 'File number') }}</th>
                    <th scope="col">{{ tf('page_numbers', 'Page numbers') }}</th>
                    <th scope="col">{{ tf('name', 'Name') }}</th>
                    <th scope="col">{{ tf('phone', 'Phone') }}</th>
                    <th scope="col">{{ tf('total', 'Total') }}</th>
                    <th scope="col">{{ tf('down_payment', 'Paid Today') }}</th>
                    <th scope="col">{{ tf('remaining_amount', 'Remaining') }}</th>
                    <th scope="col">{{ tf('payments', 'Payments') }}</th>
                    <th scope="col">{{ tf('actions', 'Actions') }}</th>
                  </tr>
                </thead>
                <tbody id="data-import-preview-body">
                </tbody>
              </table>
            </div>
          </div>
          <p class="u-text-muted" style="margin-top:0.5rem;">
            {{ tf(
              'data_import_preview_bat_hint',
              'To safely review your Excel before importing, use the Analyze and Preview tools in this tab. (Preview mode is a developer tool and is not included in clinic builds.)'
            ) }}
          </p>
            <div id="data-import-duplicates" style="margin-top:1.5rem;display:none;">
              <h3 class="card-title" style="font-size:1rem;margin-bottom:0.5rem;">
                {{ tf('data_import_duplicates_title', 'Possible duplicate patients') }}
              </h3>
              <p class="u-text-muted" id="data-import-duplicates-text">
                {{ tf(
                  'data_import_duplicates_hint',
                  'These are patients where the first and second name match. Use this list to review possible duplicates before importing.'
                ) }}
              </p>
              <div class="form-group" style="margin-top:0.5rem;">
                <label class="form-label" for="data-analyze-dups-search">{{ tf('search', 'Search') }}</label>
                <input id="data-analyze-dups-search" class="form-input" type="text" placeholder="{{ tf('data_import_search_hint', 'Search name, phone, file #, or page #') }}">
              </div>
              <div style="margin-bottom:0.5rem;">
                <label style="font-size:0.85rem;" class="data-advanced">
                  <input type="checkbox" id="data-import-duplicates-aggressive-toggle">
                  {{ tf(
                    'data_import_duplicates_aggressive',
                    'Show aggressive suggestions (ignore phone, match by name only)'
                  ) }}
                </label>
              </div>
              <div class="data-scroll-area">
                <table class="admin-table">
                  <thead>
                    <tr>
                      <th scope="col">{{ tf('name', 'Name') }}</th>
                      <th scope="col">{{ tf('file_number', 'File number') }} / {{ tf('phone', 'Phone') }}</th>
                      <th scope="col">{{ tf('payments', 'Payments') }}</th>
                      <th scope="col">{{ tf('total', 'Total') }}</th>
                      <th scope="col">{{ tf('remaining_amount', 'Remaining') }}</th>
                    </tr>
                  </thead>
                  <tbody id="data-import-duplicates-body"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div id="data-sub-duplicates" class="data-subpane" style="margin-top:1rem;display:none;">
	          <div id="data-db-duplicates" style="margin-top:1.5rem;">
	            <h3 class="card-title" style="font-size:1rem;margin-bottom:0.5rem;">
	              {{ tf('data_import_db_duplicates_title', 'Possible duplicates in your database') }}
	            </h3>
	            <p class="u-text-muted" id="data-db-duplicates-text" style="margin-top:0.25rem;">
	              {{ tf('data_import_db_duplicates_hint', 'This scans your current clinic database for possible duplicates. Nothing is merged automatically.') }}
	            </p>
            <div class="actions-row" style="margin-top:0.5rem;">
              <button type="button" class="btn btn-secondary data-simple-only" onclick="loadDbDuplicates('normal')">
                {{ tf('data_import_db_duplicates_scan_simple_btn', 'Scan duplicates') }}
              </button>
              <button type="button" class="btn btn-secondary data-advanced" onclick="loadDbDuplicates('safe')">
                {{ tf('data_import_db_duplicates_safe_btn', 'Scan (safe)') }}
              </button>
              <button type="button" class="btn btn-secondary data-advanced" onclick="loadDbDuplicates('normal')">
                {{ tf('data_import_db_duplicates_normal_btn', 'Scan (normal)') }}
              </button>
              <button type="button" class="btn btn-secondary data-advanced" onclick="loadDbDuplicates('aggressive')">
                {{ tf('data_import_db_duplicates_aggressive_btn', 'Scan (aggressive)') }}
              </button>
            </div>
            <div class="u-text-muted" style="margin-top:0.35rem;font-size:0.85rem;">
              {{ tf('data_db_duplicates_mode_tip', 'Safe: name + same/missing phone. Normal: name + same phone/page. Aggressive: name only.') }}
            </div>
              <div id="data-db-duplicates-list" style="margin-top:0.75rem;">
                <div class="u-text-muted">{{ tf('data_import_db_duplicates_idle', 'Press Scan to check duplicates.') }}</div>
              </div>
	          </div>
          </div>

          <div id="data-sub-export" class="data-subpane" style="margin-top:1rem;display:none;">
            <p>{{ tf('data_export_intro', 'Export your clinic data as a CSV file that can be opened in Excel.') }}</p>
            <p class="u-text-muted">
              {{ tf('data_export_hint', 'This export uses the same columns as the CSV import template, so you can re-import it later if needed.') }}
            </p>
            <div class="actions-row" style="margin-top:0.75rem;">
              <a href="{{ url_for('admin_settings.export_payments_csv') }}" class="btn secondary">
                {{ tf('data_import_export_payments', 'Export all payments (CSV)') }}
              </a>
            </div>
            <p class="u-text-muted" style="margin-top:0.75rem;">
              {{ tf('data_export_sort_hint', 'Export is ordered from oldest payments to newest payments.') }}
            </p>
          </div>

          <div id="data-sub-reports" class="data-subpane data-advanced" style="margin-top:1rem;display:none;">
            <div id="data-import-reports">
              <h3 class="card-title" style="font-size:1rem;margin-bottom:0.5rem;">
                {{ tf('data_import_reports_title', 'Import reports') }}
              </h3>
              <p class="u-text-muted" style="margin-top:0.25rem;">
                {{ tf('data_import_reports_hint', 'Use these to download past import reports and review duplicates later.') }}
              </p>
              <div class="actions-row" style="margin-top:0.5rem;">
                <button type="button" class="btn btn-secondary" onclick="refreshImportReports()">
                  {{ tf('refresh', 'Refresh') }}
                </button>
              </div>
              <div id="data-import-reports-list" style="margin-top:0.75rem;">
                <div class="u-text-muted">{{ tf('loading', 'Loading...') }}</div>
              </div>
            </div>
            <div id="data-import-after-import" style="display:none;margin-top:1.25rem;" class="data-advanced">
              <div style="font-weight:600;margin-bottom:0.35rem;">
                {{ tf('data_import_after_import', 'After import') }}
              </div>
              <p class="u-text-muted" id="data-import-report-dups-text" style="margin-top:0.25rem;">
                {{ tf('data_import_report_dups_hint', 'Review possible duplicates related to this import before continuing your work.') }}
              </p>
              <div class="actions-row" style="margin-top:0.5rem;">
                <button type="button" class="btn btn-secondary" onclick="loadReportDuplicates('safe')">
                  {{ tf('data_import_report_dups_safe_btn', 'Review duplicates (safe)') }}
                </button>
                <button type="button" class="btn btn-secondary data-advanced" onclick="loadReportDuplicates('normal')">
                  {{ tf('data_import_report_dups_normal_btn', 'Review duplicates (normal)') }}
                </button>
                <button type="button" class="btn btn-secondary data-advanced" onclick="loadReportDuplicates('aggressive')">
                  {{ tf('data_import_report_dups_aggressive_btn', 'Review duplicates (aggressive)') }}
                </button>
              </div>
              <div id="data-import-report-dups-list" style="margin-top:0.75rem;"></div>
            </div>
          </div>

          <div id="data-sub-backups" class="data-subpane data-advanced" style="margin-top:1rem;display:none;">
	          <div id="db-backups" style="margin-top:1.5rem;">
	            <h3 class="card-title" style="font-size:1rem;margin-bottom:0.5rem;">
	              {{ tf('db_backups_title', 'Database backups') }}
	            </h3>
	            <p class="u-text-muted" style="margin-top:0.25rem;">
	              {{ tf('db_backups_hint', 'Backups are created automatically before each import. You can also create one manually here.') }}
	            </p>
	            <div class="actions-row" style="margin-top:0.5rem;">
	              <button type="button" class="btn btn-secondary" onclick="refreshBackups()">
	                {{ tf('refresh', 'Refresh') }}
	              </button>
	              <button type="button" class="btn btn-secondary" onclick="createBackupNow()">
	                {{ tf('db_backup_create_now', 'Create backup now') }}
	              </button>
	            </div>
	            <div id="db-backups-status" class="alert" style="display:none;margin-top:0.75rem;"></div>
	            <div style="overflow-x:auto;margin-top:0.75rem;">
	              <table class="admin-table">
	                <thead>
	                  <tr>
	                    <th scope="col">{{ tf('file', 'File') }}</th>
	                    <th scope="col">{{ tf('size', 'Size') }}</th>
	                    <th scope="col">{{ tf('actions', 'Actions') }}</th>
	                  </tr>
	                </thead>
	                <tbody id="db-backups-body">
	                  <tr><td colspan="3" class="u-text-muted">{{ tf('loading', 'Loading...') }}</td></tr>
	                </tbody>
	              </table>
	            </div>
	            <p class="u-text-muted" style="margin-top:0.5rem;">
	              {{ tf('db_backups_restore_note', 'Restore is safest when the app is closed. If you need to restore, tell me and I will add a guided restore workflow.') }}
	            </p>
	          </div>
          </div>
        </div>
      </div>
      <!-- Data import payments modal -->
      <div id="data-import-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 id="data-import-modal-title" class="modal-title">{{ tf('data_import_summary', 'Preview of rows') }}</h3>
            <button class="modal-close" type="button" onclick="closeDataImportModal()">&times;</button>
          </div>
          <div class="modal-body">
            <div id="data-import-modal-content"></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" onclick="closeDataImportModal()">{{ tf('close', 'Close') }}</button>
          </div>
        </div>
      </div>

      <!-- Database duplicates merge modal -->
      <div id="db-dup-merge-modal" class="modal">
        <div class="modal-content" style="max-width:780px;">
          <div class="modal-header">
            <h3 class="modal-title">{{ tf('merge_patient', 'Merge into another file') }}</h3>
            <button class="modal-close" type="button" onclick="closeDbDupMergeModal()">&times;</button>
          </div>
          <div class="modal-body">
            <div id="db-dup-merge-alert" class="alert alert-error" style="display:none;"></div>

            <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:0.5rem;">
              <div class="card" style="flex:1 1 280px; margin:0;">
                <div class="card-header" style="margin-bottom:0.5rem;">
                  <h4 class="card-title" style="font-size:1rem;">{{ tf('left_file', 'Left file') }}</h4>
                </div>
                <div id="db-dup-merge-left" class="u-text-muted"></div>
                <label class="checkbox-item" style="margin-top:0.75rem;">
                  <input type="radio" name="db-dup-keep" id="db-dup-keep-left" value="left" checked>
                  <span>{{ tf('keep_file', 'Keep this file') }}</span>
                </label>
              </div>
              <div class="card" style="flex:1 1 280px; margin:0;">
                <div class="card-header" style="margin-bottom:0.5rem;">
                  <h4 class="card-title" style="font-size:1rem;">{{ tf('right_file', 'Right file') }}</h4>
                </div>
                <div id="db-dup-merge-right" class="u-text-muted"></div>
                <label class="checkbox-item" style="margin-top:0.75rem;">
                  <input type="radio" name="db-dup-keep" id="db-dup-keep-right" value="right">
                  <span>{{ tf('keep_file', 'Keep this file') }}</span>
                </label>
              </div>
            </div>

            <label class="checkbox-item" style="margin-top:1rem;">
              <input type="checkbox" id="db-dup-merge-diag">
              <span>{{ tf('merge_diag_images_label', 'Also merge diagnosis, medical history and images') }}</span>
            </label>

            <p class="u-text-muted" style="margin-top:0.75rem;">
              {{ tf('merge_patient_warning', 'This will move all payments and appointments from this patient into the target file. Diagnosis, medical history and images are only merged when checked and only if the target has none. This action cannot be undone.') }}
            </p>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" onclick="closeDbDupMergeModal()">{{ tf('cancel', 'Cancel') }}</button>
            <button id="db-dup-merge-submit" class="btn btn-primary" type="button" onclick="submitDbDupMerge()">{{ tf('merge_now', 'Merge') }}</button>
          </div>
        </div>
      </div>

      <!-- Quick view patient file (used from Admin -> Data -> Duplicates) -->
      <div id="patient-quickview-modal" class="modal modal-wide">
        <div class="modal-content" style="max-width:1100px;">
          <div class="modal-header">
            <h3 id="patient-quickview-title" class="modal-title">{{ tf('patient_file', 'Patient file') }}</h3>
            <button class="modal-close" type="button" onclick="closePatientQuickView()">&times;</button>
          </div>
          <div class="modal-body">
            <div id="patient-quickview-body" class="u-text-muted">{{ tf('loading', 'Loading...') }}</div>
          </div>
          <div class="modal-footer" style="justify-content:space-between;gap:10px;flex-wrap:wrap;">
            <a id="patient-quickview-open" class="btn secondary" href="#" target="_blank" rel="noopener">{{ tf('open', 'Open') }}</a>
            <button class="btn btn-secondary" type="button" onclick="closePatientQuickView()">{{ tf('close', 'Close') }}</button>
          </div>
        </div>
      </div>

      <!-- Import report modal (summary + page conflicts) -->
      <div id="import-report-modal" class="modal modal-wide">
        <div class="modal-content">
          <div class="modal-header">
            <h3 id="import-report-modal-title" class="modal-title">{{ tf('data_import_report_title', 'Import report') }}</h3>
            <button class="modal-close" type="button" onclick="closeImportReportModal()">&times;</button>
          </div>
          <div class="modal-body">
            <div id="import-report-modal-status" class="alert" style="display:none;"></div>
            <div id="import-report-modal-body"></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" onclick="closeImportReportModal()">{{ tf('close', 'Close') }}</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Audit Tab (payments only) -->
    <div id="audit-tab" class="admin-tab-pane">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">{{ tf('audit_payments_title', 'Payments audit log') }}</h2>
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <button class="btn btn-secondary" type="button" onclick="auditPaymentsExportCsv()">
              {{ tf('export_csv', 'Export CSV') }}
            </button>
          </div>
        </div>

        <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; margin-bottom: 12px;">
          <div style="min-width: 180px;">
            <label class="form-label">{{ tf('from_date', 'From') }}</label>
            <input id="audit-from" class="form-input" type="date" />
          </div>
          <div style="min-width: 180px;">
            <label class="form-label">{{ tf('to_date', 'To') }}</label>
            <input id="audit-to" class="form-input" type="date" />
          </div>
          <div style="min-width: 220px;">
            <label class="form-label">{{ tf('user', 'User') }}</label>
            <input id="audit-user" class="form-input" type="text" placeholder="{{ tf('audit_user_hint', 'username') }}" />
          </div>
          <div style="min-width: 220px;">
            <label class="form-label">{{ tf('action', 'Action') }}</label>
            <select id="audit-action" class="form-input">
              <option value="">{{ tf('all', 'All') }}</option>
              <option value="payment_create">{{ tf('audit_payment_create', 'Payment added') }}</option>
              <option value="payment_update">{{ tf('audit_payment_update', 'Payment updated') }}</option>
              <option value="payment_delete">{{ tf('audit_payment_delete', 'Payment deleted') }}</option>
            </select>
          </div>
          <div>
            <button class="btn btn-primary" type="button" onclick="auditPaymentsLoad()">{{ tf('filter', 'Filter') }}</button>
            <button class="btn btn-secondary" type="button" onclick="auditPaymentsReset()">{{ tf('reset', 'Reset') }}</button>
          </div>
        </div>

        <div class="alert alert-info" id="audit-payments-status" style="display:none;"></div>

        <div style="overflow-x:auto;">
          <table class="admin-table">
            <thead>
              <tr>
                <th scope="col">{{ tf('date', 'Date') }}</th>
                <th scope="col">{{ tf('user', 'User') }}</th>
                <th scope="col">{{ tf('action', 'Action') }}</th>
                <th scope="col">{{ tf('patient', 'Patient') }}</th>
                <th scope="col">{{ tf('amount', 'Amount') }}</th>
                <th scope="col">{{ tf('method', 'Method') }}</th>
                <th scope="col">{{ tf('payment_id', 'Payment ID') }}</th>
                <th scope="col">{{ tf('view', 'View') }}</th>
              </tr>
            </thead>
            <tbody id="audit-payments-body">
              <tr><td colspan="8" class="u-text-muted">{{ tf('loading', 'Loading...') }}</td></tr>
            </tbody>
          </table>
        </div>

        <details class="u-card" style="margin-top:14px;">
          <summary style="cursor:pointer; display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
            <div>
              <div class="u-text-muted" style="font-size:12px; text-transform:uppercase; letter-spacing:.08em;">
                {{ tf('audit_privacy_title', 'Audit privacy') }}
              </div>
              <div style="font-weight:700; font-size:18px;">
                {{ tf('audit_snapshots_title', 'Patient snapshots') }}
              </div>
            </div>
            <div class="u-text-muted" id="audit-privacy-summary" style="font-weight:600;">
              {{ tf('loading', 'Loading...') }}
            </div>
          </summary>

          <div style="margin-top:10px;">
            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
              <button class="btn btn-secondary" type="button" onclick="auditSnapshotsOpen()">
                {{ tf('audit_snapshots_view', 'View snapshots') }}
              </button>
              <button class="btn btn-secondary" type="button" onclick="auditPrivacyBackfillConfirm()">
                {{ tf('audit_snapshots_backfill', 'Backfill') }}
              </button>
              <button class="btn btn-secondary" type="button" onclick="auditPrivacyPurgeExpiredConfirm()">
                {{ tf('audit_snapshots_purge_expired', 'Purge expired') }}
              </button>
              <button class="btn btn-danger" type="button" onclick="auditPrivacyPurgeAllConfirm()">
                {{ tf('audit_snapshots_purge_all', 'Purge all') }}
              </button>
            </div>

            <div id="audit-privacy-status" class="alert" style="display:none; margin-top:10px;"></div>

            <div style="display:flex; gap:14px; flex-wrap:wrap; align-items:flex-end; margin-top:10px;">
              <label style="display:flex; gap:8px; align-items:center;">
                <input id="audit-snapshots-enabled" type="checkbox" />
                <span>{{ tf('audit_snapshots_enabled', 'Store patient snapshots (name + file/page)') }}</span>
              </label>
              <div style="min-width:220px;">
                <label class="form-label">{{ tf('audit_snapshots_retention', 'Keep snapshots for') }}</label>
                <select id="audit-snapshots-retention" class="form-input">
                  <option value="90">90 {{ tf('days', 'days') }}</option>
                  <option value="180">180 {{ tf('days', 'days') }}</option>
                  <option value="365">365 {{ tf('days', 'days') }}</option>
                  <option value="0">{{ tf('forever', 'Forever') }}</option>
                </select>
              </div>
              <div>
                <button class="btn btn-primary" type="button" onclick="auditPrivacySave()">{{ tf('save', 'Save') }}</button>
              </div>
              <div class="u-text-muted" id="audit-snapshot-count" style="min-width:200px;"></div>
            </div>

            <div class="u-text-muted" style="margin-top:8px; line-height:1.5;">
              {{ tf('audit_snapshots_help', 'Snapshots keep the audit readable even if a patient is later deleted. You can purge snapshots any time; audit events remain.') }}
              {{ tf('audit_snapshots_help_deleted', 'Already-deleted patients cannot be recovered and will show as ‚ÄúUnknown patient‚Äù.') }}
            </div>
          </div>
        </details>
      </div>
    </div>

    <!-- Confirm modal (used for audit privacy actions) -->
    <div id="confirm-modal" class="modal">
      <div class="modal-content" style="max-width:560px;">
        <div class="modal-header">
          <h3 id="confirm-modal-title" class="modal-title">{{ tf('confirm', 'Confirm') }}</h3>
          <button class="modal-close" type="button" onclick="closeConfirmModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div id="confirm-modal-message" class="u-text-muted"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" onclick="closeConfirmModal()">{{ tf('cancel', 'Cancel') }}</button>
          <button id="confirm-modal-ok" class="btn btn-primary" type="button" onclick="confirmModalOk()">{{ tf('confirm', 'Confirm') }}</button>
        </div>
      </div>
    </div>

    <!-- Audit row details modal -->
    <div id="audit-row-modal" class="modal modal-wide">
      <div class="modal-content" style="max-width:980px;">
        <div class="modal-header">
          <h3 id="audit-row-title" class="modal-title">{{ tf('audit_view_title', 'Audit entry') }}</h3>
          <button class="modal-close" type="button" onclick="closeAuditRowModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div id="audit-row-body"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" onclick="closeAuditRowModal()">{{ tf('close', 'Close') }}</button>
        </div>
      </div>
    </div>

    <!-- Audit snapshots viewer modal -->
    <div id="audit-snapshots-modal" class="modal modal-wide">
      <div class="modal-content" style="max-width:1100px;">
        <div class="modal-header">
          <h3 class="modal-title">{{ tf('audit_snapshots_view', 'View snapshots') }}</h3>
          <button class="modal-close" type="button" onclick="closeAuditSnapshotsModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div id="audit-snapshots-status" class="alert" style="display:none;"></div>
          <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
            <div style="min-width:240px; flex:1;">
              <label class="form-label">{{ tf('search', 'Search') }}</label>
              <input id="audit-snapshots-q" class="form-input" type="text" placeholder="{{ tf('name_or_file', 'Name / file / page') }}" />
            </div>
            <div style="min-width:180px;">
              <label class="form-label">{{ tf('from_date', 'From') }}</label>
              <input id="audit-snapshots-from" class="form-input" type="date" />
            </div>
            <div style="min-width:180px;">
              <label class="form-label">{{ tf('to_date', 'To') }}</label>
              <input id="audit-snapshots-to" class="form-input" type="date" />
            </div>
            <div>
              <button class="btn btn-primary" type="button" onclick="auditSnapshotsLoad(true)">{{ tf('filter', 'Filter') }}</button>
              <button class="btn btn-secondary" type="button" onclick="auditSnapshotsReset()">{{ tf('reset', 'Reset') }}</button>
            </div>
          </div>

          <div style="overflow-x:auto; margin-top:12px;">
            <table class="admin-table">
              <thead>
                <tr>
                  <th scope="col">{{ tf('date', 'Date') }}</th>
                  <th scope="col">{{ tf('action', 'Action') }}</th>
                  <th scope="col">{{ tf('payment_id', 'Payment ID') }}</th>
                  <th scope="col">{{ tf('patient', 'Patient') }}</th>
                </tr>
              </thead>
              <tbody id="audit-snapshots-body">
                <tr><td colspan="4" class="u-text-muted">{{ tf('loading', 'Loading...') }}</td></tr>
              </tbody>
            </table>
          </div>

          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-top:10px;">
            <div class="u-text-muted" id="audit-snapshots-pager-text"></div>
            <div style="display:flex; gap:10px;">
              <button id="audit-snapshots-prev" class="btn btn-secondary" type="button" onclick="auditSnapshotsPrev()">{{ tf('prev', 'Prev') }}</button>
              <button id="audit-snapshots-next" class="btn btn-secondary" type="button" onclick="auditSnapshotsNext()">{{ tf('next', 'Next') }}</button>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" onclick="closeAuditSnapshotsModal()">{{ tf('close', 'Close') }}</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- User Modal -->
<div id="user-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="user-modal-title" class="modal-title">{{ tf('create_user', 'Create User') }}</h3>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div id="user-alert" class="alert alert-error" style="display: none;"></div>
      <form id="user-form" class="admin-form">
        <input type="hidden" id="user-id" name="user_id">

        <div class="form-group">
          <label class="form-label">{{ tf('username', 'Username') }} *</label>
          <input type="text" id="user-username" class="form-input" required>
        </div>

        <div class="form-group">
          <label class="form-label">{{ tf('name', 'Name') }}</label>
          <input type="text" id="user-full-name" class="form-input">
        </div>

        <div class="form-group">
          <label class="form-label">{{ tf('phone', 'Phone') }}</label>
          <input type="tel" id="user-phone" class="form-input">
        </div>

        <div class="form-group">
          <label class="form-label">{{ tf('password', 'Password') }} *</label>
          <input type="password" id="user-password" class="form-input">
        </div>

        <div class="form-group">
          <label class="form-label">{{ tf('roles', 'Roles') }}</label>
          <div class="form-checkbox-group">
            {% for role in roles %}
            <div class="checkbox-item">
              <input type="checkbox" id="role-{{ role.id }}" value="{{ role.id }}">
              <label for="role-{{ role.id }}">{{ role.name }}</label>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="form-group">
          <label class="checkbox-item">
            <input type="checkbox" id="user-active" checked>
            <span>{{ tf('active', 'Active') }}</span>
          </label>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">{{ tf('cancel', 'Cancel') }}</button>
      <button id="user-submit-btn" class="btn btn-primary" onclick="saveUser()">{{ tf('create_user', 'Create User') }}</button>
    </div>
  </div>
</div>

<!-- Role Modal -->
<div id="role-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="role-modal-title" class="modal-title">{{ tf('create_role', 'Create Role') }}</h3>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div id="role-alert" class="alert alert-error" style="display: none;"></div>
      <form id="role-form" class="admin-form">
        <input type="hidden" id="role-id" name="role_id">

        <div class="form-group">
          <label class="form-label">{{ tf('role', 'Role') }} *</label>
          <input type="text" id="role-name" class="form-input" required>
        </div>

        <div class="form-group">
          <label class="form-label">{{ tf('description', 'Description') }}</label>
          <input type="text" id="role-description" class="form-input">
        </div>

        <div class="form-group">
          <label class="form-label">{{ tf('permissions', 'Permissions') }}</label>
          <div class="permission-groups">
            {% for group_name, group_permissions in permissions.items() %}
            <div class="permission-group">
              <div class="permission-group-title">{{ group_name }}</div>
              <div class="permission-list">
                {% for perm in group_permissions %}
                <div class="checkbox-item">
                  <input type="checkbox" id="perm-{{ perm.id }}" value="{{ perm.id }}">
                  <label for="perm-{{ perm.id }}" title="{{ perm.description or perm.code }}">{{ perm.code }}</label>
                </div>
                {% endfor %}
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">{{ tf('cancel', 'Cancel') }}</button>
      <button id="role-submit-btn" class="btn btn-primary" onclick="saveRole()">{{ tf('create_role', 'Create Role') }}</button>
    </div>
  </div>
</div>

<!-- Doctor Modal -->
<div id="doctor-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="doctor-modal-title" class="modal-title">{{ tf('doctor', 'Doctor') }}</h3>
      <button class="modal-close" onclick="closeDoctorModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div id="doctor-alert" class="alert alert-error" style="display: none;"></div>
      <div class="form-group">
        <label class="form-label">{{ tf('doctor_id', 'Doctor ID') }}</label>
        <div id="doctor-id-display" class="u-text-muted">{{ tf('generated_automatically', 'Will be generated automatically') }}</div>
      </div>
      <div class="form-group">
        <label class="form-label">{{ tf('doctor_name', 'Doctor Name') }}</label>
        <input type="text" id="doctor-label" class="form-input" placeholder="{{ tf('doctor_name', 'Dr. Sara') }}" autocomplete="off">
      </div>
      <div class="form-group">
        <label class="form-label">{{ tf('color', 'Color') }}</label>
        <input type="color" id="doctor-color" class="form-input color-input" value="#6b7280">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" type="button" onclick="closeDoctorModal()">{{ tf('cancel', 'Cancel') }}</button>
      <button id="doctor-submit-btn" class="btn btn-primary" type="button" onclick="saveDoctor()">{{ tf('save', 'Save') }}</button>
    </div>
  </div>
</div>
<script>
// Quick polyfills for older browsers (Edge/IE)
if (window.NodeList && !NodeList.prototype.forEach) {
  NodeList.prototype.forEach = function(callback, thisArg) {
    thisArg = thisArg || window;
    for (var i = 0; i < this.length; i++) {
      callback.call(thisArg, this[i], i, this);
    }
  };
}
if (!Array.from) {
  Array.from = function(iterable) {
    return Array.prototype.slice.call(iterable || []);
  };
}

// Get CSRF token from meta tag
var csrfMetaTag = document.querySelector('meta[name="csrf-token"]');
var CSRF_TOKEN = csrfMetaTag ? (csrfMetaTag.getAttribute('content') || '') : '';
var L = {
  saving: "{{ tf('saving', 'Saving...') }}",
  saveFailed: "{{ tf('admin_save_failed', 'Save failed.') }}",
  createUser: "{{ tf('create_user', 'Create User') }}",
  editUser: "{{ tf('edit_user', 'Edit User') }}",
  updateUser: "{{ tf('update_user', 'Update User') }}",
  createRole: "{{ tf('create_role', 'Create Role') }}",
  editRole: "{{ tf('edit_role', 'Edit Role') }}",
  updateRole: "{{ tf('update_role', 'Update Role') }}",
  addDoctor: "{{ tf('add_doctor', 'Add Doctor') }}",
  editDoctor: "{{ tf('edit_doctor', 'Edit Doctor') }}",
  generatedAutomatically: "{{ tf('generated_automatically', 'Will be generated automatically') }}",
  themeSaveFailed: "{{ tf('theme_save_failed', 'Failed to save theme') }}",
  themeSavedReload: "{{ tf('theme_saved_reload', 'Theme saved. Reload to apply.') }}",
  themeUnexpected: "{{ tf('theme_unexpected_error', 'Unexpected error while saving theme.') }}",
  userLoadError: "{{ tf('admin_user_load_error', 'Error loading user data') }}",
  genericError: "{{ tf('admin_generic_error', 'An error occurred. Please try again.') }}",
  userDeleteConfirm: "{{ tf('admin_user_delete_confirm', 'Are you sure you want to delete user \"{name}\"?') }}",
  errorPrefix: "{{ tf('admin_error_prefix', 'Error:') }}",
  roleLoadError: "{{ tf('admin_role_load_error', 'Error loading role data') }}",
  roleDeleteConfirm: "{{ tf('admin_role_delete_confirm', 'Are you sure you want to delete role \"{name}\"?') }}",
  doctorSaveFailed: "{{ tf('admin_doctor_save_failed', 'Failed to save doctor') }}",
  doctorSaveUnexpected: "{{ tf('admin_doctor_save_unexpected', 'Unexpected error saving doctor.') }}",
  doctorDeleteError: "{{ tf('admin_doctor_delete_error', 'Error deleting doctor') }}",
  doctorDeleted: "{{ tf('admin_doctor_deleted', 'Doctor deleted.') }}",
  doctorDeleteConfirm: "{{ tf('admin_doctor_delete_confirm', 'Delete doctor \"{name}\"?') }}",
  doctorDeleteConfirmSimple: "{{ tf('admin_doctor_delete_confirm_simple', 'Delete this doctor entry?') }}",
  resetColorsConfirm: "{{ tf('admin_reset_colors_confirm', 'Are you sure you want to reset all doctor colors to defaults?') }}",
  unknownError: "{{ tf('admin_unknown_error', 'Unknown error') }}",
  deletedEmpty: "{{ tf('admin_deleted_doctors_empty', 'No deleted doctors.') }}",
  doctorIdLabel: "{{ tf('doctor_id', 'Doctor ID') }}",
  restore: "{{ tf('admin_restore', 'Restore') }}",
  deletePermanent: "{{ tf('admin_delete_permanent', 'Delete Permanently') }}",
  dataImportLoading: "{{ tf('data_import_loading', 'Analyzing file...') }}",
  dataImportPreviewFailed: "{{ tf('data_import_preview_failed', 'Could not read file.') }}",
  dataImportPreviewOk: "{{ tf('data_import_preview_ok', 'Preview generated.') }}",
  dataImportNoRows: "{{ tf('data_import_no_rows', 'No usable rows were found in the file.') }}",
  dataImportTotalRows: "{{ tf('data_import_total_rows', 'Rows') }}",
  dataImportPatients: "{{ tf('data_import_patients', 'Patients') }}",
  dataImportPayments: "{{ tf('data_import_payments', 'Payments') }}",
  dataImportPaymentRows: "{{ tf('data_import_payment_rows', 'Payment rows') }}",
  dataImportPatientsInFile: "{{ tf('data_import_patients_in_file', 'Patients in file') }}",
  dataImportPatientsNoPaymentsImported: "{{ tf('data_import_patients_no_payments_imported', 'Patients created (no payments imported)') }}",
  dataImportSkippedZeroEntries: "{{ tf('data_import_skipped_zero_entries', 'Skipped zero-amount rows') }}",
  dataImportZeroEntries: "{{ tf('data_import_zero_entries', 'Zero-amount entries') }}",
  dataImportSkippedRows: "{{ tf('data_import_skipped_rows', 'Skipped empty rows') }}",
  dataImportMissingFile: "{{ tf('data_import_missing_file', 'Missing file number') }}",
  dataImportMissingName: "{{ tf('data_import_missing_name', 'Missing name') }}",
  dataImportUnexpected: "{{ tf('data_import_unexpected', 'Unexpected error while reading file.') }}",
  dataImportFileRequired: "{{ tf('data_import_file_required', 'Please choose a file to analyze.') }}",
  dataImportViewPayments: "{{ tf('data_import_view_payments', 'View payments') }}",
  dataImportStatusDone: "{{ tf('data_import_status_done', 'Done') }}",
  dataImportStatusOwing: "{{ tf('data_import_status_owing', 'Owing') }}",
  dataImportCommitConfirm: "{{ tf('data_import_commit_confirm', 'This will write to your real clinic database and may take a minute. A backup will be created first. Continue?') }}",
  dataImportCommitRunning: "{{ tf('data_import_commit_running', 'Importing... Please wait.') }}",
  dataImportCommitOk: "{{ tf('data_import_commit_ok', 'Import completed.') }}",
	  dataImportCommitFailed: "{{ tf('data_import_commit_failed', 'Import failed.') }}",
	  dataImportPreflightRunning: "{{ tf('data_import_preflight_running', 'Checking import against your database...') }}",
	  dataImportPreflightOk: "{{ tf('data_import_preflight_ok', 'Import check completed.') }}",
	  dataImportPreflightFailed: "{{ tf('data_import_preflight_failed', 'Import check failed.') }}",
	  dbDuplicatesNone: "{{ tf('data_import_db_duplicates_none', 'No duplicates found.') }}",
	  dbDuplicatesLoading: "{{ tf('data_import_db_duplicates_loading', 'Scanning database...') }}",
	  dbBackupLoading: "{{ tf('db_backups_loading', 'Loading backups...') }}",
	  dbBackupCreateOk: "{{ tf('db_backup_created', 'Backup created.') }}",
	  dbBackupCreateFailed: "{{ tf('db_backup_failed', 'Backup failed.') }}",
	  dbBackupsLoadFailed: "{{ tf('db_backups_load_failed', 'Could not load backups.') }}",
	  dbBackupRestoreConfirm: "{{ tf('db_backup_restore_confirm', 'Restore this backup? The app will close, then reopen it with Start-Clinic.bat.') }}",
	  dbBackupRestoreRunning: "{{ tf('db_backup_restore_running', 'Restoring... the app will close now.') }}",
	  dbBackupRestoreOk: "{{ tf('db_backup_restore_ok', 'Restore scheduled. Please reopen the app.') }}",
	  dbBackupRestoreFailed: "{{ tf('db_backup_restore_failed', 'Restore failed.') }}",
	  dataImportReportDupsLoading: "{{ tf('data_import_report_dups_loading', 'Scanning duplicates for this import...') }}",
	  dataImportReportDupsNone: "{{ tf('data_import_report_dups_none', 'No duplicates found for this import.') }}",
	  dataImportReportMissing: "{{ tf('data_import_report_missing', 'Import report not available. Please run an import first.') }}",
	  dataImportReportLoading: "{{ tf('data_import_report_loading', 'Loading report...') }}",
	  dataImportReportViewSummary: "{{ tf('data_import_report_view_summary', 'View report summary') }}",
	  dataImportReportViewConflicts: "{{ tf('data_import_report_view_conflicts', 'View page conflicts') }}",
	  dbDupMergeConfirm: "{{ tf('db_dup_merge_confirm', 'Merge these two patient files? The source file will be deleted.') }}",
	  dbDupMergeOk: "{{ tf('db_dup_merge_ok', 'Merge completed.') }}",
	  dbDupMergeFailed: "{{ tf('db_dup_merge_failed', 'Merge failed.') }}",
	  dupPhoneDiffers: "{{ tf('dup_phone_differs', 'Phone differs') }}",
	  dupPageDiffers: "{{ tf('dup_page_differs', 'Page differs') }}",
	  dupMissingPhone: "{{ tf('dup_missing_phone', 'Missing phone') }}",
	  dupMissingFile: "{{ tf('dup_missing_file', 'Missing file #') }}",
	  dupMissingPage: "{{ tf('dup_missing_page', 'Missing page #') }}",
	  dupMergeIntoKeep: "{{ tf('dup_merge_into_keep', 'Merge into kept file') }}"
	};
// Global variables
var currentUserId = null;
var currentRoleId = null;
var colorChanges = {};
var currentDoctorId = null;

// Tab switching functionality
function switchTab(evt, tabName) {
  // Update tab buttons
  var tabButtons = document.querySelectorAll('.admin-tab');
  for (var i = 0; i < tabButtons.length; i++) {
    tabButtons[i].classList.remove('active');
  }
  var trigger = (evt && (evt.currentTarget || evt.target)) || null;
  if (trigger && trigger.classList) {
    trigger.classList.add('active');
  }

  // Update tab content
  var panes = document.querySelectorAll('.admin-tab-pane');
  for (var j = 0; j < panes.length; j++) {
    panes[j].classList.remove('active');
  }

  var targetPane = document.getElementById(tabName + '-tab');
  if (targetPane && targetPane.classList) {
    targetPane.classList.add('active');
  }
  // Persist tab in hash
  window.location.hash = tabName;

  if (tabName === 'audit') {
    try { auditPaymentsLoad(); } catch (e) {}
    try { auditPrivacyLoad(); } catch (e) {}
  }
}

// Admin > Data tab: keep it simple by default, reveal advanced tools only when needed.
function setDataMode(isAdvanced) {
  var dataTab = document.getElementById('data-tab');
  var toggle = document.getElementById('data-advanced-toggle');
  if (!dataTab) return;

  var mode = isAdvanced ? 'advanced' : 'simple';
  dataTab.setAttribute('data-data-mode', mode);
  if (toggle) toggle.checked = Boolean(isAdvanced);

  try {
    window.localStorage.setItem('adminDataAdvanced', isAdvanced ? '1' : '0');
  } catch (e) {}

  // If user is in an advanced-only subtab, fall back to Import in simple mode.
  if (!isAdvanced) {
    var activeBtn = dataTab.querySelector('[data-data-subtab-btn].data-subtab-btn-active');
    var activeName = activeBtn ? activeBtn.getAttribute('data-data-subtab-btn') : '';
    if (activeName === 'reports' || activeName === 'backups') {
      switchDataSubtab('import');
    }
  }
}

function switchDataSubtab(name) {
  var dataTab = document.getElementById('data-tab');
  if (!dataTab) return;

  name = String(name || 'import');

  var mode = dataTab.getAttribute('data-data-mode') || 'simple';
  if (mode === 'simple' && (name === 'reports' || name === 'backups')) {
    name = 'import';
  }

  // Move the single file picker card into the active tab (browsers cannot copy selected files between inputs).
  (function() {
    var fileCard = document.getElementById('data-file-card');
    if (!fileCard) return;
    var slot = document.getElementById(name === 'analyze' ? 'data-file-slot-analyze' : 'data-file-slot-import');
    if (!slot) return;
    if (slot.firstChild !== fileCard) {
      slot.appendChild(fileCard);
    }
  })();

  var panes = dataTab.querySelectorAll('.data-subpane');
  for (var i = 0; i < panes.length; i++) {
    panes[i].style.display = 'none';
  }
  var activePane = document.getElementById('data-sub-' + name);
  if (activePane) activePane.style.display = 'block';

  var btns = dataTab.querySelectorAll('[data-data-subtab-btn]');
  for (var j = 0; j < btns.length; j++) {
    btns[j].classList.remove('data-subtab-btn-active');
  }
  var activeBtn = dataTab.querySelector('[data-data-subtab-btn="' + name + '"]');
  if (activeBtn) activeBtn.classList.add('data-subtab-btn-active');

  try {
    window.localStorage.setItem('adminDataSubtab', name);
  } catch (e) {}

  // Lazy-load content for some tabs.
  if (name === 'duplicates') {
    loadDbDuplicates((dataTab.getAttribute('data-data-mode') === 'simple') ? 'normal' : (__dbDupMode || 'normal'));
  } else if (name === 'reports') {
    refreshImportReports();
  } else if (name === 'backups') {
    refreshBackups();
  }
}

function initDataTabUi() {
  var dataTab = document.getElementById('data-tab');
  var toggle = document.getElementById('data-advanced-toggle');
  if (!dataTab || !toggle) return;

  var storedAdvanced = null;
  var storedSubtab = null;
  try {
    storedAdvanced = window.localStorage.getItem('adminDataAdvanced');
    storedSubtab = window.localStorage.getItem('adminDataSubtab');
  } catch (e) {}

  var isAdvanced = (storedAdvanced === '1');
  setDataMode(isAdvanced);

  toggle.addEventListener('change', function() {
    setDataMode(Boolean(toggle.checked));
  });

  // Default to Import; in Simple mode, Reports/Backups are hidden anyway.
  switchDataSubtab(storedSubtab || 'import');
}

function clearSelectedDataFile() {
  var fileInput = document.getElementById('data-import-file');
  var txt = document.getElementById('data-selected-file-text');
  if (fileInput) fileInput.value = '';
  if (txt) txt.textContent = '{{ tf("data_file_none", "No file selected.") }}';
}

function initSelectedDataFileUi() {
  var fileInput = document.getElementById('data-import-file');
  var txt = document.getElementById('data-selected-file-text');
  if (!fileInput || !txt) return;
  function update() {
    var f = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
    txt.textContent = f ? (f.name || '{{ tf("data_file_title", "Selected file") }}') : '{{ tf("data_file_none", "No file selected.") }}';
  }
  fileInput.addEventListener('change', update);
  update();
}

function initAnalyzeUi() {
  var search = document.getElementById('data-analyze-search');
  var dupSearch = document.getElementById('data-analyze-dups-search');
  var dupAggToggle = document.getElementById('data-import-duplicates-aggressive-toggle');
  var modeButtons = document.querySelectorAll('[data-analyze-mode]');
  var safeToggle = document.getElementById('data-import-never-auto-merge');

  var storedMode = null;
  try {
    storedMode = window.localStorage.getItem('adminDataAnalyzeMode');
  } catch (e) {}
  if (!storedMode) {
    storedMode = getImportMergeMode();
  }
  setAnalyzeMode(storedMode || 'safe', false);

  if (safeToggle) {
    safeToggle.addEventListener('change', function() {
      var mergeMode = getImportMergeMode();
      try {
        window.localStorage.setItem('adminDataMergeMode', mergeMode);
      } catch (e) {}
      if (__dataAnalyzeState.mode !== 'aggressive') {
        setAnalyzeMode(mergeMode, true);
      }
    });
  }

  if (modeButtons && modeButtons.length) {
    for (var i = 0; i < modeButtons.length; i++) {
      modeButtons[i].addEventListener('click', function() {
        var m = this.getAttribute('data-analyze-mode') || 'safe';
        setAnalyzeMode(m, true);
      });
    }
  }

  if (search) {
    var t1 = null;
    search.addEventListener('input', function() {
      var v = search.value || '';
      window.clearTimeout(t1);
      t1 = window.setTimeout(function() {
        __dataAnalyzeState.search = v;
        __dataAnalyzeState.pageIndex = 1;
        renderAnalyzePreview();
      }, 150);
    });
  }

  if (dupSearch) {
    var t2 = null;
    dupSearch.addEventListener('input', function() {
      var v2 = dupSearch.value || '';
      window.clearTimeout(t2);
      t2 = window.setTimeout(function() {
        __dataAnalyzeState.dupSearch = v2;
        var useAgg = dupAggToggle ? !!dupAggToggle.checked : false;
        renderDuplicatesTable(useAgg);
      }, 150);
    });
  }
}

// Theme save (colors only)
function saveThemeColors() {
  var statusEl = document.getElementById('theme-status-colors');
  var primary = document.getElementById('theme-primary').value;
  var accent = document.getElementById('theme-accent').value;
  var fontSize = document.getElementById('theme-font').value;
  var textColor = document.getElementById('theme-text-color').value;
  var btnTextColorInput = document.getElementById('theme-btn-text-color');
  var btnTextColor = btnTextColorInput ? btnTextColorInput.value : '';
  var metricColorInput = document.getElementById('theme-metric-color');
  var metricColor = metricColorInput ? metricColorInput.value : '';
  var pageBgInput = document.getElementById('theme-page-bg');
  var pageBg = pageBgInput ? pageBgInput.value : '';
  var cardBgInput = document.getElementById('theme-card-bg');
  var cardBg = cardBgInput ? cardBgInput.value : '';

  statusEl.style.display = 'none';
  statusEl.textContent = '';
  statusEl.className = 'alert';

  fetch('/admin/settings/theme/update', {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': CSRF_TOKEN
    },
    body: JSON.stringify({
      scope: 'colors',
      primary_color: primary,
      accent_color: accent,
      text_color: textColor,
      btn_text_color: btnTextColor,
      metric_text_color: metricColor,
      page_bg_tint: pageBg,
      card_bg_tint: cardBg,
      base_font_size: fontSize,
      csrf_token: CSRF_TOKEN
    })
  })
    .then(function(res) {
      return res.json().then(function(data) {
        return { res: res, data: data };
      });
    })
    .then(function(result) {
      var res = result.res;
      var data = result.data;
      if (!res.ok || !data.success) {
        var errs = (data.errors || [L.themeSaveFailed]).join(', ');
        statusEl.textContent = errs;
        statusEl.className = 'alert alert-error';
        statusEl.style.display = 'block';
        return;
      }
      statusEl.textContent = L.themeSavedReload;
      statusEl.className = 'alert alert-success';
      statusEl.style.display = 'block';
      window.location.reload();
    })
    .catch(function() {
      statusEl.textContent = L.themeUnexpected;
      statusEl.className = 'alert alert-error';
      statusEl.style.display = 'block';
    });
}

// Apply simple theme presets (colors only, no auto-save)
function applyThemePreset(name) {
  var presets = {
    calm: { primary: '#3b82f6', accent: '#0ea5e9' },
    warm: { primary: '#d97706', accent: '#f59e0b' },
    mint: { primary: '#059669', accent: '#10b981' }
  };
  var preset = presets[name];
  if (!preset) return;

  var primaryInput = document.getElementById('theme-primary');
  var primaryPreview = document.getElementById('theme-primary-preview');
  var accentInput = document.getElementById('theme-accent');
  var accentPreview = document.getElementById('theme-accent-preview');
  var statusEl = document.getElementById('theme-status-colors');

  if (primaryInput) primaryInput.value = preset.primary;
  if (primaryPreview) primaryPreview.style.background = preset.primary;
  if (accentInput) accentInput.value = preset.accent;
  if (accentPreview) accentPreview.style.background = preset.accent;

  if (statusEl) {
    statusEl.textContent = L.themeSavedReload;
    statusEl.className = 'alert alert-success';
    statusEl.style.display = 'block';
  }
}

// Theme save (branding only)
function saveThemeBranding() {
  var statusEl = document.getElementById('theme-status-branding');
  var clinicNameEnabled = document.getElementById('clinic-name-enabled').checked;
  var clinicName = document.getElementById('clinic-name').value || '';
  var clinicBrandColor = document.getElementById('clinic-brand-color').value || '';
  var clinicTaglineEnabled = document.getElementById('clinic-tagline-enabled').checked;
  var clinicTagline = document.getElementById('clinic-tagline').value || '';
  var logoScale = document.getElementById('logo-scale').value || '100';

  statusEl.style.display = 'none';
  statusEl.textContent = '';
  statusEl.className = 'alert';

  fetch('/admin/settings/theme/update', {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': CSRF_TOKEN
    },
    body: JSON.stringify({
      scope: 'branding',
      clinic_name_enabled: clinicNameEnabled,
      clinic_name: clinicName,
      clinic_brand_color: clinicBrandColor,
      clinic_tagline_enabled: clinicTaglineEnabled,
      clinic_tagline: clinicTagline,
      logo_scale: logoScale,
      csrf_token: CSRF_TOKEN
    })
  })
    .then(function(res) {
      return res.json().then(function(data) {
        return { res: res, data: data };
      });
    })
    .then(function(result) {
      var res = result.res;
      var data = result.data;
      if (!res.ok || !data.success) {
        var errs = (data.errors || [L.themeSaveFailed]).join(', ');
        statusEl.textContent = errs;
        statusEl.className = 'alert alert-error';
        statusEl.style.display = 'block';
        return;
      }
      statusEl.textContent = L.themeSavedReload;
      statusEl.className = 'alert alert-success';
      statusEl.style.display = 'block';
      window.location.reload();
    })
    .catch(function() {
      statusEl.textContent = L.themeUnexpected;
      statusEl.className = 'alert alert-error';
      statusEl.style.display = 'block';
    });
}

// Internal helper: fetch suggested colors from current logo
function _fetchLogoColorSuggestion(onSuccess, onError) {
  var statusColors = document.getElementById('theme-status-colors');
  var statusBranding = document.getElementById('theme-status-branding');
  if (statusColors) {
    statusColors.style.display = 'none';
    statusColors.textContent = '';
    statusColors.className = 'alert';
  }
  if (statusBranding) {
    statusBranding.style.display = 'none';
    statusBranding.textContent = '';
    statusBranding.className = 'alert';
  }

  fetch("{{ url_for('admin_settings.theme_colors_from_logo') }}", {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': CSRF_TOKEN
    },
    body: JSON.stringify({ csrf_token: CSRF_TOKEN })
  })
    .then(function(res) {
      return res.json().then(function(data) { return { res: res, data: data }; });
    })
    .then(function(result) {
      var res = result.res;
      var data = result.data || {};
      if (!res.ok || !data.success) {
        var message = (data.errors && data.errors.join(', ')) || L.themeUnexpected;
        if (typeof onError === 'function') {
          onError(message, statusColors);
        }
        return;
      }
      if (typeof onSuccess === 'function') {
        onSuccess(data, statusColors, statusBranding);
      }
    })
    .catch(function() {
      if (typeof onError === 'function') {
        onError(L.themeUnexpected, statusColors);
      }
    });
}

// Suggest theme colors from logo for Colors card (no auto-save)
function pickColorsFromLogo() {
  _fetchLogoColorSuggestion(function(data, statusColors) {
    function hexToRgb(hex) {
      if (!hex) return null;
      var h = hex.trim();
      if (h.charAt(0) === '#') h = h.slice(1);
      if (h.length === 3) {
        h = h[0] + h[0] + h[1] + h[1] + h[2] + h[2];
      }
      if (h.length !== 6) return null;
      var r = parseInt(h.substr(0, 2), 16);
      var g = parseInt(h.substr(2, 2), 16);
      var b = parseInt(h.substr(4, 2), 16);
      if (isNaN(r) || isNaN(g) || isNaN(b)) return null;
      return { r: r, g: g, b: b };
    }

    function contrastTextFor(hex) {
      var rgb = hexToRgb(hex);
      if (!rgb) return '#ffffff';
      var lum = 0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b;
      return lum > 180 ? '#111827' : '#ffffff';
    }

    var primaryInput = document.getElementById('theme-primary');
    var primaryPreview = document.getElementById('theme-primary-preview');
    var accentInput = document.getElementById('theme-accent');
    var accentPreview = document.getElementById('theme-accent-preview');
    var textInput = document.getElementById('theme-text-color');
    var textPreview = document.getElementById('theme-text-preview');
    var btnTextInput = document.getElementById('theme-btn-text-color');
    var btnTextPreview = document.getElementById('theme-btn-text-preview');
    var metricInput = document.getElementById('theme-metric-color');
    var metricPreview = document.getElementById('theme-metric-preview');
    var pageBgInput = document.getElementById('theme-page-bg');
    var pageBgPreview = document.getElementById('theme-page-bg-preview');
    var cardBgInput = document.getElementById('theme-card-bg');
    var cardBgPreview = document.getElementById('theme-card-bg-preview');

    if (data.primary_color) {
      if (primaryInput) primaryInput.value = data.primary_color;
      if (primaryPreview) primaryPreview.style.background = data.primary_color;
      // Suggest highlight numbers + button text colors based on primary
      var primaryHex = data.primary_color;
      var metricColor = primaryHex;
      var btnTextColor = contrastTextFor(primaryHex);
      if (metricInput) metricInput.value = metricColor;
      if (metricPreview) metricPreview.style.background = metricColor;
      if (btnTextInput) btnTextInput.value = btnTextColor;
      if (btnTextPreview) btnTextPreview.style.background = btnTextColor;
      // Default text color to a safe dark ink
      if (textInput) textInput.value = '#111827';
      if (textPreview) textPreview.style.background = '#111827';
      // Suggest light page/card tints based on primary
      if (pageBgInput) pageBgInput.value = primaryHex;
      if (pageBgPreview) pageBgPreview.style.background = primaryHex;
      if (cardBgInput) cardBgInput.value = primaryHex;
      if (cardBgPreview) cardBgPreview.style.background = primaryHex;
    }
    if (data.accent_color) {
      if (accentInput) accentInput.value = data.accent_color;
      if (accentPreview) accentPreview.style.background = data.accent_color;
    }
    if (statusColors) {
      statusColors.textContent = L.themeSavedReload;
      statusColors.className = 'alert alert-success';
      statusColors.style.display = 'block';
    }
  }, function(message, statusColors) {
    if (statusColors) {
      statusColors.textContent = message;
      statusColors.className = 'alert alert-error';
      statusColors.style.display = 'block';
    }
  });
}

// Suggest theme colors from logo for Branding card (no auto-save)
function pickBrandingFromLogo() {
  _fetchLogoColorSuggestion(function(data, _statusColors, statusBranding) {
    if (data.clinic_brand_color) {
      var brandInput = document.getElementById('clinic-brand-color');
      var brandPreview = document.getElementById('clinic-brand-preview');
      if (brandInput) brandInput.value = data.clinic_brand_color;
      if (brandPreview) brandPreview.style.background = data.clinic_brand_color;
    }
    if (statusBranding) {
      statusBranding.textContent = L.themeSavedReload;
      statusBranding.className = 'alert alert-success';
      statusBranding.style.display = 'block';
    }
  }, function(message, _statusColors) {
    var statusBranding = document.getElementById('theme-status-branding');
    if (statusBranding) {
      statusBranding.textContent = message;
      statusBranding.className = 'alert alert-error';
      statusBranding.style.display = 'block';
    }
  });
}

// Logo upload
function uploadLogo() {
  var fileInput = document.getElementById('theme-logo');
  var statusEl = document.getElementById('logo-status');
  var preview = document.getElementById('theme-logo-preview');

  statusEl.style.display = 'none';
  statusEl.textContent = '';
  statusEl.className = 'alert';

  if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
    statusEl.textContent = L.fileRequired || 'Please choose a logo file (PNG or JPG).';
    statusEl.className = 'alert alert-error';
    statusEl.style.display = 'block';
    return;
  }

  var formData = new FormData();
  formData.append('logo', fileInput.files[0]);

  fetch("{{ url_for('admin_settings.upload_logo') }}", {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'X-CSRFToken': CSRF_TOKEN
    },
    body: formData
  })
    .then(function(res) {
      return res.json().then(function(data) {
        return { res: res, data: data };
      });
    })
    .then(function(result) {
      var data = result.data;
      if (!result.res.ok || !data.success) {
        statusEl.textContent = (data.errors && data.errors.join(', ')) || (L.logoSaveFailed || 'Upload failed.');
        statusEl.className = 'alert alert-error';
        statusEl.style.display = 'block';
        return;
      }
      statusEl.textContent = L.logoSaved || 'Logo saved.';
      statusEl.className = 'alert alert-success';
      statusEl.style.display = 'block';
      window.location.reload();
    })
    .catch(function() {
      statusEl.textContent = L.logoUnexpected || 'Unexpected error while uploading logo.';
      statusEl.className = 'alert alert-error';
      statusEl.style.display = 'block';
    });
}

// PDF Logo upload
function uploadPdfLogo() {
  var fileInput = document.getElementById('pdf-logo');
  var statusEl = document.getElementById('pdf-logo-status');
  var preview = document.getElementById('pdf-logo-preview');

  statusEl.style.display = 'none';
  statusEl.textContent = '';
  statusEl.className = 'alert';

  if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
    statusEl.textContent = L.fileRequired || 'Please choose a logo file (PNG or JPG).';
    statusEl.className = 'alert alert-error';
    statusEl.style.display = 'block';
    return;
  }

  var formData = new FormData();
  formData.append('logo', fileInput.files[0]);

  fetch("{{ url_for('admin_settings.upload_pdf_logo') }}", {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'X-CSRFToken': CSRF_TOKEN
    },
    body: formData
  })
    .then(function(res) { return res.json().then(function(data) { return { res: res, data: data }; }); })
    .then(function(result) {
      var data = result.data;
      if (!result.res.ok || !data.success) {
        statusEl.textContent = (data.errors && data.errors.join(', ')) || (L.logoSaveFailed || 'Upload failed.');
        statusEl.className = 'alert alert-error';
        statusEl.style.display = 'block';
        return;
      }
      statusEl.textContent = L.logoSaved || 'Logo saved. It will appear on PDF receipts.';
      statusEl.className = 'alert alert-success';
      statusEl.style.display = 'block';
      window.location.reload();
    })
    .catch(function() {
      statusEl.textContent = L.logoUnexpected || 'Unexpected error while uploading logo.';
      statusEl.className = 'alert alert-error';
      statusEl.style.display = 'block';
    });
}

// Data import preview ‚Äì preview only, no DB writes
var __dataAnalyzeState = {
  rows: [],
  pageIndex: 1,
  pageSize: 25,
  search: '',
  dupSearch: '',
  mode: 'safe'
};

function normalizeText(s) {
  return String(s || '').toLowerCase().trim();
}

function getImportMergeMode() {
  var safeToggle = document.getElementById('data-import-never-auto-merge');
  return (safeToggle && safeToggle.checked) ? 'safe' : 'normal';
}

function getAnalyzeMode() {
  return __dataAnalyzeState.mode || 'safe';
}

function setAnalyzeMode(mode, rerun) {
  var m = (mode || 'safe').toLowerCase();
  if (m !== 'safe' && m !== 'normal' && m !== 'aggressive') m = 'safe';
  __dataAnalyzeState.mode = m;

  var buttons = document.querySelectorAll('[data-analyze-mode]');
  for (var i = 0; i < buttons.length; i++) {
    var btn = buttons[i];
    var btnMode = btn.getAttribute('data-analyze-mode');
    if (btnMode === m) {
      btn.classList.remove('btn-secondary');
      btn.classList.add('btn-primary');
    } else {
      btn.classList.remove('btn-primary');
      btn.classList.add('btn-secondary');
    }
  }

  try {
    window.localStorage.setItem('adminDataAnalyzeMode', m);
  } catch (e) {}

  if (rerun) {
    var fileInput = document.getElementById('data-import-file');
    if (fileInput && fileInput.files && fileInput.files.length) {
      previewFirstStableImport();
    }
  }
}

function initAnalyzeFromRows(rows) {
  __dataAnalyzeState.rows = rows || [];
  var controls = document.getElementById('data-analyze-controls');
  if (controls) controls.style.display = 'block';
  __dataAnalyzeState.pageIndex = 1;
}

function getAnalyzeFilteredRows() {
  var rows = __dataAnalyzeState.rows || [];
  var q = normalizeText(__dataAnalyzeState.search);
  if (!q) return rows.slice();

  var filtered = [];
  for (var i = 0; i < rows.length; i++) {
    var r = rows[i] || {};
    var hay = normalizeText(
      (r.short_id || '') + ' ' +
      (r.primary_page_number || '') + ' ' +
      (r.full_name || '') + ' ' +
      (r.phone || '')
    );
    if (hay.indexOf(q) !== -1) filtered.push(r);
  }
  return filtered;
}

function dataAnalyzeGoToPage(n) {
  var pageNum = parseInt(String(n || '1'), 10);
  if (isNaN(pageNum) || pageNum < 1) pageNum = 1;
  __dataAnalyzeState.pageIndex = pageNum;
  renderAnalyzePreview();
}

function renderAnalyzePagination(totalPages) {
  var el = document.getElementById('data-analyze-pagination');
  if (!el) return;
  el.innerHTML = '';

  function makeBtn(label, onClick, disabled, active) {
    var b = document.createElement('button');
    b.type = 'button';
    b.className = active ? 'btn btn-primary btn-sm' : 'btn btn-secondary btn-sm';
    b.textContent = label;
    if (disabled) {
      b.disabled = true;
      b.style.opacity = '0.5';
      b.style.cursor = 'not-allowed';
    } else {
      b.onclick = onClick;
    }
    el.appendChild(b);
  }

  function addEllipsis() {
    var s = document.createElement('span');
    s.className = 'u-text-muted';
    s.style.padding = '0 6px';
    s.textContent = '‚Ä¶';
    el.appendChild(s);
  }

  var current = parseInt(String(__dataAnalyzeState.pageIndex || 1), 10);
  if (isNaN(current) || current < 1) current = 1;
  if (totalPages < 1) totalPages = 1;
  if (current > totalPages) current = totalPages;
  __dataAnalyzeState.pageIndex = current;

  makeBtn('{{ tf("prev", "Prev") }}', function() { dataAnalyzeGoToPage(current - 1); }, current <= 1, false);

  var windowSize = 5;
  var start = Math.max(1, current - 2);
  var end = Math.min(totalPages, start + windowSize - 1);
  start = Math.max(1, end - windowSize + 1);

  if (start > 1) {
    makeBtn('1', function() { dataAnalyzeGoToPage(1); }, false, current === 1);
    if (start > 2) addEllipsis();
  }

  for (var p = start; p <= end; p++) {
    makeBtn(String(p), (function(pp) { return function() { dataAnalyzeGoToPage(pp); }; })(p), false, p === current);
  }

  if (end < totalPages) {
    if (end < totalPages - 1) addEllipsis();
    makeBtn(String(totalPages), function() { dataAnalyzeGoToPage(totalPages); }, false, current === totalPages);
  }

  makeBtn('{{ tf("next", "Next") }}', function() { dataAnalyzeGoToPage(current + 1); }, current >= totalPages, false);

  // Quick jump for large files (clinic owners often want "page 15" directly).
  if (totalPages > 10) {
    var wrap = document.createElement('span');
    wrap.style.display = 'inline-flex';
    wrap.style.alignItems = 'center';
    wrap.style.gap = '6px';
    wrap.style.marginLeft = '10px';

    var inp = document.createElement('input');
    inp.type = 'number';
    inp.min = '1';
    inp.max = String(totalPages);
    inp.value = '';
    inp.placeholder = '{{ tf("page", "Page") }}';
    inp.className = 'form-input';
    inp.style.width = '90px';
    inp.style.padding = '0.35rem 0.5rem';

    var go = document.createElement('button');
    go.type = 'button';
    go.className = 'btn btn-secondary btn-sm';
    go.textContent = '{{ tf("go", "Go") }}';
    go.onclick = function() {
      dataAnalyzeGoToPage(inp.value);
      inp.value = '';
    };

    inp.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        go.click();
      }
    });

    wrap.appendChild(inp);
    wrap.appendChild(go);
    el.appendChild(wrap);
  }
}

function renderAnalyzePreview() {
  var tbody = document.getElementById('data-import-preview-body');
  var status = document.getElementById('data-analyze-status');
  if (!tbody) return;

  var filtered = getAnalyzeFilteredRows();
  var pageSize = parseInt(String(__dataAnalyzeState.pageSize || 25), 10);
  if (isNaN(pageSize) || pageSize < 5) pageSize = 25;
  __dataAnalyzeState.pageSize = pageSize;

  var totalItems = filtered.length;
  var totalPages = Math.max(1, Math.ceil(totalItems / pageSize));
  var pageIndex = parseInt(String(__dataAnalyzeState.pageIndex || 1), 10);
  if (isNaN(pageIndex) || pageIndex < 1) pageIndex = 1;
  if (pageIndex > totalPages) pageIndex = totalPages;
  __dataAnalyzeState.pageIndex = pageIndex;

  var startIdx = (pageIndex - 1) * pageSize;
  var endIdx = Math.min(startIdx + pageSize, totalItems);
  var pageRows = filtered.slice(startIdx, endIdx);

  if (status) {
    var modeLabel = '{{ tf("data_analyze_mode_safe", "Safe") }}';
    var mode = getAnalyzeMode();
    if (mode === 'normal') modeLabel = '{{ tf("data_analyze_mode_normal", "Normal") }}';
    if (mode === 'aggressive') modeLabel = '{{ tf("data_analyze_mode_aggressive", "Aggressive") }}';
    var from = totalItems ? (startIdx + 1) : 0;
    var to = totalItems ? endIdx : 0;
    status.textContent =
      '{{ tf("page", "Page") }}' + ' ' + String(pageIndex) + ' / ' + String(totalPages) +
      ' \u2022 ' + '{{ tf("patients", "Patients") }}' + ': ' + String(totalItems) +
      ' \u2022 ' + '{{ tf("showing", "Showing") }}' + ': ' + String(from) + '-' + String(to) +
      ' \u2022 ' + '{{ tf("data_analyze_mode_label", "Analyze mode") }}' + ': ' + modeLabel;
  }
  renderAnalyzePagination(totalPages);

  tbody.innerHTML = '';
  for (var j = 0; j < pageRows.length; j++) {
    var rr = pageRows[j] || {};
    var tr = document.createElement('tr');
    function addCell(text) {
      var td = document.createElement('td');
      td.textContent = text || '‚Äî';
      tr.appendChild(td);
    }
    addCell(rr.short_id);
    addCell(rr.primary_page_number);
    addCell(rr.full_name);
    addCell(rr.phone);
    addCell(rr.total_fmt);
    addCell(rr.paid_fmt);
    addCell(rr.remaining_fmt);
    addCell(String(rr.payments_count || (rr.payments ? rr.payments.length : 0) || 0));
    var actionsTd = document.createElement('td');
    actionsTd.className = 'table-actions';
    var viewBtn = document.createElement('button');
    viewBtn.type = 'button';
    viewBtn.className = 'btn btn-secondary btn-sm';
    viewBtn.textContent = L.dataImportViewPayments || 'View payments';
    viewBtn.dataset.rowIndex = String(rr.__index != null ? rr.__index : j);
    viewBtn.onclick = function() {
      var idx = parseInt(this.dataset.rowIndex || '0', 10);
      openDataImportModal(idx);
    };
    actionsTd.appendChild(viewBtn);
    tr.appendChild(actionsTd);
    tbody.appendChild(tr);
  }
}

function previewFirstStableImport() {
  var statusEl = document.getElementById('data-import-status');
  var summaryBox = document.getElementById('data-import-summary');
  var summaryText = document.getElementById('data-import-summary-text');
  var tbody = document.getElementById('data-import-preview-body');
  var dupBox = document.getElementById('data-import-duplicates');
  var dupText = document.getElementById('data-import-duplicates-text');
  var dupBody = document.getElementById('data-import-duplicates-body');
  var dupAggressiveToggle = document.getElementById('data-import-duplicates-aggressive-toggle');
  var fileInput = document.getElementById('data-import-file');
  var file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
  if (!statusEl || !summaryBox || !summaryText || !tbody) return;

  if (!file) {
    statusEl.style.display = 'block';
    statusEl.className = 'alert alert-error';
    statusEl.textContent = L.dataImportFileRequired || L.dataImportPreviewFailed || L.genericError;
    return;
  }

  statusEl.style.display = 'block';
  statusEl.className = 'alert';
  statusEl.textContent = L.dataImportLoading || L.genericError;
  summaryBox.style.display = 'none';
  tbody.innerHTML = '';
  if (dupBox) dupBox.style.display = 'none';
  if (dupBody) dupBody.innerHTML = '';
  var formData = new FormData();
  formData.append('excel_file', file);
  formData.append('csrf_token', CSRF_TOKEN);
  formData.append('analyze_mode', getAnalyzeMode());
  var fetchOptions = {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'X-CSRFToken': CSRF_TOKEN
    },
    body: formData
  };

  fetch("{{ url_for('admin_settings.preview_first_stable_import') }}", fetchOptions)
    .then(function(res) {
      return res.json().then(function(data) {
        return { res: res, data: data };
      });
    })
    .then(function(result) {
      var res = result.res;
      var data = result.data || {};
      if (!res.ok || !data.success) {
        statusEl.className = 'alert alert-error';
        statusEl.textContent = (data.errors && data.errors.join(', ')) || (L.dataImportPreviewFailed || L.genericError);
        return;
      }

      statusEl.className = 'alert alert-success';
      statusEl.textContent = data.message || (L.dataImportPreviewOk || L.themeSavedReload);

      var rows = data.rows || [];
      // Store rows globally so the payments modal can use them.
      for (var ii = 0; ii < rows.length; ii++) {
        if (rows[ii]) rows[ii].__index = ii;
      }
      window.__dataImportRows = rows;
      var counts = data.counts || {};
      var duplicatesSafe = data.duplicates || [];
      var duplicatesAggressive = data.duplicates_aggressive || [];
      window.__dataImportDuplicatesSafe = duplicatesSafe;
      window.__dataImportDuplicatesAggressive = duplicatesAggressive;
      if (!rows.length) {
        summaryText.textContent = L.dataImportNoRows || '';
        summaryBox.style.display = 'block';
        return;
      }

      var parts = [];
      if (typeof counts.total_rows === 'number') {
        parts.push((L.dataImportTotalRows || 'Rows') + ': ' + counts.total_rows);
      }
      if (typeof counts.patients === 'number') {
        parts.push((L.dataImportPatients || 'Patients') + ': ' + counts.patients);
      }
      if (typeof counts.payments === 'number') {
        parts.push((L.dataImportPaymentRows || L.dataImportPayments || 'Payment rows') + ': ' + counts.payments);
      }
      if (typeof counts.zero_entries === 'number' && counts.zero_entries) {
        parts.push((L.dataImportZeroEntries || 'Zero-amount entries') + ': ' + counts.zero_entries);
      }
      if (typeof counts.skipped_rows === 'number' && counts.skipped_rows) {
        parts.push((L.dataImportSkippedRows || 'Skipped empty rows') + ': ' + counts.skipped_rows);
      }
      if (typeof counts.missing_file === 'number' && counts.missing_file) {
        parts.push((L.dataImportMissingFile || 'Missing file number') + ': ' + counts.missing_file);
      }
      if (typeof counts.missing_name === 'number' && counts.missing_name) {
        parts.push((L.dataImportMissingName || 'Missing name') + ': ' + counts.missing_name);
      }
      summaryText.textContent = parts.join(' ‚Ä¢ ');

      initAnalyzeFromRows(rows);
      renderAnalyzePreview();
      summaryBox.style.display = 'block';

      // Duplicates section
      if (dupBox && dupBody) {
        dupBox.style.display = 'block';
        if (dupAggressiveToggle) {
          dupAggressiveToggle.checked = false;
          dupAggressiveToggle.onchange = function() {
            var useAggressive = !!this.checked;
            renderDuplicatesTable(useAggressive);
          };
        }
        renderDuplicatesTable(false);
      }
    })
    .catch(function() {
      statusEl.className = 'alert alert-error';
      statusEl.textContent = L.dataImportUnexpected || L.genericError;
    });
}

// Data import commit ‚Äì writes to clinic database
function commitDataImport() {
  var statusEl = document.getElementById('data-import-commit-status');
  var reportLink = document.getElementById('data-import-report-link');
  var afterBox = document.getElementById('data-import-after-import');
  var fileInput = document.getElementById('data-import-file');
  var file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
  var skipDup = document.getElementById('data-import-skip-duplicates');
  var importZero = document.getElementById('data-import-import-zero');
  var neverAutoMerge = document.getElementById('data-import-never-auto-merge');
  if (!statusEl) return;

  if (reportLink) reportLink.style.display = 'none';
  if (afterBox) afterBox.style.display = 'none';
  window.__lastImportReportName = null;

  if (!file) {
    statusEl.style.display = 'block';
    statusEl.className = 'alert alert-error';
    statusEl.textContent = L.dataImportFileRequired || L.dataImportCommitFailed || L.genericError;
    return;
  }

  var confirmText = L.dataImportCommitConfirm || 'This will write to your clinic database. Continue?';
  if (!window.confirm(confirmText)) return;

  statusEl.style.display = 'block';
  statusEl.className = 'alert';
  statusEl.textContent = L.dataImportCommitRunning || L.loading || 'Importing...';

  var formData = new FormData();
  formData.append('excel_file', file);
  formData.append('csrf_token', CSRF_TOKEN);
  formData.append('merge_mode', getImportMergeMode());
  formData.append('skip_duplicates', (skipDup && skipDup.checked) ? '1' : '0');
  formData.append('import_zero_entries', (importZero && importZero.checked) ? '1' : '0');
  formData.append('never_auto_merge', (neverAutoMerge && neverAutoMerge.checked) ? '1' : '0');

  fetch("{{ url_for('admin_settings.commit_data_import') }}", {
    method: 'POST',
    credentials: 'same-origin',
    headers: { 'X-CSRFToken': CSRF_TOKEN },
    body: formData
  })
    .then(function(res) {
      return res.json().then(function(data) {
        return { res: res, data: data };
      });
    })
    .then(function(result) {
      var res = result.res;
      var data = result.data || {};
      if (!res.ok || !data.success) {
        statusEl.className = 'alert alert-error';
        statusEl.textContent = (data.errors && data.errors.join(', ')) || (L.dataImportCommitFailed || L.genericError);
        return;
      }
      statusEl.className = 'alert alert-success';
      var msg = data.message || (L.dataImportCommitOk || 'Import completed.');
      var r = data.result || {};
      var opts = data.options || {};
      var dataTab = document.getElementById('data-tab');
      var mode = dataTab ? (dataTab.getAttribute('data-data-mode') || 'simple') : 'simple';
      var isAdvanced = (mode === 'advanced');
      var parts = [];
      if (typeof r.unique_patients_in_file === 'number') {
        parts.push((L.dataImportPatientsInFile || '{{ tf("data_import_patients_in_file", "Patients in file") }}') + ': ' + r.unique_patients_in_file);
      }
      if (typeof r.created_patients === 'number' && r.created_patients) {
        parts.push('{{ tf("patients", "Patients") }}: +' + r.created_patients);
      }
      if (typeof r.matched_patients === 'number' && r.matched_patients) {
        parts.push('{{ tf("data_import_matched_patients", "Patients matched") }}: ' + r.matched_patients);
      }
      if (typeof r.created_patients_no_payments_imported === 'number' && r.created_patients_no_payments_imported) {
        parts.push((L.dataImportPatientsNoPaymentsImported || '{{ tf("data_import_patients_no_payments_imported", "Patients created (no payments imported)") }}') + ': ' + r.created_patients_no_payments_imported);
      }
      if (typeof r.inserted_money_payments === 'number' && r.inserted_money_payments) {
        parts.push('{{ tf("data_import_payments", "Payments") }}: +' + r.inserted_money_payments);
      }
      if (typeof r.inserted_zero_entries === 'number' && r.inserted_zero_entries) {
        parts.push('{{ tf("data_import_zero_entries", "Zero-amount entries") }}: +' + r.inserted_zero_entries);
      }
      if (typeof r.skipped_duplicates === 'number' && r.skipped_duplicates) {
        parts.push('{{ tf("data_import_skip_duplicates_short", "Duplicates skipped") }}: ' + r.skipped_duplicates);
      }
      if (typeof r.skipped_edited_existing_rows === 'number' && r.skipped_edited_existing_rows) {
        parts.push('{{ tf("data_import_skip_edited_rows_short", "Edited old rows skipped") }}: ' + r.skipped_edited_existing_rows);
      }
      if (typeof r.skipped_zero_entries === 'number' && r.skipped_zero_entries) {
        parts.push((L.dataImportSkippedZeroEntries || '{{ tf("data_import_skipped_zero_entries", "Skipped zero-amount rows") }}') + ': ' + r.skipped_zero_entries);
      }
      if (typeof r.page_number_conflicts === 'number' && r.page_number_conflicts) {
        parts.push('{{ tf("data_import_page_conflicts", "Page number conflicts") }}: ' + r.page_number_conflicts);
      }
      var optParts = [];
      if (opts && typeof opts.skip_duplicates === 'boolean') optParts.push('{{ tf("data_import_opt_skip_duplicates", "Skip duplicates") }}: ' + (opts.skip_duplicates ? '‚úì' : '‚Äî'));
      if (opts && typeof opts.import_zero_entries === 'boolean') optParts.push('{{ tf("data_import_opt_import_zero_entries", "Import zero-amount entries") }}: ' + (opts.import_zero_entries ? '‚úì' : '‚Äî'));
      if (opts && typeof opts.never_auto_merge === 'boolean') optParts.push('{{ tf("data_import_opt_safe_merge", "Safe merge") }}: ' + (opts.never_auto_merge ? '‚úì' : '‚Äî'));
      if (opts && opts.merge_mode) optParts.unshift('{{ tf("mode", "Mode") }}: ' + String(opts.merge_mode));

      var html = '<div style="font-weight:600;">' + escapeHtml(msg) + '</div>';
      if (parts.length) html += '<div style="margin-top:0.35rem;">' + parts.map(escapeHtml).join(' \u2022 ') + '</div>';
      if (optParts.length) html += '<div class="u-text-muted" style="margin-top:0.35rem;">' + optParts.map(escapeHtml).join(' \u2022 ') + '</div>';
      if (isAdvanced && opts && (opts.raw_skip_duplicates != null || opts.raw_import_zero_entries != null || opts.raw_never_auto_merge != null)) {
        var rawParts = [];
        if (opts.raw_skip_duplicates != null) rawParts.push('skip_duplicates=' + String(opts.raw_skip_duplicates));
        if (opts.raw_import_zero_entries != null) rawParts.push('import_zero_entries=' + String(opts.raw_import_zero_entries));
        if (opts.raw_never_auto_merge != null) rawParts.push('safe_merge=' + String(opts.raw_never_auto_merge));
        if (rawParts.length) {
          html += '<div class="u-text-muted" style="margin-top:0.25rem;font-size:0.82rem;">' + rawParts.map(escapeHtml).join(' \u2022 ') + '</div>';
        }
      }
      statusEl.innerHTML = html;
      if (reportLink && data.report_name) {
        reportLink.href = "{{ url_for('admin_settings.download_import_report', name='__NAME__') }}".replace('__NAME__', data.report_name);
        reportLink.style.display = 'inline-flex';
        window.__lastImportReportName = data.report_name;
        if (afterBox) afterBox.style.display = 'block';
      }
    })
    .catch(function() {
      statusEl.className = 'alert alert-error';
      statusEl.textContent = L.dataImportCommitFailed || L.genericError;
    });
}

function preflightDataImport() {
  var statusEl = document.getElementById('data-import-commit-status');
  var fileInput = document.getElementById('data-import-file');
  var file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
  var skipDup = document.getElementById('data-import-skip-duplicates');
  var importZero = document.getElementById('data-import-import-zero');
  var neverAutoMerge = document.getElementById('data-import-never-auto-merge');
  if (!statusEl) return;

  if (!file) {
    statusEl.style.display = 'block';
    statusEl.className = 'alert alert-error';
    statusEl.textContent = L.dataImportFileRequired || L.dataImportPreflightFailed || L.genericError;
    return;
  }

  statusEl.style.display = 'block';
  statusEl.className = 'alert';
  statusEl.textContent = L.dataImportPreflightRunning || L.loading || 'Checking...';

  var formData = new FormData();
  formData.append('excel_file', file);
  formData.append('csrf_token', CSRF_TOKEN);
  formData.append('merge_mode', getImportMergeMode());
  formData.append('skip_duplicates', (skipDup && skipDup.checked) ? '1' : '0');
  formData.append('import_zero_entries', (importZero && importZero.checked) ? '1' : '0');
  formData.append('never_auto_merge', (neverAutoMerge && neverAutoMerge.checked) ? '1' : '0');

  fetch("{{ url_for('admin_settings.preflight_data_import') }}", {
    method: 'POST',
    credentials: 'same-origin',
    headers: { 'X-CSRFToken': CSRF_TOKEN },
    body: formData
  })
    .then(function(res) {
      return res.json().then(function(data) {
        return { res: res, data: data };
      });
    })
    .then(function(result) {
      var res = result.res;
      var data = result.data || {};
      if (!res.ok || !data.success) {
        statusEl.className = 'alert alert-error';
        statusEl.textContent = (data.errors && data.errors.join(', ')) || (L.dataImportPreflightFailed || L.genericError);
        return;
      }
      var r = data.result || {};
      var counts = data.counts || {};
      var opts = data.options || {};
      var dataTab = document.getElementById('data-tab');
      var mode = dataTab ? (dataTab.getAttribute('data-data-mode') || 'simple') : 'simple';
      var isAdvanced = (mode === 'advanced');

      // Keep the green box simple. Most clinic owners only need to know what will be added.
      var mainParts = [];
      if (typeof r.unique_patients_in_file === 'number') {
        mainParts.push((L.dataImportPatientsInFile || '{{ tf("data_import_patients_in_file", "Patients in file") }}') + ': ' + r.unique_patients_in_file);
      }
      if (typeof counts.total_rows === 'number') {
        mainParts.push((L.dataImportTotalRows || '{{ tf("data_import_total_rows", "Rows") }}') + ': ' + counts.total_rows);
      }
      if (typeof r.would_create_patients === 'number') {
        mainParts.push('{{ tf("data_import_new_patients", "New patients") }}' + ': +' + r.would_create_patients);
      }
      if (typeof r.would_insert_money_payments === 'number') {
        mainParts.push('{{ tf("data_import_new_payments", "New payments") }}' + ': +' + r.would_insert_money_payments);
      }
      if (typeof r.would_skip_duplicates === 'number' && r.would_skip_duplicates) {
        mainParts.push('{{ tf("data_import_skip_duplicates_short", "Duplicates skipped") }}' + ': ' + r.would_skip_duplicates);
      }
      if (typeof r.would_skip_edited_existing_rows === 'number' && r.would_skip_edited_existing_rows) {
        mainParts.push('{{ tf("data_import_skip_edited_rows_short", "Edited old rows skipped") }}' + ': ' + r.would_skip_edited_existing_rows);
      }
      if (typeof r.would_insert_zero_entries === 'number' && r.would_insert_zero_entries) {
        mainParts.push('{{ tf("data_import_zero_entries", "Zero-amount entries") }}' + ': +' + r.would_insert_zero_entries);
      }

      var detailParts = [];
      if (typeof counts.payments === 'number') {
        detailParts.push((L.dataImportPaymentRows || '{{ tf("data_import_payment_rows", "Payment rows") }}') + ': ' + counts.payments);
      }
      // Show "zero entries in file" only when zero entries are being imported,
      // otherwise we show the explicit "skipped zero rows" line.
      if (opts && opts.import_zero_entries && typeof counts.zero_entries === 'number' && counts.zero_entries) {
        detailParts.push('{{ tf("data_import_zero_entries_in_file", "Zero-amount entries (in file)") }}' + ': ' + counts.zero_entries);
      }
      if (typeof counts.skipped_rows === 'number' && counts.skipped_rows) {
        detailParts.push((L.dataImportSkippedRows || '{{ tf("data_import_skipped_rows", "Skipped empty rows") }}') + ': ' + counts.skipped_rows);
      }
      if (typeof r.would_match_patients === 'number' && r.would_match_patients) {
        detailParts.push('{{ tf("data_import_matched_patients", "Patients matched") }}' + ': ' + r.would_match_patients);
      }
      if (typeof r.page_number_conflicts === 'number' && r.page_number_conflicts) {
        detailParts.push('{{ tf("data_import_page_conflicts", "Page number conflicts") }}' + ': ' + r.page_number_conflicts);
      }
      var unknownDates = (typeof r.unknown_dates_left_blank === 'number')
        ? r.unknown_dates_left_blank
        : r.unknown_dates_fallback_to_today;
      if (typeof unknownDates === 'number' && unknownDates) {
        detailParts.push('{{ tf("data_import_unknown_dates", "Unknown dates (left blank)") }}' + ': ' + unknownDates);
      }

      statusEl.className = 'alert alert-success';
      var html = '<div style="font-weight:600;">' + (L.dataImportPreflightOk || 'Check completed.') + '</div>';
      html += '<div style="margin-top:0.35rem;">' + (mainParts.length ? mainParts.join(' \u2022 ') : '') + '</div>';
      if (opts) {
        // Always show the options used (so clinic owners can trust the result).
        var optParts = [];
        if (opts.merge_mode) optParts.push('{{ tf("mode", "Mode") }}: ' + String(opts.merge_mode));
        if (typeof opts.skip_duplicates === 'boolean') optParts.push('{{ tf("data_import_opt_skip_duplicates", "Skip duplicates") }}: ' + (opts.skip_duplicates ? '‚úì' : '‚Äî'));
        if (typeof opts.import_zero_entries === 'boolean') optParts.push('{{ tf("data_import_opt_import_zero_entries", "Import zero-amount entries") }}: ' + (opts.import_zero_entries ? '‚úì' : '‚Äî'));
        if (typeof opts.never_auto_merge === 'boolean') optParts.push('{{ tf("data_import_opt_safe_merge", "Safe merge") }}: ' + (opts.never_auto_merge ? '‚úì' : '‚Äî'));
        if (optParts.length) {
          html += '<div class="u-text-muted" style="margin-top:0.35rem;">' + optParts.join(' \u2022 ') + '</div>';
        }

        // Debug line: shows raw values received by the server (helps catch UI wiring bugs).
        if (opts.raw_skip_duplicates != null || opts.raw_import_zero_entries != null || opts.raw_never_auto_merge != null) {
          var rawParts = [];
          if (opts.raw_skip_duplicates != null) rawParts.push('skip_duplicates=' + String(opts.raw_skip_duplicates));
          if (opts.raw_import_zero_entries != null) rawParts.push('import_zero_entries=' + String(opts.raw_import_zero_entries));
          if (opts.raw_never_auto_merge != null) rawParts.push('safe_merge=' + String(opts.raw_never_auto_merge));
          if (rawParts.length) {
            html += '<div class="u-text-muted" style="margin-top:0.25rem;font-size:0.82rem;">' + rawParts.join(' \u2022 ') + '</div>';
          }
        }
      }
      if (isAdvanced && detailParts.length) {
        html += '<details style="margin-top:0.4rem;"><summary style="cursor:pointer;">{{ tf("details", "Details") }}</summary>';
        // Add explicit ‚Äúwill import / will skip‚Äù lines so it‚Äôs not confusing.
        var effectParts = [];
        if (opts && typeof opts.skip_duplicates === 'boolean') {
          var dups = (typeof r.would_skip_duplicates === 'number') ? r.would_skip_duplicates : 0;
          var editedRows = (typeof r.would_skip_edited_existing_rows === 'number') ? r.would_skip_edited_existing_rows : 0;
          var skipSummary = '{{ tf("data_import_opt_skip_duplicates", "Skip duplicates") }}: ';
          if (opts.skip_duplicates) {
            skipSummary += '‚úì (' + String(dups);
            if (editedRows) skipSummary += ', {{ tf("data_import_skip_edited_rows_short", "Edited old rows skipped") }}: ' + String(editedRows);
            skipSummary += ')';
          } else {
            skipSummary += '‚Äî';
          }
          effectParts.push(skipSummary);
        }
        if (opts && typeof opts.import_zero_entries === 'boolean') {
          var willZero = (typeof r.would_insert_zero_entries === 'number') ? r.would_insert_zero_entries : 0;
          var skipZero = (typeof r.would_skip_zero_entries === 'number') ? r.would_skip_zero_entries : 0;
          if (opts.import_zero_entries) {
            effectParts.push('{{ tf("data_import_zero_entries", "Zero-amount entries") }}: +' + String(willZero));
          } else {
            effectParts.push((L.dataImportSkippedZeroEntries || '{{ tf("data_import_skipped_zero_entries", "Skipped zero-amount rows") }}') + ': ' + String(skipZero));
          }
        }

        html += '<div class="u-text-muted" style="margin-top:0.35rem;">';
        if (effectParts.length) html += effectParts.join(' \u2022 ') + ' \u2022 ';
        html += detailParts.join(' \u2022 ') + '</div></details>';
      }
      statusEl.innerHTML = html;
    })
    .catch(function() {
      statusEl.className = 'alert alert-error';
      statusEl.textContent = L.dataImportPreflightFailed || L.genericError;
    });
}

function renderDuplicatesTable(useAggressive) {
  var dupBox = document.getElementById('data-import-duplicates');
  var dupText = document.getElementById('data-import-duplicates-text');
  var dupBody = document.getElementById('data-import-duplicates-body');
  if (!dupBox || !dupBody) return;

  var safeList = window.__dataImportDuplicatesSafe || [];
  var aggressiveList = window.__dataImportDuplicatesAggressive || [];
  var activeList = useAggressive ? aggressiveList : safeList;
  var q = normalizeText(__dataAnalyzeState.dupSearch);

  dupBody.innerHTML = '';

  if (!activeList.length) {
    var msg;
    if (!safeList.length && !aggressiveList.length) {
      msg = L.dataImportDuplicatesNoneGlobal ||
        'No possible duplicate patients were found in this Excel file.';
    } else if (useAggressive) {
      msg = L.dataImportDuplicatesNoneAggressive ||
        'No possible duplicates found even with aggressive (name‚Äëonly) matching.';
    } else {
      msg = L.dataImportDuplicatesNone ||
        'No possible duplicates found with safe name + phone matching.';
    }
    if (dupText) dupText.textContent = msg;
    return;
  }

  var groupCount = activeList.length;
  var patientCount = 0;
  for (var gi = 0; gi < activeList.length; gi++) {
    patientCount += (activeList[gi].candidates || []).length;
  }

  if (dupText) {
    var intro = useAggressive
      ? (L.dataImportDuplicatesIntroAggressive ||
         'Aggressive suggestions: patients with the same first and second name (phone ignored).')
      : (L.dataImportDuplicatesIntro ||
         'Safe suggestions: patients with the same first and second name and same or missing phone.');
    var countsLabel = (L.dataImportDuplicatesCounts || 'Suggestions')
      + ': ' + String(groupCount) + ' groups ¬∑ ' + String(patientCount) + ' patients';
    dupText.textContent = intro + ' ' + countsLabel;
  }

  for (var g = 0; g < activeList.length; g++) {
    var group = activeList[g] || {};
    var cands = group.candidates || [];
    if (q) {
      var kept = [];
      for (var jj = 0; jj < cands.length; jj++) {
        var cc = cands[jj] || {};
        var hay = normalizeText((group.display_name || group.first_two_name || '') + ' ' + (cc.full_name || '') + ' ' + (cc.phone || '') + ' ' + (cc.short_id || cc.raw_file || '') + ' ' + (cc.primary_page_number || ''));
        if (hay.indexOf(q) !== -1) kept.push(cc);
      }
      cands = kept;
    }
    if (!cands.length) continue;
    for (var j = 0; j < cands.length; j++) {
      var c = cands[j] || {};
      var trDup = document.createElement('tr');
      function addDupCell(text) {
        var td = document.createElement('td');
        td.textContent = text || '‚Äî';
        trDup.appendChild(td);
      }
      addDupCell(group.display_name || group.first_two_name || '‚Äî');
      var idPart = (c.short_id || c.raw_file || '‚Äî');
      var phonePart = c.phone || '‚Äî';
      addDupCell(idPart + ' / ' + phonePart);
      addDupCell(String(c.payments_count || 0));
      addDupCell(c.total_fmt || '');
      addDupCell(c.remaining_fmt || '');
      dupBody.appendChild(trDup);
    }
  }
}

function escapeHtml(str) {
  return String(str || '').replace(/[&<>"']/g, function(m) {
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
  });
}

function auditShowStatus(message, kind, details) {
  var box = document.getElementById('audit-payments-status');
  if (!box) return;
  box.style.display = message ? 'block' : 'none';
  box.className = 'alert ' + (kind || 'alert-info');
  if (!message) {
    box.textContent = '';
    return;
  }
  if (details) {
    box.innerHTML =
      '<div>' + escapeHtml(message) + '</div>' +
      '<details style="margin-top:0.4rem;">' +
        '<summary style="cursor:pointer;">{{ tf("details", "Details") }}</summary>' +
        '<pre style="margin:8px 0 0; white-space:pre-wrap; background:#0b1020; color:#e5e7eb; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,.08);">' +
          escapeHtml(details) +
        '</pre>' +
      '</details>';
  } else {
    box.textContent = message || '';
  }
}

function auditPaymentsQueryParams() {
  var from = (document.getElementById('audit-from') || {}).value || '';
  var to = (document.getElementById('audit-to') || {}).value || '';
  var user = (document.getElementById('audit-user') || {}).value || '';
  var action = (document.getElementById('audit-action') || {}).value || '';
  var params = new URLSearchParams();
  params.set('limit', '300');
  if (from) params.set('from', from);
  if (to) params.set('to', to);
  if (user) params.set('user', user);
  if (action) params.set('action', action);
  return params;
}

function auditPaymentsReset() {
  var ids = ['audit-from', 'audit-to', 'audit-user', 'audit-action'];
  ids.forEach(function(id){
    var el = document.getElementById(id);
    if (!el) return;
    if (el.tagName === 'SELECT') el.value = '';
    else el.value = '';
  });
  auditPaymentsLoad();
}

function auditPaymentsLoad() {
  var body = document.getElementById('audit-payments-body');
  if (!body) return;
  body.innerHTML = '<tr><td colspan="8" class="u-text-muted">{{ tf("loading", "Loading...") }}</td></tr>';
  auditShowStatus('', '', '');

  var url = '{{ url_for("admin_settings.audit_payments_json") }}' + '?' + auditPaymentsQueryParams().toString();
  fetch(url, { credentials: 'same-origin' })
    .then(function(r){
      if (!r.ok) {
        return r.text().then(function(t){
          return { __http_error: true, status: r.status, body: t || '' };
        });
      }
      return r.json().catch(function(){
        return { __parse_error: true, status: r.status };
      });
    })
    .then(function(data){
      if (data && data.__http_error) {
        auditShowStatus('{{ tf("audit_load_failed", "Could not load audit log.") }}' + ' (HTTP ' + String(data.status || '') + ')', 'alert-error', data.body || '');
        body.innerHTML = '';
        return;
      }
      if (data && data.__parse_error) {
        auditShowStatus('{{ tf("audit_load_failed", "Could not load audit log.") }}', 'alert-error', 'Invalid JSON response from server.');
        body.innerHTML = '';
        return;
      }
      if (!data || !data.success) {
        var err = '';
        try {
          if (data && data.errors && data.errors.length) err = String(data.errors[0] || '');
        } catch (e) {}
        auditShowStatus('{{ tf("audit_load_failed", "Could not load audit log.") }}', 'alert-error', err);
        body.innerHTML = '';
        return;
      }
      if (data.warnings && data.warnings.length) {
        auditShowStatus('{{ tf("warnings", "Warnings") }}', 'alert-warning', String((data.warnings || []).join('\\n') || ''));
      }
      var rows = data.items || [];
      window.__auditPaymentsRows = rows;
      if (!rows.length) {
        body.innerHTML = '<tr><td colspan="8" class="u-text-muted">{{ tf("no_results", "No results.") }}</td></tr>';
        return;
      }
      var html = [];
      rows.forEach(function(it, idx){
        var meta = it.meta || {};
        var amount = (typeof meta.amount_cents === 'number') ? (meta.amount_cents / 100).toFixed(2) : '‚Äî';
        var patient = meta.patient_id || '‚Äî';
        var method = meta.method || '‚Äî';
        var action = it.action || '';
        var actionLabel = action;
        if (action === 'payment_create') actionLabel = '{{ tf("audit_payment_create", "Payment added") }}';
        if (action === 'payment_update') actionLabel = '{{ tf("audit_payment_update", "Payment updated") }}';
        if (action === 'payment_delete') actionLabel = '{{ tf("audit_payment_delete", "Payment deleted") }}';

        var dt = it.ts_display || '';
        if (!dt) dt = it.ts || '';
        html.push('<tr>' +
          '<td>' + escapeHtml(dt || '') + '</td>' +
          '<td>' + escapeHtml(it.actor_username || '‚Äî') + '</td>' +
          '<td>' + escapeHtml(actionLabel) + '</td>' +
          '<td>' + escapeHtml(it.patient_display || patient) + '</td>' +
          '<td style="text-align:right;">' + escapeHtml(amount) + '</td>' +
          '<td>' + escapeHtml(method) + '</td>' +
          '<td>' + escapeHtml(it.entity_id || '') + '</td>' +
          '<td><button class="btn btn-secondary" type="button" onclick="openAuditRowModal(' + idx + ')">{{ tf("view", "View") }}</button></td>' +
        '</tr>');
      });
      body.innerHTML = html.join('');
    })
    .catch(function(){
      auditShowStatus('{{ tf("audit_load_failed", "Could not load audit log.") }}', 'alert-error', '');
      body.innerHTML = '';
    });
}

function auditPaymentsExportCsv() {
  var url = '{{ url_for("admin_settings.audit_payments_csv") }}' + '?' + auditPaymentsQueryParams().toString();
  window.location.href = url;
}

function auditPrivacyShowStatus(message, kind) {
  var box = document.getElementById('audit-privacy-status');
  if (!box) return;
  box.style.display = message ? 'block' : 'none';
  box.className = 'alert ' + (kind || 'alert-info');
  box.textContent = message || '';
}

function auditPrivacyLoad() {
  var enabledEl = document.getElementById('audit-snapshots-enabled');
  var retentionEl = document.getElementById('audit-snapshots-retention');
  var countEl = document.getElementById('audit-snapshot-count');
  if (!enabledEl || !retentionEl || !countEl) return;

  auditPrivacyShowStatus('', '');
  countEl.textContent = '';

  fetch('{{ url_for("admin_settings.audit_payments_privacy_json") }}', { credentials: 'same-origin' })
    .then(function(r){ return r.json(); })
    .then(function(data){
      if (!data || !data.success) {
        auditPrivacyShowStatus('{{ tf("audit_privacy_load_failed", "Could not load privacy settings.") }}', 'alert-error');
        return;
      }
      enabledEl.checked = Boolean(data.enabled);
      var days = String(data.retention_days == null ? 180 : data.retention_days);
      if (!Array.from(retentionEl.options).some(function(o){ return o.value === days; })) {
        days = '180';
      }
      retentionEl.value = days;

      var count = (typeof data.snapshot_count === 'number') ? data.snapshot_count : 0;
      if (data.snapshots_available === false) {
        countEl.textContent = '{{ tf("audit_snapshots_table_missing", "Snapshots table not found. Run Run-Migrations.bat.") }}';
      } else {
        countEl.textContent = '{{ tf("audit_snapshots_count", "Saved snapshots") }}' + ': ' + count;
      }

      var summaryEl = document.getElementById('audit-privacy-summary');
      if (summaryEl) {
        var retentionText = (days === '0') ? '{{ tf("forever", "Forever") }}' : (days + ' {{ tf("days", "days") }}');
        summaryEl.textContent =
          '{{ tf("audit_snapshots_title", "Patient snapshots") }}' +
          ' \u2022 ' +
          '{{ tf("audit_snapshots_count", "Saved snapshots") }}' + ': ' + count +
          ' \u2022 ' +
          '{{ tf("audit_snapshots_retention", "Keep snapshots for") }}' + ' ' + retentionText;
      }
    })
    .catch(function(){
      auditPrivacyShowStatus('{{ tf("audit_privacy_load_failed", "Could not load privacy settings.") }}', 'alert-error');
    });
}

// --- Confirm modal (audit actions) ---
window.__confirmOnOk = null;
function openConfirmModal(opts) {
  opts = opts || {};
  var modal = document.getElementById('confirm-modal');
  if (!modal) return;
  var titleEl = document.getElementById('confirm-modal-title');
  var msgEl = document.getElementById('confirm-modal-message');
  var okEl = document.getElementById('confirm-modal-ok');
  if (titleEl) titleEl.textContent = opts.title || '{{ tf("confirm", "Confirm") }}';
  if (msgEl) msgEl.textContent = opts.message || '';
  if (okEl) {
    okEl.textContent = opts.okLabel || '{{ tf("confirm", "Confirm") }}';
    okEl.className = 'btn ' + (opts.danger ? 'btn-danger' : 'btn-primary');
  }
  window.__confirmOnOk = (typeof opts.onOk === 'function') ? opts.onOk : null;
  modal.classList.add('active');
}

function closeConfirmModal() {
  var modal = document.getElementById('confirm-modal');
  if (!modal) return;
  modal.classList.remove('active');
  window.__confirmOnOk = null;
}

function confirmModalOk() {
  var fn = window.__confirmOnOk;
  closeConfirmModal();
  try { if (fn) fn(); } catch (e) {}
}

function auditPrivacyBackfillConfirm() {
  openConfirmModal({
    title: '{{ tf("audit_confirm_backfill_title", "Backfill snapshots") }}',
    message: '{{ tf("audit_confirm_backfill_msg", "This will create snapshots for old audit entries where the patient still exists. Continue?") }}',
    okLabel: '{{ tf("confirm", "Confirm") }}',
    danger: false,
    onOk: auditPrivacyBackfill
  });
}

function auditPrivacyPurgeExpiredConfirm() {
  openConfirmModal({
    title: '{{ tf("audit_confirm_purge_expired_title", "Purge expired snapshots") }}',
    message: '{{ tf("audit_confirm_purge_expired_msg", "This will delete snapshots older than your retention setting. Audit events will remain. Continue?") }}',
    okLabel: '{{ tf("confirm", "Confirm") }}',
    danger: true,
    onOk: auditPrivacyPurgeExpired
  });
}

function auditPrivacyPurgeAllConfirm() {
  openConfirmModal({
    title: '{{ tf("audit_confirm_purge_all_title", "Purge all snapshots") }}',
    message: '{{ tf("audit_confirm_purge_all_msg", "This will delete ALL saved snapshots. Audit events will remain. Continue?") }}',
    okLabel: '{{ tf("audit_confirm_purge_all_ok", "Delete all") }}',
    danger: true,
    onOk: auditPrivacyPurgeAll
  });
}

// --- Audit row modal ---
function fmtMoney(cents) {
  if (typeof cents !== 'number') return '‚Äî';
  return (cents / 100).toFixed(2);
}

function actionLabel(action) {
  var a = String(action || '').trim().toLowerCase();
  if (a === 'payment_create') return '{{ tf("audit_payment_create", "Payment added") }}';
  if (a === 'payment_update') return '{{ tf("audit_payment_update", "Payment updated") }}';
  if (a === 'payment_delete') return '{{ tf("audit_payment_delete", "Payment deleted") }}';
  return a || '';
}

function openAuditRowModal(index) {
  var rows = window.__auditPaymentsRows || [];
  var it = rows[index];
  if (!it) return;
  var action = String(it.action || '').trim().toLowerCase();
  var meta = it.meta || {};
  var modal = document.getElementById('audit-row-modal');
  var titleEl = document.getElementById('audit-row-title');
  var bodyEl = document.getElementById('audit-row-body');
  if (!modal || !bodyEl) return;

  var dt = it.ts_display || it.ts || '';
  var head = actionLabel(it.action) + (dt ? (' \u2022 ' + dt) : '') + (it.actor_username ? (' \u2022 ' + it.actor_username) : '');
  if (titleEl) titleEl.textContent = head;

  function row(label, beforeVal, afterVal) {
    return '<tr>' +
      '<th style="width:180px;">' + escapeHtml(label) + '</th>' +
      '<td style="width:40%;">' + escapeHtml(beforeVal) + '</td>' +
      '<td style="width:40%;">' + escapeHtml(afterVal) + '</td>' +
    '</tr>';
  }

  var beforeUnknown = '{{ tf("audit_prev_not_recorded", "(previous value not recorded)") }}';
  var changes = '';
  var showBeforeAfter = (action === 'payment_update');
  var beforeTitle = showBeforeAfter ? '{{ tf("before", "Before") }}' : '{{ tf("current", "Current") }}';
  var afterTitle = showBeforeAfter ? '{{ tf("after", "After") }}' : '{{ tf("current", "Current") }}';

  var prevPaidAt = meta.prev_paid_at || beforeUnknown;
  var prevAmount = (typeof meta.prev_amount_cents === 'number') ? fmtMoney(meta.prev_amount_cents) : beforeUnknown;
  var prevMethod = meta.prev_method || beforeUnknown;
  var prevDoctor = meta.prev_doctor_label || meta.prev_doctor_id || beforeUnknown;
  var prevDiscount = (typeof meta.prev_discount_cents === 'number') ? fmtMoney(meta.prev_discount_cents) : beforeUnknown;
  var prevTotal = (typeof meta.prev_total_amount_cents === 'number') ? fmtMoney(meta.prev_total_amount_cents) : beforeUnknown;
  var prevRemaining = (typeof meta.prev_remaining_cents === 'number') ? fmtMoney(meta.prev_remaining_cents) : beforeUnknown;
  var prevVisit = meta.prev_visit_type || beforeUnknown;

  var curPaidAt = meta.paid_at || '‚Äî';
  var curAmount = (typeof meta.amount_cents === 'number') ? fmtMoney(meta.amount_cents) : '‚Äî';
  var curMethod = meta.method || '‚Äî';
  var curDoctor = meta.doctor_label || (meta.doctor_id || '‚Äî');
  var curDiscount = (typeof meta.discount_cents === 'number') ? fmtMoney(meta.discount_cents) : '‚Äî';
  var curTotal = (typeof meta.total_amount_cents === 'number') ? fmtMoney(meta.total_amount_cents) : '‚Äî';
  var curRemaining = (typeof meta.remaining_cents === 'number') ? fmtMoney(meta.remaining_cents) : '‚Äî';
  var curVisit = meta.visit_type || '‚Äî';

  changes += '<table class="table-compact"><thead><tr>' +
    '<th></th><th>' + escapeHtml(beforeTitle) + '</th><th>' + escapeHtml(afterTitle) + '</th>' +
    '</tr></thead><tbody>';

  if (showBeforeAfter) {
    changes += row('{{ tf("paid_at", "Paid at") }}', prevPaidAt, curPaidAt);
    changes += row('{{ tf("amount", "Amount") }}', prevAmount, curAmount);
    changes += row('{{ tf("method", "Method") }}', prevMethod, curMethod);
    changes += row('{{ tf("doctor", "Doctor") }}', prevDoctor, curDoctor);
    changes += row('{{ tf("discount", "Discount") }}', prevDiscount, curDiscount);
    changes += row('{{ tf("total", "Total") }}', prevTotal, curTotal);
    changes += row('{{ tf("remaining", "Remaining") }}', prevRemaining, curRemaining);
    changes += row('{{ tf("visit_type", "Visit type") }}', prevVisit, curVisit);
  } else {
    changes += row('{{ tf("paid_at", "Paid at") }}', '', curPaidAt);
    changes += row('{{ tf("amount", "Amount") }}', '', curAmount);
    changes += row('{{ tf("method", "Method") }}', '', curMethod);
    changes += row('{{ tf("doctor", "Doctor") }}', '', curDoctor);
    changes += row('{{ tf("discount", "Discount") }}', '', curDiscount);
    changes += row('{{ tf("total", "Total") }}', '', curTotal);
    changes += row('{{ tf("remaining", "Remaining") }}', '', curRemaining);
    changes += row('{{ tf("visit_type", "Visit type") }}', '', curVisit);
  }
  changes += '</tbody></table>';

  var metaJson = '';
  try { metaJson = JSON.stringify(meta || {}, null, 2); } catch (e) { metaJson = ''; }

  bodyEl.innerHTML =
    '<div class="u-text-muted" style="margin-bottom:8px;">' +
      '<div><strong>{{ tf("patient", "Patient") }}:</strong> ' + escapeHtml(it.patient_display || '‚Äî') + '</div>' +
      '<div><strong>{{ tf("payment_id", "Payment ID") }}:</strong> ' + escapeHtml(it.entity_id || '') + '</div>' +
    '</div>' +
    '<div style="margin:10px 0; font-weight:700;">{{ tf("changes", "Changes") }}</div>' +
    changes +
    '<details style="margin-top:12px;">' +
      '<summary style="cursor:pointer; font-weight:700;">{{ tf("technical_details", "Technical details") }}</summary>' +
      '<pre class="audit-pre">' + escapeHtml(metaJson) + '</pre>' +
    '</details>';

  modal.classList.add('active');
}

function closeAuditRowModal() {
  var modal = document.getElementById('audit-row-modal');
  if (modal) modal.classList.remove('active');
}

// --- Snapshots viewer ---
window.__auditSnapshotsOffset = 0;
window.__auditSnapshotsLimit = 200;
window.__auditSnapshotsHasMore = false;

function auditSnapshotsShowStatus(message, kind) {
  var box = document.getElementById('audit-snapshots-status');
  if (!box) return;
  box.style.display = message ? 'block' : 'none';
  box.className = 'alert ' + (kind || 'alert-info');
  box.textContent = message || '';
}

function auditSnapshotsOpen() {
  var modal = document.getElementById('audit-snapshots-modal');
  if (!modal) return;
  modal.classList.add('active');
  auditSnapshotsLoad(true);
}

function closeAuditSnapshotsModal() {
  var modal = document.getElementById('audit-snapshots-modal');
  if (modal) modal.classList.remove('active');
}

function auditSnapshotsReset() {
  var ids = ['audit-snapshots-q', 'audit-snapshots-from', 'audit-snapshots-to'];
  ids.forEach(function(id){
    var el = document.getElementById(id);
    if (el) el.value = '';
  });
  auditSnapshotsLoad(true);
}

function auditSnapshotsLoad(reset) {
  if (reset) window.__auditSnapshotsOffset = 0;
  var body = document.getElementById('audit-snapshots-body');
  var pagerText = document.getElementById('audit-snapshots-pager-text');
  if (!body) return;
  body.innerHTML = '<tr><td colspan="4" class="u-text-muted">{{ tf("loading", "Loading...") }}</td></tr>';
  auditSnapshotsShowStatus('', '');

  var q = (document.getElementById('audit-snapshots-q') || {}).value || '';
  var from = (document.getElementById('audit-snapshots-from') || {}).value || '';
  var to = (document.getElementById('audit-snapshots-to') || {}).value || '';

  var params = new URLSearchParams();
  params.set('limit', String(window.__auditSnapshotsLimit));
  params.set('offset', String(window.__auditSnapshotsOffset));
  if (q) params.set('q', q);
  if (from) params.set('from', from);
  if (to) params.set('to', to);

  var url = '{{ url_for("admin_settings.audit_payments_snapshots_json") }}' + '?' + params.toString();
  fetch(url, { credentials: 'same-origin' })
    .then(function(r){ return r.json(); })
    .then(function(data){
      if (!data || !data.success) {
        auditSnapshotsShowStatus('{{ tf("audit_snapshots_load_failed", "Could not load snapshots.") }}', 'alert-error');
        body.innerHTML = '';
        return;
      }
      if (data.snapshots_available === false) {
        auditSnapshotsShowStatus('{{ tf("audit_snapshots_table_missing", "Snapshots table not found. Run Run-Migrations.bat.") }}', 'alert-error');
      }
      var rows = data.items || [];
      window.__auditSnapshotsHasMore = Boolean(data.has_more);
      var html = [];
      if (!rows.length) {
        body.innerHTML = '<tr><td colspan="4" class="u-text-muted">{{ tf("no_results", "No results.") }}</td></tr>';
      } else {
        rows.forEach(function(it){
          var dt = it.ts_display || it.ts || '';
          var action = actionLabel(it.action);
          var patient = it.patient_display || '{{ tf("unknown_patient", "Unknown patient") }}';
          html.push('<tr>' +
            '<td>' + escapeHtml(dt) + '</td>' +
            '<td>' + escapeHtml(action) + '</td>' +
            '<td>' + escapeHtml(it.payment_id || '') + '</td>' +
            '<td>' + escapeHtml(patient) + '</td>' +
          '</tr>');
        });
        body.innerHTML = html.join('');
      }

      var start = window.__auditSnapshotsOffset + 1;
      var end = window.__auditSnapshotsOffset + rows.length;
      if (pagerText) {
        pagerText.textContent = rows.length ? (start + '‚Äì' + end) : '';
      }

      var prevBtn = document.getElementById('audit-snapshots-prev');
      var nextBtn = document.getElementById('audit-snapshots-next');
      if (prevBtn) prevBtn.disabled = window.__auditSnapshotsOffset <= 0;
      if (nextBtn) nextBtn.disabled = !window.__auditSnapshotsHasMore;
    })
    .catch(function(){
      auditSnapshotsShowStatus('{{ tf("audit_snapshots_load_failed", "Could not load snapshots.") }}', 'alert-error');
      body.innerHTML = '';
    });
}

function auditSnapshotsPrev() {
  window.__auditSnapshotsOffset = Math.max(0, window.__auditSnapshotsOffset - window.__auditSnapshotsLimit);
  auditSnapshotsLoad(false);
}

function auditSnapshotsNext() {
  if (!window.__auditSnapshotsHasMore) return;
  window.__auditSnapshotsOffset = window.__auditSnapshotsOffset + window.__auditSnapshotsLimit;
  auditSnapshotsLoad(false);
}

function auditPrivacySave() {
  var enabledEl = document.getElementById('audit-snapshots-enabled');
  var retentionEl = document.getElementById('audit-snapshots-retention');
  if (!enabledEl || !retentionEl) return;

  auditPrivacyShowStatus('{{ tf("saving", "Saving...") }}', 'alert-info');
  fetch('{{ url_for("admin_settings.audit_payments_privacy_save") }}', {
    method: 'POST',
    credentials: 'same-origin',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
    body: JSON.stringify({
      csrf_token: CSRF_TOKEN,
      enabled: Boolean(enabledEl.checked),
      retention_days: parseInt(retentionEl.value || '180', 10)
    })
  })
    .then(function(r){ return r.json(); })
    .then(function(data){
      if (!data || !data.success) {
        auditPrivacyShowStatus('{{ tf("audit_privacy_save_failed", "Save failed.") }}', 'alert-error');
        return;
      }
      auditPrivacyShowStatus('{{ tf("audit_privacy_saved", "Saved.") }}', 'alert-ok');
      auditPrivacyLoad();
    })
    .catch(function(){
      auditPrivacyShowStatus('{{ tf("audit_privacy_save_failed", "Save failed.") }}', 'alert-error');
    });
}

function auditPrivacyBackfill() {
  auditPrivacyShowStatus('{{ tf("audit_snapshots_backfill_running", "Backfilling...") }}', 'alert-info');
  fetch('{{ url_for("admin_settings.audit_payments_privacy_backfill") }}', {
    method: 'POST',
    credentials: 'same-origin',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
    body: JSON.stringify({ csrf_token: CSRF_TOKEN })
  })
    .then(function(r){ return r.json(); })
    .then(function(data){
      if (!data || !data.success) {
        auditPrivacyShowStatus('{{ tf("audit_snapshots_backfill_failed", "Backfill failed.") }}', 'alert-error');
        return;
      }
      var msg = '{{ tf("audit_snapshots_backfill_ok", "Backfill completed.") }}' + ' (' + (data.inserted || 0) + ')';
      auditPrivacyShowStatus(msg, 'alert-ok');
      auditPrivacyLoad();
      auditPaymentsLoad();
    })
    .catch(function(){
      auditPrivacyShowStatus('{{ tf("audit_snapshots_backfill_failed", "Backfill failed.") }}', 'alert-error');
    });
}

function auditPrivacyPurgeExpired() {
  auditPrivacyShowStatus('{{ tf("audit_snapshots_purge_running", "Purging...") }}', 'alert-info');
  fetch('{{ url_for("admin_settings.audit_payments_privacy_purge_expired") }}', {
    method: 'POST',
    credentials: 'same-origin',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
    body: JSON.stringify({ csrf_token: CSRF_TOKEN })
  })
    .then(function(r){ return r.json(); })
    .then(function(data){
      if (!data || !data.success) {
        auditPrivacyShowStatus('{{ tf("audit_snapshots_purge_failed", "Purge failed.") }}', 'alert-error');
        return;
      }
      var msg = '{{ tf("audit_snapshots_purge_ok", "Purged snapshots.") }}' + ' (' + (data.deleted || 0) + ')';
      auditPrivacyShowStatus(msg, 'alert-ok');
      auditPrivacyLoad();
      auditPaymentsLoad();
    })
    .catch(function(){
      auditPrivacyShowStatus('{{ tf("audit_snapshots_purge_failed", "Purge failed.") }}', 'alert-error');
    });
}

function auditPrivacyPurgeAll() {
  auditPrivacyShowStatus('{{ tf("audit_snapshots_purge_running", "Purging...") }}', 'alert-info');
  fetch('{{ url_for("admin_settings.audit_payments_privacy_purge_all") }}', {
    method: 'POST',
    credentials: 'same-origin',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
    body: JSON.stringify({ csrf_token: CSRF_TOKEN })
  })
    .then(function(r){ return r.json(); })
    .then(function(data){
      if (!data || !data.success) {
        auditPrivacyShowStatus('{{ tf("audit_snapshots_purge_failed", "Purge failed.") }}', 'alert-error');
        return;
      }
      var msg = '{{ tf("audit_snapshots_purge_ok", "Purged snapshots.") }}' + ' (' + (data.deleted || 0) + ')';
      auditPrivacyShowStatus(msg, 'alert-ok');
      auditPrivacyLoad();
      auditPaymentsLoad();
    })
    .catch(function(){
      auditPrivacyShowStatus('{{ tf("audit_snapshots_purge_failed", "Purge failed.") }}', 'alert-error');
    });
}

var __dbDupMergeLeft = null;
var __dbDupMergeRight = null;
var __dbDupMode = 'normal';
var __repDupMode = 'safe';

function coerceDupMode(modeOrBool, fallback) {
  if (typeof modeOrBool === 'string') return modeOrBool;
  if (modeOrBool === true) return 'aggressive';
  if (modeOrBool === false) return 'safe';
  return fallback || 'safe';
}

function renderDuplicateGroups(targetListEl, targetTextEl, groups, mode, groupKeyPrefix, emptyText) {
  if (!targetListEl) return;

  mode = coerceDupMode(mode, 'safe');

  if (!groups || !groups.length) {
    targetListEl.innerHTML = '<div class="u-text-muted">' + (emptyText || (L.dbDuplicatesNone || 'No duplicates found.')) + '</div>';
    if (targetTextEl) targetTextEl.textContent = emptyText || (L.dbDuplicatesNone || 'No duplicates found.');
    return;
  }

  var groupCount = groups.length;
  var patientCount = 0;
  for (var gi = 0; gi < groups.length; gi++) {
    patientCount += (groups[gi] && groups[gi].candidates) ? groups[gi].candidates.length : 0;
  }

  if (targetTextEl) {
    var countsText = '{{ tf("data_import_duplicates_counts", "Suggestions") }}' + ': ' + groupCount + ' {{ tf("groups", "groups") }} ¬∑ ' + patientCount + ' {{ tf("patients", "Patients") }}';
    var dataTab = document.getElementById('data-tab');
    var isSimpleUi = dataTab && (dataTab.getAttribute('data-data-mode') === 'simple');
    if (isSimpleUi) {
      targetTextEl.textContent = countsText;
    } else {
      var modeText =
        (mode === 'aggressive')
          ? '{{ tf("data_import_db_duplicates_mode_aggressive", "Aggressive mode: match by name only.") }}'
          : ((mode === 'normal')
            ? '{{ tf("data_import_db_duplicates_mode_normal", "Normal mode: match by name + same phone/page (or missing phone).") }}'
            : '{{ tf("data_import_db_duplicates_mode_safe", "Safe mode: match by name + same/missing phone.") }}');
      targetTextEl.textContent = modeText + ' ' + countsText;
    }
  }

  function makeChip(text, cls) {
    var s = document.createElement('span');
    s.className = 'dup-chip' + (cls ? (' ' + cls) : '');
    s.textContent = text;
    return s;
  }

  function normalizeDigits(s) {
    return String(s || '').replace(/[^0-9]/g, '');
  }

  function metaLine(c) {
    var fileNo = (c && c.short_id) ? String(c.short_id) : '';
    var phone = (c && c.phone) ? String(c.phone) : '';
    var pageNo = (c && c.primary_page_number) ? String(c.primary_page_number) : '';
    var meta = [];
    if (fileNo) meta.push('{{ tf("file_number", "File number") }}: ' + fileNo);
    if (pageNo) meta.push('{{ tf("page_number", "Page number") }}: ' + pageNo);
    if (phone) meta.push('{{ tf("phone", "Phone") }}: ' + phone);
    return meta.join(' ¬∑ ') || '‚Äî';
  }

  targetListEl.innerHTML = '';

  for (var i = 0; i < groups.length; i++) {
    var g = groups[i] || {};
    var cands = g.candidates || [];
    if (cands.length < 2) continue;

    // Group-level hints
    var phoneCounts = {};
    var pageCounts = {};
    var anyMissingPhone = false;
    var anyMissingFile = false;
    var anyMissingPage = false;
    for (var k = 0; k < cands.length; k++) {
      var c0 = cands[k] || {};
      var ph = normalizeDigits(c0.phone || '');
      var pg = String(c0.primary_page_number || '').trim();
      var fn = String(c0.short_id || '').trim();
      if (!ph) anyMissingPhone = true;
      else phoneCounts[ph] = (phoneCounts[ph] || 0) + 1;
      if (!fn) anyMissingFile = true;
      if (!pg) anyMissingPage = true;
      else pageCounts[pg] = (pageCounts[pg] || 0) + 1;
    }
    var phoneKeys = Object.keys(phoneCounts);
    var pageKeys = Object.keys(pageCounts);
    var phoneVaries = phoneKeys.length > 1;
    var pageVaries = pageKeys.length > 1;
    var hasSamePhone = false;
    var hasSamePage = false;
    for (var pk = 0; pk < phoneKeys.length; pk++) {
      if ((phoneCounts[phoneKeys[pk]] || 0) >= 2) { hasSamePhone = true; break; }
    }
    for (var pgk = 0; pgk < pageKeys.length; pgk++) {
      if ((pageCounts[pageKeys[pgk]] || 0) >= 2) { hasSamePage = true; break; }
    }

    var card = document.createElement('div');
    card.className = 'card';
    card.style.marginTop = '0.75rem';

    var header = document.createElement('div');
    header.className = 'card-header';
    header.style.justifyContent = 'space-between';

    var title = document.createElement('div');
    title.className = 'card-title';
    title.style.fontSize = '0.95rem';
    title.textContent = (g.display_name || g.first_two_name || '‚Äî') + ' (' + cands.length + ')';
    header.appendChild(title);

    var chips = document.createElement('div');
    chips.className = 'dup-chips';
    // Why suggested (keep these visible in Simple mode)
    if (mode === 'aggressive') {
      chips.appendChild(makeChip('{{ tf("dup_reason_name_only", "Name only") }}', 'info'));
    } else {
      if (hasSamePage) chips.appendChild(makeChip('{{ tf("dup_reason_same_page", "Same page") }}', 'info'));
      if (hasSamePhone) chips.appendChild(makeChip('{{ tf("dup_reason_same_phone", "Same phone") }}', 'info'));
      if (!hasSamePhone && anyMissingPhone) chips.appendChild(makeChip(L.dupMissingPhone || 'Missing phone', 'info'));
    }

    // Extra hints (Advanced mode only)
    if (phoneVaries) { var ch1 = makeChip(L.dupPhoneDiffers || 'Phone differs', 'warn'); ch1.classList.add('data-advanced'); chips.appendChild(ch1); }
    if (pageVaries) { var ch2 = makeChip(L.dupPageDiffers || 'Page differs', 'warn'); ch2.classList.add('data-advanced'); chips.appendChild(ch2); }
    if (anyMissingFile) { var ch3 = makeChip(L.dupMissingFile || 'Missing file #', 'info'); ch3.classList.add('data-advanced'); chips.appendChild(ch3); }
    if (anyMissingPage) { var ch4 = makeChip(L.dupMissingPage || 'Missing page #', 'info'); ch4.classList.add('data-advanced'); chips.appendChild(ch4); }
    header.appendChild(chips);

    card.appendChild(header);

    var groupName = groupKeyPrefix + '-keep-' + String(i);
    var grid = document.createElement('div');
    grid.className = 'dup-group-grid';

    for (var j = 0; j < cands.length; j++) {
      var c = cands[j] || {};
      var candCard = document.createElement('div');
      candCard.className = 'dup-cand-card';

      var top = document.createElement('div');
      top.className = 'dup-cand-top';

      var left = document.createElement('div');
      var name = (c && c.full_name) ? c.full_name : '‚Äî';
      left.innerHTML =
        '<div style="font-weight:700">' + escapeHtml(name) + '</div>' +
        '<div class="u-text-muted" style="font-size:0.85rem">' + escapeHtml(metaLine(c)) + '</div>';
      top.appendChild(left);

      var keepWrap = document.createElement('label');
      keepWrap.className = 'checkbox-item';
      keepWrap.style.margin = '0';
      keepWrap.style.whiteSpace = 'nowrap';

      var keepRadio = document.createElement('input');
      keepRadio.type = 'radio';
      keepRadio.name = groupName;
      keepRadio.value = c.id || '';
      if (j === 0) keepRadio.checked = true;
      keepWrap.appendChild(keepRadio);

      var keepTxt = document.createElement('span');
      keepTxt.textContent = '{{ tf("keep_file", "Keep this file") }}';
      keepWrap.appendChild(keepTxt);
      top.appendChild(keepWrap);

      candCard.appendChild(top);

      var actions = document.createElement('div');
      actions.className = 'actions-row';
      actions.style.justifyContent = 'flex-end';

      var openBtn = document.createElement('button');
      openBtn.type = 'button';
      openBtn.className = 'btn secondary';
      openBtn.textContent = '{{ tf("open", "Open") }}';
      (function(pid) {
        openBtn.addEventListener('click', function() {
          if (!pid) return;
          openPatientQuickView(pid);
        });
      })(c.id || '');
      actions.appendChild(openBtn);

      var mergeBtn = document.createElement('button');
      mergeBtn.type = 'button';
      mergeBtn.className = 'btn btn-primary';
      mergeBtn.textContent = L.dupMergeIntoKeep || '{{ tf("dup_merge_into_keep", "Merge into kept file") }}';
      (function(groupIndex, candObj, grpName) {
        mergeBtn.addEventListener('click', function() {
          var keepSel = document.querySelector('input[name="' + grpName + '"]:checked');
          var keepId = keepSel ? keepSel.value : '';
          if (!keepId || !candObj || !candObj.id) return;
          if (keepId === candObj.id) return;
          var keepObj = null;
          var listCands = groups[groupIndex] ? (groups[groupIndex].candidates || []) : [];
          for (var kk = 0; kk < listCands.length; kk++) {
            if ((listCands[kk] || {}).id === keepId) { keepObj = listCands[kk]; break; }
          }
          if (!keepObj) return;
          openDbDupMergeModal(keepObj, candObj);
        });
      })(i, c, groupName);
      actions.appendChild(mergeBtn);

      candCard.appendChild(actions);
      grid.appendChild(candCard);
    }

    card.appendChild(grid);
    targetListEl.appendChild(card);
  }
}

function loadDbDuplicates(mode) {
  mode = coerceDupMode(mode, 'normal');
  __dbDupMode = mode;
  var list = document.getElementById('data-db-duplicates-list');
  var text = document.getElementById('data-db-duplicates-text');
  if (!list) return;
  list.innerHTML = '<div class="u-text-muted">' + (L.dbDuplicatesLoading || 'Scanning...') + '</div>';
  if (text) text.textContent = L.dbDuplicatesLoading || 'Scanning...';

  var url = "{{ url_for('admin_settings.data_import_duplicates_db') }}" + '?mode=' + encodeURIComponent(mode);
  fetch(url, { credentials: 'same-origin' })
    .then(function(res) { return res.json().then(function(data){ return {res:res, data:data}; }); })
    .then(function(result) {
      var res = result.res;
      var data = result.data || {};
      if (!res.ok || !data.success) {
        list.innerHTML = '<div class="u-text-muted">' + (L.genericError || 'Error') + '</div>';
        if (text) text.textContent = (data.errors && data.errors.join(', ')) || (L.genericError || 'Error');
        return;
      }
      var groups = data.duplicates || [];
      if (!groups.length) {
        list.innerHTML = '<div class="u-text-muted">' + (L.dbDuplicatesNone || 'No duplicates found.') + '</div>';
        if (text) text.textContent = L.dbDuplicatesNone || 'No duplicates found.';
        return;
      }
      renderDuplicateGroups(list, text, groups, mode, 'db-dup', (L.dbDuplicatesNone || 'No duplicates found.'));
    })
    .catch(function() {
      list.innerHTML = '<div class="u-text-muted">' + (L.genericError || 'Error') + '</div>';
      if (text) text.textContent = L.genericError || 'Error';
    });
}

function loadReportDuplicates(mode) {
  mode = coerceDupMode(mode, 'safe');
  __repDupMode = mode;
  var reportName = window.__lastImportReportName || '';
  var list = document.getElementById('data-import-report-dups-list');
  var text = document.getElementById('data-import-report-dups-text');
  if (!list) return;

  if (!reportName) {
    list.innerHTML = '<div class="u-text-muted">' + (L.dataImportReportMissing || L.genericError || 'Error') + '</div>';
    return;
  }

  list.innerHTML = '<div class="u-text-muted">' + (L.dataImportReportDupsLoading || L.dbDuplicatesLoading || 'Scanning...') + '</div>';

  var url = "{{ url_for('admin_settings.data_import_report_duplicates_db', name='__NAME__') }}".replace('__NAME__', reportName) + '?mode=' + encodeURIComponent(mode);
  fetch(url, { credentials: 'same-origin' })
    .then(function(res) { return res.json().then(function(data){ return {res:res, data:data}; }); })
    .then(function(result) {
      var res = result.res;
      var data = result.data || {};
      if (!res.ok || !data.success) {
        list.innerHTML = '<div class="u-text-muted">' + ((data.errors && data.errors.join(', ')) || (L.genericError || 'Error')) + '</div>';
        return;
      }
      var groups = data.duplicates || [];
      if (!groups.length) {
        list.innerHTML = '<div class="u-text-muted">' + (L.dataImportReportDupsNone || L.dbDuplicatesNone || 'No duplicates found.') + '</div>';
        return;
      }
      renderDuplicateGroups(
        list,
        text,
        groups,
        mode,
        'rep-dup',
        (L.dataImportReportDupsNone || L.dbDuplicatesNone || 'No duplicates found.')
      );
    })
    .catch(function() {
      list.innerHTML = '<div class="u-text-muted">' + (L.genericError || 'Error') + '</div>';
    });
}

function openDbDupMergeModal(left, right) {
  __dbDupMergeLeft = left || null;
  __dbDupMergeRight = right || null;

  var modal = document.getElementById('db-dup-merge-modal');
  var alert = document.getElementById('db-dup-merge-alert');
  var leftBox = document.getElementById('db-dup-merge-left');
  var rightBox = document.getElementById('db-dup-merge-right');
  var keepLeft = document.getElementById('db-dup-keep-left');
  var keepRight = document.getElementById('db-dup-keep-right');
  var diag = document.getElementById('db-dup-merge-diag');

  if (alert) alert.style.display = 'none';
  if (diag) diag.checked = false;
  if (keepLeft) keepLeft.checked = true;
  if (keepRight) keepRight.checked = false;

  function render(box, c) {
    if (!box) return;
    var name = (c && c.full_name) ? c.full_name : '‚Äî';
    var fileNo = (c && c.short_id) ? c.short_id : '';
    var phone = (c && c.phone) ? c.phone : '';
    var pageNo = (c && c.primary_page_number) ? c.primary_page_number : '';
    var lines = [];
    lines.push('<div style="font-weight:700;font-size:1rem">' + escapeHtml(name) + '</div>');
    var meta = [];
    if (fileNo) meta.push('{{ tf("file_number", "File number") }}: ' + fileNo);
    if (pageNo) meta.push('{{ tf("page_number", "Page number") }}: ' + pageNo);
    if (phone) meta.push('{{ tf("phone", "Phone") }}: ' + phone);
    if (meta.length) lines.push('<div class="u-text-muted" style="margin-top:0.25rem;">' + escapeHtml(meta.join(' ¬∑ ')) + '</div>');
    box.innerHTML = lines.join('');
  }

  render(leftBox, __dbDupMergeLeft);
  render(rightBox, __dbDupMergeRight);

  if (modal) modal.classList.add('active');
}

function closeDbDupMergeModal() {
  var modal = document.getElementById('db-dup-merge-modal');
  if (modal) modal.classList.remove('active');
  __dbDupMergeLeft = null;
  __dbDupMergeRight = null;
}

function openPatientQuickView(pid) {
  var modal = document.getElementById('patient-quickview-modal');
  var title = document.getElementById('patient-quickview-title');
  var openLink = document.getElementById('patient-quickview-open');
  var body = document.getElementById('patient-quickview-body');
  if (!modal || !body) return;

  var url = "{{ url_for('patients.patient_detail', pid='__PID__') }}".replace('__PID__', pid || '');
  var fragUrl = "{{ url_for('patients.patient_quickview', pid='__PID__') }}".replace('__PID__', pid || '');
  if (openLink) openLink.href = url;
  if (title) title.textContent = '{{ tf("patient_file", "Patient file") }}';
  modal.classList.add('active');

  body.className = 'u-text-muted';
  body.textContent = '{{ tf("loading", "Loading...") }}';
  fetch(fragUrl, { credentials: 'same-origin' })
    .then(function(res) { return res.text().then(function(txt){ return {res:res, txt:txt}; }); })
    .then(function(result) {
      if (!result.res.ok) {
        body.className = 'u-text-muted';
        body.textContent = L.genericError || 'Error';
        return;
      }
      body.className = '';
      body.innerHTML = result.txt || '';
    })
    .catch(function() {
      body.className = 'u-text-muted';
      body.textContent = L.genericError || 'Error';
    });
}

function closePatientQuickView() {
  var modal = document.getElementById('patient-quickview-modal');
  var body = document.getElementById('patient-quickview-body');
  if (body) { body.className = 'u-text-muted'; body.textContent = ''; }
  if (modal) modal.classList.remove('active');
}

function submitDbDupMerge() {
  var alert = document.getElementById('db-dup-merge-alert');
  var keep = document.querySelector('input[name="db-dup-keep"]:checked');
  var diag = document.getElementById('db-dup-merge-diag');
  var btn = document.getElementById('db-dup-merge-submit');

  if (!__dbDupMergeLeft || !__dbDupMergeRight) return;

  var keepSide = keep ? keep.value : 'left';
  var target = (keepSide === 'right') ? __dbDupMergeRight : __dbDupMergeLeft;
  var source = (keepSide === 'right') ? __dbDupMergeLeft : __dbDupMergeRight;
  var mergeDiag = diag && diag.checked;

  if (!confirm(L.dbDupMergeConfirm || 'Merge?')) return;

  if (alert) alert.style.display = 'none';
  if (btn) { btn.disabled = true; btn.textContent = L.saving || 'Saving...'; }

  fetch("{{ url_for('admin_settings.merge_db_duplicate_patients') }}", {
    method: 'POST',
    credentials: 'same-origin',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
    body: JSON.stringify({
      csrf_token: CSRF_TOKEN,
      source_id: source.id,
      target_id: target.id,
      merge_diag: mergeDiag ? 1 : 0
    })
  })
    .then(function(res){ return res.json().then(function(data){ return {res:res, data:data}; }); })
    .then(function(result) {
      var res = result.res;
      var data = result.data || {};
      if (!res.ok || !data.success) {
        if (alert) {
          alert.textContent = (data.errors && data.errors.join(', ')) || (L.dbDupMergeFailed || L.genericError);
          alert.style.display = 'block';
        }
        return;
      }
      closeDbDupMergeModal();
      loadDbDuplicates(__dbDupMode || 'normal');
    })
    .catch(function() {
      if (alert) {
        alert.textContent = L.dbDupMergeFailed || L.genericError;
        alert.style.display = 'block';
      }
    })
    .then(function() {
      if (btn) { btn.disabled = false; btn.textContent = '{{ tf("merge_now", "Merge") }}'; }
    });
}

function formatBytes(bytes) {
  var n = Number(bytes || 0);
  if (!n) return '0 B';
  var units = ['B','KB','MB','GB'];
  var u = 0;
  while (n >= 1024 && u < units.length - 1) { n /= 1024; u++; }
  return n.toFixed(u ? 1 : 0) + ' ' + units[u];
}

function refreshBackups() {
  var body = document.getElementById('db-backups-body');
  var status = document.getElementById('db-backups-status');
  if (!body) return;
  if (status) status.style.display = 'none';
  body.innerHTML = '<tr><td colspan="3" class="u-text-muted">' + (L.dbBackupLoading || 'Loading...') + '</td></tr>';
  fetch("{{ url_for('admin_settings.list_db_backups') }}", { credentials: 'same-origin' })
    .then(function(res){ return res.json().then(function(data){ return {res:res, data:data}; }); })
    .then(function(result) {
      var res = result.res;
      var data = result.data || {};
      if (!res.ok || !data.success) {
        body.innerHTML = '<tr><td colspan="3" class="u-text-muted">' + (L.dbBackupsLoadFailed || L.genericError || 'Error') + '</td></tr>';
        return;
      }
      var backups = data.backups || [];
      if (!backups.length) {
        body.innerHTML = '<tr><td colspan="3" class="u-text-muted">{{ tf("db_backups_empty", "No backups yet.") }}</td></tr>';
        return;
      }
      body.innerHTML = '';
      for (var i = 0; i < backups.length; i++) {
        var b = backups[i] || {};
        var tr = document.createElement('tr');
        var tdName = document.createElement('td');
        tdName.textContent = b.name || '‚Äî';
        tr.appendChild(tdName);
        var tdSize = document.createElement('td');
        tdSize.textContent = formatBytes(b.bytes || 0);
        tr.appendChild(tdSize);
        var tdActions = document.createElement('td');
        tdActions.className = 'table-actions';
        var link = document.createElement('a');
        link.className = 'btn secondary';
        link.href = "{{ url_for('admin_settings.download_db_backup', name='__NAME__') }}".replace('__NAME__', b.name || '');
        link.textContent = '{{ tf("download", "Download") }}';
        tdActions.appendChild(link);
        var restoreBtn = document.createElement('button');
        restoreBtn.type = 'button';
        restoreBtn.className = 'btn btn-danger';
        restoreBtn.textContent = '{{ tf("restore", "Restore") }}';
        (function(backupName) {
          restoreBtn.addEventListener('click', function() { restoreBackup(backupName); });
        })(b.name || '');
        tdActions.appendChild(restoreBtn);
        tr.appendChild(tdActions);
        body.appendChild(tr);
      }
    })
    .catch(function() {
      body.innerHTML = '<tr><td colspan="3" class="u-text-muted">' + (L.dbBackupsLoadFailed || L.genericError || 'Error') + '</td></tr>';
    });
}

function restoreBackup(name) {
  var status = document.getElementById('db-backups-status');
  if (!name) return;
  var confirmText = L.dbBackupRestoreConfirm || 'Restore this backup?';
  if (!window.confirm(confirmText)) return;
  if (status) {
    status.style.display = 'block';
    status.className = 'alert';
    status.textContent = L.dbBackupRestoreRunning || 'Restoring...';
  }
  fetch("{{ url_for('admin_settings.restore_db_backup') }}", {
    method: 'POST',
    credentials: 'same-origin',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
    body: JSON.stringify({ csrf_token: CSRF_TOKEN, name: name })
  })
    .then(function(res){ return res.json().then(function(data){ return {res:res, data:data}; }); })
    .then(function(result) {
      var res = result.res;
      var data = result.data || {};
      if (!res.ok || !data.success) {
        if (status) {
          status.className = 'alert alert-error';
          status.textContent = (data.errors && data.errors.join(', ')) || (L.dbBackupRestoreFailed || L.genericError);
        }
        return;
      }
      if (status) {
        status.className = 'alert alert-success';
        status.textContent = data.message || (L.dbBackupRestoreOk || 'Restore scheduled.');
      }
    })
    .catch(function() {
      if (status) {
        status.className = 'alert alert-error';
        status.textContent = L.dbBackupRestoreFailed || L.genericError;
      }
    });
}

function createBackupNow() {
  var status = document.getElementById('db-backups-status');
  if (status) {
    status.style.display = 'block';
    status.className = 'alert';
    status.textContent = L.dbBackupLoading || 'Loading...';
  }
  fetch("{{ url_for('admin_settings.create_db_backup') }}", {
    method: 'POST',
    credentials: 'same-origin',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
    body: JSON.stringify({ csrf_token: CSRF_TOKEN })
  })
    .then(function(res){ return res.json().then(function(data){ return {res:res, data:data}; }); })
    .then(function(result) {
      var res = result.res;
      var data = result.data || {};
      if (!res.ok || !data.success) {
        if (status) {
          status.className = 'alert alert-error';
          status.textContent = (data.errors && data.errors.join(', ')) || (L.dbBackupCreateFailed || L.genericError);
        }
        return;
      }
      if (status) {
        status.className = 'alert alert-success';
        status.textContent = data.message || (L.dbBackupCreateOk || 'Backup created.');
      }
      refreshBackups();
    })
    .catch(function() {
      if (status) {
        status.className = 'alert alert-error';
        status.textContent = L.dbBackupCreateFailed || L.genericError;
      }
    });
}

function closeDataImportModal() {
  var modal = document.getElementById('data-import-modal');
  if (modal) {
    modal.classList.remove('active');
  }
}

function openDataImportModal(index) {
  var rows = window.__dataImportRows || [];
  var row = rows[index];
  if (!row) return;

  var modal = document.getElementById('data-import-modal');
  var titleEl = document.getElementById('data-import-modal-title');
  var contentEl = document.getElementById('data-import-modal-content');
  if (!modal || !titleEl || !contentEl) return;

  titleEl.textContent = (row.short_id || '‚Äî') + ' ‚Äì ' + (row.full_name || '');

  var paymentsCount = row.payments_count || (row.payments ? row.payments.length : 0) || 0;
  var payments = row.payments || [];
  var overallRemaining = row.remaining_fmt || '';
  var balClass = (!overallRemaining || overallRemaining === '0.00' || overallRemaining === '0')
    ? 'bal-0'
    : 'bal-pos';

  var html = [];

  // Patient header card (mirror of patient header layout with page chip)
  html.push('<div class="card patient-header-card import-preview">');
  html.push('  <div class="patient-summary-primary">');
  html.push('    <div class="summary-item summary-item-main">');
  html.push('      <div class="summary-label">{{ t("name") }}</div>');
  html.push('      <div class="summary-value">' + (row.full_name || '‚Äî') + '</div>');
  html.push('    </div>');
  html.push('    <div class="summary-item summary-item-main">');
  html.push('      <div class="summary-label">{{ t("phone") }}</div>');
  html.push('      <div class="summary-value">' + (row.phone || '‚Äî') + '</div>');
  html.push('    </div>');
  html.push('    <div class="summary-item summary-item-balance">');
  html.push('      <div class="summary-label">{{ t("overall_balance") }}</div>');
  html.push('      <div class="summary-value"><div class="bal-box ' + balClass + '">' + (overallRemaining || '0.00') + '</div></div>');
  html.push('    </div>');
  html.push('  </div>');
  html.push('  <div class="patient-summary-meta">');
  html.push('    <div class="summary-item summary-item-meta">');
  html.push('      <div class="summary-label">{{ t("file_no") }}</div>');
  html.push('      <div class="summary-value"><span class="page-chip">' + (row.short_id || '‚Äî') + '</span></div>');
  html.push('    </div>');
  html.push('    <div class="summary-item summary-item-meta">');
  html.push('      <div class="summary-label">{{ t("page_numbers") }}</div>');
  html.push('      <div class="summary-value"><span class="page-chip">üìÑ <span class="page-chip-notebook">' + (row.primary_page_number || '‚Äî') + '</span></span></div>');
  html.push('    </div>');
  html.push('  </div>');
  html.push('  <div class="patient-notes">');
  html.push('    <div class="summary-label">{{ t("sheet_notes") }}</div>');
  html.push('    <div class="summary-value wrap-text">‚Äî</div>');
  html.push('  </div>');
  html.push('</div>');

  // Payments list (mirror of payment cards, simplified)
  html.push('<div class="card payments-card">');
  html.push('  <div class="payments-header">');
  html.push('    <strong class="payments-title">{{ t("payments") }}</strong>');
  html.push('    <span class="u-text-muted" style="font-size:0.85rem;">(' + paymentsCount + ')</span>');
  html.push('  </div>');

  if (!payments.length) {
    html.push('  <div class="no-payments">{{ t("no_rows") }}</div>');
  } else {
    payments.forEach(function(p) {
      var remaining = p.remaining_fmt || p.raw_remaining || '';
      var cardBalClass = (!remaining || remaining === '0.00' || remaining === '0')
        ? 'bal-0'
        : 'bal-pos';
      var cardClass = (cardBalClass === 'bal-0') ? 'ok' : 'due';
      var visitLabel = '{{ t("vt_none") }}';
      if (p.visit_type === 'exam') {
        visitLabel = '{{ t("vt_exam") }}';
      } else if (p.visit_type === 'followup' || p.visit_type === 'follow') {
        visitLabel = '{{ t("vt_follow") }}';
      }
      html.push('  <div class="card payment-card ' + cardClass + ' import-preview">');
      html.push('    <div class="payment-card-header">');
      html.push('      <div class="payment-amount">');
        html.push('        <div class="payment-amount-value">' + (p.paid_fmt || '0.00') + '</div>');
        html.push('        <div class="payment-amount-label">{{ t("down_payment") }}</div>');
      html.push('      </div>');
      html.push('      <div class="payment-card-meta">');
        html.push('        <div class="payment-date">' + (p.paid_at || '‚Äî') + '</div>');
        html.push('        <div class="payment-method">{{ t("method") }}: ‚Äî</div>');
        html.push('        <span class="payment-doctor-chip" style="--chip-color:#111827;">{{ t("any_doctor") }}</span>');
      html.push('      </div>');
      html.push('    </div>');
      html.push('    <div class="payment-card-body">');
      html.push('      <div class="payment-info-grid">');
      html.push('        <div class="payment-field">');
      html.push('          <div class="payment-label">{{ t("summary_total") }}</div>');
      html.push('          <div class="payment-value">' + (p.total_fmt || '0.00') + '</div>');
      html.push('        </div>');
      html.push('        <div class="payment-field">');
      html.push('          <div class="payment-label">{{ t("summary_discount") }}</div>');
      html.push('          <div class="payment-value">0.00</div>');
      html.push('        </div>');
      html.push('        <div class="payment-field">');
      html.push('          <div class="payment-label">{{ t("summary_remaining") }}</div>');
      html.push('          <div class="payment-value"><div class="bal-box ' + cardBalClass + '">' + (remaining || '0.00') + '</div></div>');
      html.push('        </div>');
      html.push('        <div class="payment-field">');
      html.push('          <div class="payment-label">{{ t("visit_type") }}</div>');
      html.push('          <div class="payment-value">' + visitLabel + '</div>');
      html.push('        </div>');
      html.push('        <div class="payment-field">');
      html.push('          <div class="payment-label">{{ t("treatment_type") }}</div>');
      html.push('          <div class="payment-value">' + (p.treatment_type || '‚Äî') + '</div>');
      html.push('        </div>');
      html.push('      </div>');
      html.push('      <div class="payment-note">');
      html.push('        <div class="payment-label">{{ t("sheet_notes") }}</div>');
      html.push('        <div class="payment-value">' + (p.notes || '‚Äî') + '</div>');
      html.push('      </div>');
      html.push('    </div>');
      html.push('  </div>');
    });
  }

  html.push('</div>');

  contentEl.innerHTML = html.join('');

  modal.classList.add('active');
}

function resetPdfLogo() {
  var statusEl = document.getElementById('pdf-logo-status');
  statusEl.style.display = 'none';
  statusEl.textContent = '';
  statusEl.className = 'alert';

  fetch("{{ url_for('admin_settings.reset_pdf_logo') }}", {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': CSRF_TOKEN
    },
    body: JSON.stringify({ csrf_token: CSRF_TOKEN })
  })
    .then(function(res) { return res.json().then(function(data) { return { res: res, data: data }; }); })
    .then(function(result) {
      if (!result.res.ok || !result.data.success) {
        statusEl.textContent = (result.data.errors && result.data.errors.join(', ')) || (L.logoResetFailed || 'Reset failed.');
        statusEl.className = 'alert alert-error';
        statusEl.style.display = 'block';
        return;
      }
      window.location.reload();
    })
    .catch(function() {
      statusEl.textContent = L.logoUnexpected || 'Unexpected error while resetting logo.';
      statusEl.className = 'alert alert-error';
      statusEl.style.display = 'block';
    });
}

function loadPdfLogoHistory() {
  var selectEl = document.getElementById('pdf-logo-history');
  var wrapper = document.getElementById('pdf-logo-history-wrapper');
  if (!selectEl || !wrapper) return;

  fetch("{{ url_for('admin_settings.pdf_logo_history') }}", { credentials: 'same-origin' })
    .then(function(res) { return res.json(); })
    .then(function(data) {
      if (!data || !data.logo_history || !data.logo_history.length) {
        wrapper.style.display = 'none';
        return;
      }
      wrapper.style.display = 'block';
      selectEl.innerHTML = '';
      data.logo_history.forEach(function(item) {
        var opt = document.createElement('option');
        opt.value = item.path;
        opt.textContent = item.label;
        selectEl.appendChild(opt);
      });
    })
    .catch(function() {
      wrapper.style.display = 'none';
    });
}

function useSelectedPdfLogo() {
  var selectEl = document.getElementById('pdf-logo-history');
  var statusEl = document.getElementById('pdf-logo-status');
  if (!selectEl) return;
  var selected = selectEl.value;
  statusEl.style.display = 'none';
  statusEl.textContent = '';
  statusEl.className = 'alert';

  if (!selected) {
    statusEl.textContent = L.logoSelectRequired || 'Please select a logo.';
    statusEl.className = 'alert alert-error';
    statusEl.style.display = 'block';
    return;
  }

  fetch("{{ url_for('admin_settings.select_pdf_logo') }}", {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': CSRF_TOKEN
    },
    body: JSON.stringify({ logo_path: selected, csrf_token: CSRF_TOKEN })
  })
    .then(function(res) { return res.json().then(function(data) { return { res: res, data: data }; }); })
    .then(function(result) {
      if (!result.res.ok || !result.data.success) {
        statusEl.textContent = (result.data.errors && result.data.errors.join(', ')) || (L.logoSelectFailed || 'Could not switch logo.');
        statusEl.className = 'alert alert-error';
        statusEl.style.display = 'block';
        return;
      }
      statusEl.textContent = L.logoSelectOk || 'Logo switched.';
      statusEl.className = 'alert alert-success';
      statusEl.style.display = 'block';
      window.location.reload();
    })
    .catch(function() {
      statusEl.textContent = L.logoUnexpected || 'Unexpected error while switching logo.';
      statusEl.className = 'alert alert-error';
      statusEl.style.display = 'block';
    });
}

function resetLogo() {
  var statusEl = document.getElementById('logo-status');
  statusEl.style.display = 'none';
  statusEl.textContent = '';
  statusEl.className = 'alert';

  fetch("{{ url_for('admin_settings.reset_logo') }}", {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': CSRF_TOKEN
    },
    body: JSON.stringify({ csrf_token: CSRF_TOKEN })
  })
    .then(function(res) {
      return res.json().then(function(data) { return { res: res, data: data }; });
    })
    .then(function(result) {
      if (!result.res.ok || !result.data.success) {
        statusEl.textContent = (result.data.errors && result.data.errors.join(', ')) || (L.logoResetFailed || 'Reset failed.');
        statusEl.className = 'alert alert-error';
        statusEl.style.display = 'block';
        return;
      }
      statusEl.textContent = L.logoResetOk || 'Logo removed.';
      statusEl.className = 'alert alert-success';
      statusEl.style.display = 'block';
      // Clear preview
      var previewBox = document.getElementById('theme-logo-preview');
      if (previewBox) { previewBox.innerHTML = '<div class="logo-placeholder">{{ tf("no_logo", "No logo uploaded") }}</div>'; }
    })
    .catch(function() {
      statusEl.textContent = L.logoUnexpected || 'Unexpected error while resetting logo.';
      statusEl.className = 'alert alert-error';
      statusEl.style.display = 'block';
    });
}

function resetThemeDefaults() {
  var statusEl = document.getElementById('theme-status-colors');
  statusEl.style.display = 'none';
  statusEl.textContent = '';
  statusEl.className = 'alert';

  fetch("{{ url_for('admin_settings.reset_theme_defaults') }}", {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': CSRF_TOKEN
    },
    body: JSON.stringify({ csrf_token: CSRF_TOKEN })
  })
    .then(function(res) { return res.json().then(function(data) { return { res: res, data: data }; }); })
    .then(function(result) {
      if (!result.res.ok || !result.data.success) {
        statusEl.textContent = (result.data.errors && result.data.errors.join(', ')) || (L.themeResetFailed || 'Reset failed.');
        statusEl.className = 'alert alert-error';
        statusEl.style.display = 'block';
        return;
      }
      statusEl.textContent = L.themeSavedReload || 'Theme reset. Reloading...';
      statusEl.className = 'alert alert-success';
      statusEl.style.display = 'block';
      window.location.reload();
    })
    .catch(function() {
      statusEl.textContent = L.themeUnexpected || 'Unexpected error while resetting theme.';
      statusEl.className = 'alert alert-error';
      statusEl.style.display = 'block';
    });
}

function loadLogoHistory() {
  var selectEl = document.getElementById('logo-history');
  var wrapper = document.getElementById('logo-history-wrapper');
  if (!selectEl || !wrapper) return;

  fetch("{{ url_for('admin_settings.logo_history') }}", { credentials: 'same-origin' })
    .then(function(res) { return res.json(); })
    .then(function(data) {
      if (!data || !data.logo_history || !data.logo_history.length) {
        wrapper.style.display = 'none';
        return;
      }
      wrapper.style.display = 'block';
      selectEl.innerHTML = '';
      data.logo_history.forEach(function(item) {
        var opt = document.createElement('option');
        opt.value = item.path;
        opt.textContent = item.label;
        selectEl.appendChild(opt);
      });
    })
    .catch(function() {
      wrapper.style.display = 'none';
    });
}

function useSelectedLogo() {
  var selectEl = document.getElementById('logo-history');
  var statusEl = document.getElementById('logo-status');
  var preview = document.getElementById('theme-logo-preview');
  if (!selectEl) return;
  var selected = selectEl.value;
  statusEl.style.display = 'none';
  statusEl.textContent = '';
  statusEl.className = 'alert';

  if (!selected) {
    statusEl.textContent = L.logoSelectRequired || 'Please select a logo.';
    statusEl.className = 'alert alert-error';
    statusEl.style.display = 'block';
    return;
  }

  fetch("{{ url_for('admin_settings.select_logo') }}", {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': CSRF_TOKEN
    },
    body: JSON.stringify({ logo_path: selected, csrf_token: CSRF_TOKEN })
  })
    .then(function(res) { return res.json().then(function(data) { return { res: res, data: data }; }); })
    .then(function(result) {
      if (!result.res.ok || !result.data.success) {
        statusEl.textContent = (result.data.errors && result.data.errors.join(', ')) || (L.logoSelectFailed || 'Could not switch logo.');
        statusEl.className = 'alert alert-error';
        statusEl.style.display = 'block';
        return;
      }
      statusEl.textContent = L.logoSelectOk || 'Logo switched.';
      statusEl.className = 'alert alert-success';
      statusEl.style.display = 'block';
      if (result.data.logo_url && preview) {
        preview.innerHTML = '<img src="' + result.data.logo_url + '" alt="Logo">';
      }
      window.location.reload();
    })
    .catch(function() {
      statusEl.textContent = L.logoUnexpected || 'Unexpected error while switching logo.';
      statusEl.className = 'alert alert-error';
      statusEl.style.display = 'block';
    });
}
// Theme previews
function attachThemePreview() {
  var primaryInput = document.getElementById('theme-primary');
  var accentInput = document.getElementById('theme-accent');
  var chip = document.getElementById('theme-chip');
  var title = document.getElementById('theme-preview-title');
  var text = document.getElementById('theme-preview-text');
  var primaryBox = document.getElementById('theme-primary-preview');
  var accentBox = document.getElementById('theme-accent-preview');
  var textInput = document.getElementById('theme-text-color');
  var textPreview = document.getElementById('theme-text-preview');
  var btnTextInput = document.getElementById('theme-btn-text-color');
  var btnTextPreview = document.getElementById('theme-btn-text-preview');
  var metricInput = document.getElementById('theme-metric-color');
  var metricPreview = document.getElementById('theme-metric-preview');
  var pageBgInput = document.getElementById('theme-page-bg');
  var pageBgPreview = document.getElementById('theme-page-bg-preview');
  var cardBgInput = document.getElementById('theme-card-bg');
  var cardBgPreview = document.getElementById('theme-card-bg-preview');
  var clinicBrandInput = document.getElementById('clinic-brand-color');
  var clinicBrandPreview = document.getElementById('clinic-brand-preview');

  function refresh() {
    var primary = primaryInput.value;
    var accent = accentInput.value;
    var textColor = textInput ? textInput.value : null;
    var btnTextColor = btnTextInput ? btnTextInput.value : null;
    var metricColor = metricInput ? metricInput.value : null;
    if (primaryBox) primaryBox.style.background = primary;
    if (accentBox) accentBox.style.background = accent;
    if (textPreview && textColor) {
      textPreview.style.background = textColor;
    }
    if (btnTextPreview && btnTextColor) {
      btnTextPreview.style.background = btnTextColor;
    }
    if (clinicBrandPreview && clinicBrandInput) {
      clinicBrandPreview.style.background = clinicBrandInput.value;
    }
    if (metricPreview && metricColor) {
      metricPreview.style.background = metricColor;
    }
    if (pageBgPreview && pageBgInput) {
      pageBgPreview.style.background = pageBgInput.value;
    }
    if (cardBgPreview && cardBgInput) {
      cardBgPreview.style.background = cardBgInput.value;
    }
    if (chip) {
      chip.style.background = primary;
      chip.style.borderColor = primary;
      chip.style.color = btnTextColor || '#fff';
    }
    if (title) title.style.color = primary;
    if (text) text.style.color = accent;
  }

  if (primaryInput) {
    primaryInput.addEventListener('input', refresh);
  }
  if (accentInput) {
    accentInput.addEventListener('input', refresh);
  }
  if (textInput) {
    textInput.addEventListener('input', refresh);
  }
  if (metricInput) {
    metricInput.addEventListener('input', refresh);
  }
  if (pageBgInput) {
    pageBgInput.addEventListener('input', refresh);
  }
  if (cardBgInput) {
    cardBgInput.addEventListener('input', refresh);
  }
  if (clinicBrandInput) {
    clinicBrandInput.addEventListener('input', refresh);
  }
  if (btnTextInput) {
    btnTextInput.addEventListener('input', refresh);
  }
  refresh();
}

function formatDateTime(tsSeconds) {
  var n = Number(tsSeconds || 0);
  if (!n) return '';
  try {
    var d = new Date(n * 1000);
    return d.toLocaleString();
  } catch (e) {
    return '';
  }
}

function refreshImportReports() {
  var list = document.getElementById('data-import-reports-list');
  if (!list) return;
  list.innerHTML = '<div class="u-text-muted">' + (L.loading || 'Loading...') + '</div>';
  fetch("{{ url_for('admin_settings.list_import_reports') }}", { credentials: 'same-origin' })
    .then(function(res){ return res.json().then(function(data){ return {res:res, data:data}; }); })
    .then(function(result) {
      var res = result.res;
      var data = result.data || {};
      if (!res.ok || !data.success) {
        list.innerHTML = '<div class="u-text-muted">' + ((data.errors && data.errors.join(', ')) || (L.genericError || 'Error')) + '</div>';
        return;
      }
      var reports = data.reports || [];
      if (!reports.length) {
        list.innerHTML = '<div class="u-text-muted">{{ tf("data_import_reports_empty", "No import reports yet.") }}</div>';
        return;
      }
      list.innerHTML = '';
      for (var i = 0; i < reports.length; i++) {
        var r = reports[i] || {};
        var card = document.createElement('div');
        card.className = 'card';
        card.style.marginTop = '0.75rem';

        var header = document.createElement('div');
        header.className = 'card-header';
        header.style.justifyContent = 'space-between';

        var title = document.createElement('div');
        title.className = 'card-title';
        title.style.fontSize = '0.95rem';
        title.textContent = (r.filename || r.name || '‚Äî');
        header.appendChild(title);

        var meta = document.createElement('div');
        meta.className = 'u-text-muted';
        meta.style.fontSize = '0.85rem';
        meta.textContent = (formatDateTime(r.modified_at) ? (formatDateTime(r.modified_at) + ' ¬∑ ') : '') + (r.source_kind ? String(r.source_kind) : '');
        header.appendChild(meta);

        card.appendChild(header);

        var actions = document.createElement('div');
        actions.className = 'actions-row';
        actions.style.justifyContent = 'flex-end';
        actions.style.marginTop = '0.5rem';

        var download = document.createElement('a');
        download.className = 'btn secondary';
        download.href = "{{ url_for('admin_settings.download_import_report', name='__NAME__') }}".replace('__NAME__', r.name || '');
        download.textContent = '{{ tf("download", "Download") }}';
        download.target = '_blank';
        download.rel = 'noopener';
        actions.appendChild(download);

        var viewSummary = document.createElement('button');
        viewSummary.type = 'button';
        viewSummary.className = 'btn btn-secondary';
        viewSummary.textContent = L.dataImportReportViewSummary || '{{ tf("data_import_report_view_summary", "View report summary") }}';
        (function(reportName) {
          viewSummary.addEventListener('click', function() {
            openImportReportModal(reportName);
          });
        })(r.name || '');
        actions.appendChild(viewSummary);

        var reviewSafe = document.createElement('button');
        reviewSafe.type = 'button';
        reviewSafe.className = 'btn btn-secondary';
        reviewSafe.textContent = '{{ tf("data_import_report_dups_safe_btn", "Review duplicates (safe)") }}';
        (function(reportName) {
          reviewSafe.addEventListener('click', function() {
            window.__lastImportReportName = reportName;
            var afterBox = document.getElementById('data-import-after-import');
            if (afterBox) afterBox.style.display = 'block';
            switchDataSubtab('reports');
            loadReportDuplicates('safe');
          });
        })(r.name || '');
        actions.appendChild(reviewSafe);

        var reviewNormal = document.createElement('button');
        reviewNormal.type = 'button';
        reviewNormal.className = 'btn btn-secondary data-advanced';
        reviewNormal.textContent = '{{ tf("data_import_report_dups_normal_btn", "Review duplicates (normal)") }}';
        (function(reportName) {
          reviewNormal.addEventListener('click', function() {
            window.__lastImportReportName = reportName;
            var afterBox = document.getElementById('data-import-after-import');
            if (afterBox) afterBox.style.display = 'block';
            switchDataSubtab('reports');
            loadReportDuplicates('normal');
          });
        })(r.name || '');
        actions.appendChild(reviewNormal);

        var reviewAgg = document.createElement('button');
        reviewAgg.type = 'button';
        reviewAgg.className = 'btn btn-secondary';
        reviewAgg.textContent = '{{ tf("data_import_report_dups_aggressive_btn", "Review duplicates (aggressive)") }}';
        (function(reportName) {
          reviewAgg.addEventListener('click', function() {
            window.__lastImportReportName = reportName;
            var afterBox = document.getElementById('data-import-after-import');
            if (afterBox) afterBox.style.display = 'block';
            switchDataSubtab('reports');
            loadReportDuplicates('aggressive');
          });
        })(r.name || '');
        actions.appendChild(reviewAgg);

        card.appendChild(actions);
        list.appendChild(card);
      }
    })
    .catch(function() {
      list.innerHTML = '<div class="u-text-muted">' + (L.genericError || 'Error') + '</div>';
    });
}

function openImportReportModal(reportName) {
  var modal = document.getElementById('import-report-modal');
  var title = document.getElementById('import-report-modal-title');
  var status = document.getElementById('import-report-modal-status');
  var body = document.getElementById('import-report-modal-body');
  if (!modal || !body) return;

  if (title) title.textContent = (L.dataImportReportViewSummary || 'Import report') + ': ' + String(reportName || '');
  if (status) { status.style.display = 'none'; status.textContent = ''; status.className = 'alert'; }
  body.innerHTML = '<div class="u-text-muted">' + (L.dataImportReportLoading || 'Loading...') + '</div>';

  modal.classList.add('active');

  var url = "{{ url_for('admin_settings.import_report_meta', name='__NAME__') }}".replace('__NAME__', reportName || '');
  fetch(url, { credentials: 'same-origin' })
    .then(function(res){ return res.json().then(function(data){ return {res:res, data:data}; }); })
    .then(function(result) {
      var res = result.res;
      var data = result.data || {};
      if (!res.ok || !data.success) {
        body.innerHTML = '<div class="u-text-muted">' + ((data.errors && data.errors.join(', ')) || (L.genericError || 'Error')) + '</div>';
        return;
      }
      var rep = data.report || {};
      var opts = rep.options || {};
      var results = rep.results || {};
      var counts = rep.counts || {};
      var conflicts = rep.page_conflicts_preview || [];

      var html = '';
      html += '<div class="card" style="padding:0.75rem;">';
      html += '<div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;align-items:baseline;">';
      html += '<div style="font-weight:700;">' + escapeHtml(rep.filename || rep.name || '‚Äî') + '</div>';
      if (rep.timestamp) html += '<div class="u-text-muted" style="font-size:0.85rem;">' + escapeHtml(String(rep.timestamp)) + '</div>';
      html += '</div>';
      if (rep.source_kind) html += '<div class="u-text-muted" style="margin-top:0.25rem;">{{ tf("source", "Source") }}: ' + escapeHtml(String(rep.source_kind)) + '</div>';
      html += '</div>';

      // Simple, readable summary blocks
      var patientsInFile = (results.unique_patients_in_file != null)
        ? results.unique_patients_in_file
        : (counts.patients != null ? counts.patients : '‚Äî');
      var paymentRows = (counts.payment_rows != null ? counts.payment_rows : (counts.payments != null ? counts.payments : '‚Äî'));

      html += '<div class="card" style="padding:0.75rem;margin-top:0.75rem;">';
      html += '<div style="font-weight:700;margin-bottom:0.35rem;">{{ tf("summary", "Summary") }}</div>';
      html += '<div style="display:flex;gap:10px;flex-wrap:wrap;">';
      html += '<div class="u-text-muted">{{ tf("data_import_patients_in_file", "Patients in file") }}: <strong>' + escapeHtml(String(patientsInFile)) + '</strong></div>';
      html += '<div class="u-text-muted">{{ tf("data_import_payment_rows", "Payment rows") }}: <strong>' + escapeHtml(String(paymentRows)) + '</strong></div>';
      html += '<div class="u-text-muted">{{ tf("data_import_zero_entries", "Zero-amount entries") }}: <strong>' + escapeHtml(String(counts.zero_entries != null ? counts.zero_entries : '‚Äî')) + '</strong></div>';
      html += '<div class="u-text-muted">{{ tf("data_import_skipped_rows", "Skipped empty rows") }}: <strong>' + escapeHtml(String(counts.skipped_rows != null ? counts.skipped_rows : '‚Äî')) + '</strong></div>';
      html += '</div>';
      html += '</div>';

      html += '<div class="card" style="padding:0.75rem;margin-top:0.75rem;">';
      html += '<div style="font-weight:700;margin-bottom:0.35rem;">{{ tf("data_import_commit_title", "Import into clinic database") }}</div>';
      html += '<div style="display:flex;gap:10px;flex-wrap:wrap;">';
      if (results.created_patients != null) html += '<div class="u-text-muted">{{ tf("data_import_new_patients", "New patients") }}: <strong>+' + escapeHtml(String(results.created_patients)) + '</strong></div>';
      if (results.matched_patients != null) html += '<div class="u-text-muted">{{ tf("data_import_matched_patients", "Patients matched") }}: <strong>' + escapeHtml(String(results.matched_patients)) + '</strong></div>';
      if (results.inserted_money_payments != null) html += '<div class="u-text-muted">{{ tf("data_import_new_payments", "New payments") }}: <strong>+' + escapeHtml(String(results.inserted_money_payments)) + '</strong></div>';
      if (results.skipped_duplicates != null) html += '<div class="u-text-muted">{{ tf("data_import_skip_duplicates_short", "Duplicates skipped") }}: <strong>' + escapeHtml(String(results.skipped_duplicates)) + '</strong></div>';
      if (results.skipped_edited_existing_rows != null) html += '<div class="u-text-muted">{{ tf("data_import_skip_edited_rows_short", "Edited old rows skipped") }}: <strong>' + escapeHtml(String(results.skipped_edited_existing_rows)) + '</strong></div>';
      if (results.inserted_zero_entries != null) html += '<div class="u-text-muted">{{ tf("data_import_zero_entries", "Zero-amount entries") }}: <strong>+' + escapeHtml(String(results.inserted_zero_entries)) + '</strong></div>';
      html += '</div>';

      html += '<div class="u-text-muted" style="margin-top:0.5rem;">';
      html += '{{ tf("options", "Options") }}: ';
      html += (opts.skip_duplicates ? '‚úì ' : '‚Äî ') + '{{ tf("data_import_skip_duplicates_short", "Duplicates skipped") }}';
      html += ' \u2022 ' + (opts.import_zero_entries ? '‚úì ' : '‚Äî ') + '{{ tf("data_import_import_zero_entries", "Import zero-amount entries (history rows)") }}';
      html += ' \u2022 ' + (opts.never_auto_merge ? '‚úì ' : '‚Äî ') + '{{ tf("data_import_never_auto_merge", "Never auto-merge patients (safer)") }}';
      html += '</div>';
      html += '</div>';

      // Warnings / details
      html += '<div class="card" style="padding:0.75rem;margin-top:0.75rem;">';
      html += '<div style="font-weight:700;margin-bottom:0.35rem;">{{ tf("warnings", "Warnings") }}</div>';
      if ((results.page_number_conflicts || 0) > 0) {
        html += '<div class="u-text-muted">{{ tf("data_import_page_conflicts", "Page number conflicts") }}: <strong>' + escapeHtml(String(results.page_number_conflicts)) + '</strong></div>';
      }
      var unknownDates = (typeof results.unknown_dates_left_blank === 'number')
        ? results.unknown_dates_left_blank
        : (results.unknown_dates_fallback_to_today || 0);
      if ((unknownDates || 0) > 0) {
        html += '<div class="u-text-muted">{{ tf("data_import_unknown_dates", "Unknown dates (left blank)") }}: <strong>' + escapeHtml(String(unknownDates)) + '</strong></div>';
      }
      if (!conflicts.length) {
        html += '<div class="u-text-muted" style="margin-top:0.35rem;">{{ tf("data_import_page_conflicts_none", "No page conflicts were recorded in this report.") }}</div>';
      } else {
        html += '<details style="margin-top:0.5rem;"><summary style="cursor:pointer;">{{ tf("data_import_page_conflicts", "Page number conflicts") }} ({{ tf("details", "Details") }})</summary>';
        html += '<div style="overflow-x:auto;margin-top:0.5rem;">';
        html += '<table class="table-compact">';
        html += '<thead><tr>'
          + '<th>{{ tf("page_number", "Page number") }}</th>'
          + '<th>{{ tf("incoming", "Incoming") }}</th>'
          + '<th>{{ tf("existing", "Existing") }}</th>'
          + '</tr></thead><tbody>';
        for (var i = 0; i < conflicts.length; i++) {
          var c = conflicts[i] || {};
          var incoming = (c.incoming_name || '‚Äî') + ' ¬∑ ' + (c.incoming_phone || '‚Äî');
          var existing = (c.existing_name || '‚Äî') + ' ¬∑ ' + (c.existing_phone || '‚Äî') + ' ¬∑ ' + (c.existing_file_number || '‚Äî');
          html += '<tr>'
            + '<td>' + escapeHtml(c.page_number || '‚Äî') + '</td>'
            + '<td>' + escapeHtml(incoming) + '</td>'
            + '<td>' + escapeHtml(existing) + '</td>'
            + '</tr>';
        }
        html += '</tbody></table></div></details>';
      }
      html += '</div>';

      body.innerHTML = html;
    })
    .catch(function() {
      body.innerHTML = '<div class="u-text-muted">' + (L.genericError || 'Error') + '</div>';
    });
}

function closeImportReportModal() {
  var modal = document.getElementById('import-report-modal');
  if (modal) modal.classList.remove('active');
}

document.addEventListener('DOMContentLoaded', function() {
  attachThemePreview();
  loadLogoHistory();
  loadPdfLogoHistory();
  refreshImportReports();
});

// Modal functions
function openUserModal(userId) {
  if (typeof userId === 'undefined') userId = null;
  currentUserId = userId;
  var modal = document.getElementById('user-modal');
  var title = document.getElementById('user-modal-title');
  var submitBtn = document.getElementById('user-submit-btn');
  var alert = document.getElementById('user-alert');

  alert.style.display = 'none';

  if (userId) {
    title.textContent = L.editUser;
    submitBtn.textContent = L.updateUser;
    loadUserData(userId);
  } else {
    title.textContent = L.createUser;
    submitBtn.textContent = L.createUser;
    document.getElementById('user-form').reset();
    document.getElementById('user-active').checked = true;
  }

  modal.classList.add('active');
}

function openRoleModal(roleId) {
  if (typeof roleId === 'undefined') roleId = null;
  currentRoleId = roleId;
  var modal = document.getElementById('role-modal');
  var title = document.getElementById('role-modal-title');
  var submitBtn = document.getElementById('role-submit-btn');
  var alert = document.getElementById('role-alert');

  alert.style.display = 'none';

  if (roleId) {
    title.textContent = L.editRole;
    submitBtn.textContent = L.updateRole;
    loadRoleData(roleId);
  } else {
    title.textContent = L.createRole;
    submitBtn.textContent = L.createRole;
    document.getElementById('role-form').reset();
  }

  modal.classList.add('active');
}

function closeModal() {
  var modalList = document.querySelectorAll('.modal');
  for (var i = 0; i < modalList.length; i++) {
    modalList[i].classList.remove('active');
  }
  currentUserId = null;
  currentRoleId = null;
}

// User functions
function saveUser() {
  var submitBtn = document.getElementById('user-submit-btn');
  var alert = document.getElementById('user-alert');
  var checkboxes = document.querySelectorAll('#user-form .form-checkbox-group input[type="checkbox"]:checked');
  var selectedRoles = [];
  for (var i = 0; i < checkboxes.length; i++) {
    var val = parseInt(checkboxes[i].value, 10);
    if (!isNaN(val)) {
      selectedRoles.push(val);
    }
  }

  var userData = {
    username: document.getElementById('user-username').value.trim(),
    full_name: document.getElementById('user-full-name').value.trim(),
    phone: document.getElementById('user-phone').value.trim(),
    password: document.getElementById('user-password').value,
    roles: selectedRoles,
    is_active: document.getElementById('user-active').checked
  };

  if (currentUserId) {
    userData.user_id = currentUserId;
  }

  submitBtn.disabled = true;
  submitBtn.textContent = L.saving;

  var url = currentUserId ? "/admin/settings/users/" + currentUserId + "/update" : '/admin/settings/users/create';

  fetch(url, {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': CSRF_TOKEN
    },
    body: JSON.stringify(userData)
  })
    .then(function(response) {
      return response.json().then(function(data) {
        return { response: response, data: data };
      });
    })
    .then(function(result) {
      if (result.data && result.data.success) {
        closeModal();
        location.reload();
      } else {
        alert.textContent = result.data && result.data.errors ? result.data.errors.join(', ') : L.saveFailed;
        alert.style.display = 'block';
      }
    })
    .catch(function() {
      alert.textContent = L.genericError;
      alert.style.display = 'block';
    })
    .then(function() {
      submitBtn.disabled = false;
      submitBtn.textContent = currentUserId ? L.updateUser : L.createUser;
    });
}

function loadUserData(userId) {
  fetch('/admin/settings/users/' + userId, { credentials: 'same-origin' })
    .then(function(response) { return response.json(); })
    .then(function(result) {
      if (result.success) {
        var user = result.user;
        document.getElementById('user-username').value = user.username;
        document.getElementById('user-full-name').value = user.full_name || '';
        document.getElementById('user-phone').value = user.phone || '';
        document.getElementById('user-password').value = '';

        // Clear all role checkboxes
        var roleCheckboxes = document.querySelectorAll('#user-form .form-checkbox-group input[type="checkbox"]');
        for (var i = 0; i < roleCheckboxes.length; i++) {
          roleCheckboxes[i].checked = false;
        }
        document.getElementById('user-active').checked = Boolean(user.is_active);

        // Check the user's roles
        for (var j = 0; j < user.roles.length; j++) {
          var checkbox = document.getElementById('role-' + user.roles[j]);
          if (checkbox) {
            checkbox.checked = true;
          }
        }
      } else {
        alert(L.userLoadError + ': ' + result.errors.join(', '));
      }
    })
    .catch(function() {
      alert(L.userLoadError);
    });
}

function editUser(userId) {
  openUserModal(userId);
}

function deleteUser(userId, username) {
  if (!confirm(L.userDeleteConfirm.replace('{name}', username))) {
    return;
  }

  fetch('/admin/settings/users/' + userId + '/delete', {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': CSRF_TOKEN
    },
    body: JSON.stringify({})
  })
    .then(function(response) { return response.json(); })
    .then(function(result) {
      if (result.success) {
        location.reload();
      } else {
        alert(L.errorPrefix + ' ' + result.errors.join(', '));
      }
    })
    .catch(function() {
      alert(L.genericError);
    });
}

// Role functions
function saveRole() {
  var submitBtn = document.getElementById('role-submit-btn');
  var alert = document.getElementById('role-alert');

  var permissionBoxes = document.querySelectorAll('#role-form input[type="checkbox"]:checked');
  var permissions = [];
  for (var i = 0; i < permissionBoxes.length; i++) {
    permissions.push(parseInt(permissionBoxes[i].value, 10));
  }

  var roleData = {
    name: document.getElementById('role-name').value.trim(),
    description: document.getElementById('role-description').value.trim(),
    permissions: permissions
  };

  if (currentRoleId) {
    roleData.role_id = currentRoleId;
  }

  submitBtn.disabled = true;
  submitBtn.textContent = L.saving;

  var url = currentRoleId ? "/admin/settings/roles/" + currentRoleId + "/update" : '/admin/settings/roles/create';

  fetch(url, {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': CSRF_TOKEN
    },
    body: JSON.stringify(roleData)
  })
    .then(function(response) { return response.json(); })
    .then(function(result) {
      if (result.success) {
        closeModal();
        location.reload();
      } else {
        alert.textContent = result.errors.join(', ');
        alert.style.display = 'block';
      }
    })
    .catch(function() {
      alert.textContent = L.genericError;
      alert.style.display = 'block';
    })
    .then(function() {
      submitBtn.disabled = false;
      submitBtn.textContent = currentRoleId ? L.updateRole : L.createRole;
    });
}

function loadRoleData(roleId) {
  fetch('/admin/settings/roles/' + roleId, { credentials: 'same-origin' })
    .then(function(response) { return response.json(); })
    .then(function(result) {
      if (result.success) {
        var role = result.role;
        document.getElementById('role-name').value = role.name;
        document.getElementById('role-description').value = role.description || '';

        // Clear all permission checkboxes
        var permBoxes = document.querySelectorAll('#role-form input[type="checkbox"]');
        for (var i = 0; i < permBoxes.length; i++) {
          permBoxes[i].checked = false;
        }

        // Check the role's permissions
        for (var j = 0; j < role.permissions.length; j++) {
          var checkbox = document.getElementById('perm-' + role.permissions[j]);
          if (checkbox) {
            checkbox.checked = true;
          }
        }
      } else {
        alert(L.roleLoadError + ': ' + result.errors.join(', '));
      }
    })
    .catch(function() {
      alert(L.roleLoadError);
    });
}

function editRole(roleId) {
  openRoleModal(roleId);
}

function deleteRole(roleId, roleName) {
  if (!confirm(L.roleDeleteConfirm.replace('{name}', roleName))) {
    return;
  }

  fetch('/admin/settings/roles/' + roleId + '/delete', {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': CSRF_TOKEN
    },
    body: JSON.stringify({})
  })
    .then(function(response) { return response.json(); })
    .then(function(result) {
      if (result.success) {
        location.reload();
      } else {
        alert(L.errorPrefix + ' ' + result.errors.join(', '));
      }
    })
    .catch(function() {
      alert(L.genericError);
    });
}

// Color functions
function updateDoctorLabel(doctorId, label) {
  if (!colorChanges[doctorId]) colorChanges[doctorId] = {};
  colorChanges[doctorId].label = label;
}

// Doctor modal helpers
function openDoctorModal(doctorId) {
  if (typeof doctorId === 'undefined') doctorId = null;
  currentDoctorId = doctorId;
  var modal = document.getElementById('doctor-modal');
  var title = document.getElementById('doctor-modal-title');
  var alert = document.getElementById('doctor-alert');
  alert.style.display = 'none';

  if (doctorId) {
    var row = document.querySelector('tr[data-doctor-id="' + doctorId + '"]');
    var label = row ? row.getAttribute('data-doctor-label') : '';
    var color = row ? row.getAttribute('data-doctor-color') : '#6b7280';
    title.textContent = L.editDoctor;
    document.getElementById('doctor-id-display').textContent = doctorId;
    document.getElementById('doctor-label').value = label || '';
    document.getElementById('doctor-color').value = color || '#6b7280';
  } else {
    title.textContent = L.addDoctor;
    document.getElementById('doctor-id-display').textContent = L.generatedAutomatically;
    document.getElementById('doctor-label').value = '';
    document.getElementById('doctor-color').value = '#6b7280';
  }
  modal.classList.add('active');
}

function closeDoctorModal() {
  currentDoctorId = null;
  var modal = document.getElementById('doctor-modal');
  modal.classList.remove('active');
}

function saveDoctor() {
  var statusEl = document.getElementById('doctor-alert');
  statusEl.style.display = 'none';
  statusEl.textContent = '';

  var label = (document.getElementById('doctor-label').value || '').trim();
  var color = document.getElementById('doctor-color').value;
  if (!label) {
    statusEl.textContent = "{{ tf('doctor_name_required', 'Doctor name is required.') }}";
    statusEl.style.display = 'block';
    return;
  }
  var payload = {
    doctor_id: null,
    original_id: currentDoctorId,
    doctor_label: label,
    color: color,
    csrf_token: CSRF_TOKEN
  };

  fetch('/admin/settings/colors/update', {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': CSRF_TOKEN
    },
    body: JSON.stringify(payload)
  })
    .then(function(response) {
      return response.json().then(function(data) {
        return { response: response, data: data };
      });
  })
    .then(function(result) {
      var response = result.response;
      var data = result.data;
      if (!response.ok || !data.success) {
        var errs = (data.errors || [L.doctorSaveFailed]).join(', ');
        statusEl.textContent = errs;
        statusEl.style.display = 'block';
        return;
      }
      location.reload();
    })
    .catch(function() {
      statusEl.textContent = L.doctorSaveUnexpected;
      statusEl.style.display = 'block';
    });
}

function deleteDoctor(doctorId, doctorLabel) {
  if (!confirm(L.doctorDeleteConfirm.replace('{name}', doctorLabel))) return;
  var slug = doctorId.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '') || doctorId;
  fetch('/admin/settings/colors/delete', {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': CSRF_TOKEN
    },
    body: JSON.stringify({ doctor_id: slug, csrf_token: CSRF_TOKEN })
  })
    .then(function(response) { return response.json().then(function(data){ return {response: response, data: data}; }); })
    .then(function(result) {
      if (!result.response.ok || !result.data.success) {
        alert(L.doctorDeleteError);
        return;
      }
      var row = document.querySelector('tr[data-doctor-id="' + slug + '"]');
      if (row) {
        row.remove();
      }
      var status = document.getElementById('doctor-status');
      if (status) {
        status.textContent = L.doctorDeleted;
        status.className = 'alert alert-success';
        status.style.display = 'block';
      }
    })
    .catch(function() {
      alert(L.doctorDeleteError);
    });
}

function updateColor(doctorId, color, label) {
  if (!colorChanges[doctorId]) colorChanges[doctorId] = {};
  colorChanges[doctorId].color = color;
  if (label) {
    colorChanges[doctorId].label = label;
  }
  // Update preview
  var row = document.querySelector('tr[data-doctor-id= + doctorId + ]');
  if (row) {
    var preview = row.querySelector('.color-preview');
    if (preview) {
      preview.style.backgroundColor = color;
    }
  }
}

function saveColor(doctorId) {
  var payload = colorChanges[doctorId] || {};
  var color = payload.color;
  var label = payload.label;
  if (!color) return;

  fetch('/admin/settings/colors/update', {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': CSRF_TOKEN
    },
    body: JSON.stringify({ doctor_id: doctorId, color: color, doctor_label: label })
  })
    .then(function(response) {
      return response.json().then(function(data) {
        return { response: response, data: data };
      });
    })
    .then(function(result) {
      var data = result.data;
      if (data && data.success) {
        delete colorChanges[doctorId];
        var row = document.querySelector('tr[data-doctor-id="' + doctorId + '"]');
        if (row) {
          var codeElement = row.querySelector('code');
          if (codeElement) {
            codeElement.textContent = color.toUpperCase();
          }
        }
      } else {
        alert(L.errorPrefix + ' ' + (data && data.errors ? data.errors.join(', ') : L.unknownError));
      }
    })
    .catch(function() {
      alert(L.genericError);
    });
}

function addDoctor() {
  openDoctorModal();
}

function deleteDoctor(doctorId) {
  if (!confirm(L.doctorDeleteConfirmSimple)) return;
  var slug = doctorId.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '') || doctorId;
  fetch('/admin/settings/colors/delete', {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': CSRF_TOKEN
    },
    body: JSON.stringify({ doctor_id: slug, csrf_token: CSRF_TOKEN })
  })
    .then(function(response) { return response.json(); })
    .then(function(result) {
      if (result.success) {
        location.reload();
      } else {
        alert(L.errorPrefix + ' ' + (result.errors ? result.errors.join(', ') : L.unknownError));
      }
    })
    .catch(function() {
      alert(L.genericError);
    });
}

function resetColors() {
  if (!confirm(L.resetColorsConfirm)) {
    return;
  }

  fetch('/admin/settings/colors/reset', {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': CSRF_TOKEN
    },
    body: JSON.stringify({ csrf_token: CSRF_TOKEN })
  })
    .then(function(response) { return response.json(); })
    .then(function(result) {
      if (result.success) {
        window.location.hash = 'colors';
        location.reload();
      } else {
        alert(L.errorPrefix + ' ' + (result.errors ? result.errors.join(', ') : L.unknownError));
      }
    })
    .catch(function() {
      alert(L.genericError);
    });
}

// Deleted doctors helpers
function renderDeletedDoctors(rows) {
  var tbody = document.getElementById('deleted-doctors-body');
  if (!tbody) return;
  tbody.innerHTML = '';
  if (!rows || !rows.length) {
    var empty = document.createElement('tr');
    empty.innerHTML = '<td colspan="4">' + L.deletedEmpty + '</td>';
    tbody.appendChild(empty);
    return;
  }
  for (var i = 0; i < rows.length; i++) {
    var row = rows[i];
    var tr = document.createElement('tr');

    var tdInfo = document.createElement('td');
    tdInfo.innerHTML = '<div style="font-weight:700;">' + row.doctor_label + '</div>'
      + '<div class="u-text-muted" style="font-size:12px;">' + L.doctorIdLabel + ': ' + row.doctor_id + '</div>';

    var tdColor = document.createElement('td');
    tdColor.innerHTML = '<code>' + (row.color ? String(row.color).toUpperCase() : '') + '</code>';

    var tdDeleted = document.createElement('td');
    tdDeleted.textContent = row.deleted_at || '‚Äî';

    var tdActions = document.createElement('td');
    tdActions.style.display = 'flex';
    tdActions.style.gap = '6px';

    var restoreBtn = document.createElement('button');
    restoreBtn.className = 'btn btn-secondary btn-sm';
    restoreBtn.type = 'button';
    restoreBtn.textContent = L.restore;
    restoreBtn.onclick = (function(id) {
      return function() { restoreDeletedDoctor(id); };
    })(row.doctor_id);

    var purgeBtn = document.createElement('button');
    purgeBtn.className = 'btn btn-danger btn-sm';
    purgeBtn.type = 'button';
    purgeBtn.textContent = L.deletePermanent;
    purgeBtn.onclick = (function(id) {
      return function() { purgeDeletedDoctor(id); };
    })(row.doctor_id);

    tdActions.appendChild(restoreBtn);
    tdActions.appendChild(purgeBtn);

    tr.appendChild(tdInfo);
    tr.appendChild(tdColor);
    tr.appendChild(tdDeleted);
    tr.appendChild(tdActions);

    tbody.appendChild(tr);
  }
}

function loadDeletedDoctors() {
  var statusEl = document.getElementById('deleted-status');
  if (statusEl) {
    statusEl.style.display = 'none';
  }
  fetch('/admin/settings/colors/deleted', { credentials: 'same-origin' })
    .then(function(response) { return response.json(); })
    .then(function(result) {
      if (result.success) {
        renderDeletedDoctors(result.deleted || []);
      } else if (statusEl) {
        statusEl.textContent = result.errors ? result.errors.join(', ') : 'Failed to load deleted doctors.';
        statusEl.className = 'alert alert-error';
        statusEl.style.display = 'block';
      }
    })
    .catch(function() {
      if (statusEl) {
        statusEl.textContent = 'Failed to load deleted doctors.';
        statusEl.className = 'alert alert-error';
        statusEl.style.display = 'block';
      }
    });
}

function restoreDeletedDoctor(doctorId) {
  if (!doctorId) return;
  fetch('/admin/settings/colors/restore', {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': CSRF_TOKEN
    },
    body: JSON.stringify({ doctor_id: doctorId, csrf_token: CSRF_TOKEN })
  })
    .then(function(response) { return response.json(); })
    .then(function(result) {
      if (result.success) {
        location.reload();
      } else {
        alert('Error: ' + (result.errors ? result.errors.join(', ') : 'Unknown error'));
      }
    })
    .catch(function() {
      alert('Error restoring doctor');
    });
}

function purgeDeletedDoctor(doctorId) {
  if (!doctorId) return;
  if (!confirm('Permanently delete this doctor from history?')) {
    return;
  }
  fetch('/admin/settings/colors/purge', {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': CSRF_TOKEN
    },
    body: JSON.stringify({ doctor_id: doctorId, csrf_token: CSRF_TOKEN })
  })
    .then(function(response) { return response.json(); })
    .then(function(result) {
      if (result.success) {
        loadDeletedDoctors();
      } else {
        alert('Error: ' + (result.errors ? result.errors.join(', ') : 'Unknown error'));
      }
    })
    .catch(function() {
      alert('Error deleting doctor');
    });
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
  var modals = document.querySelectorAll('.modal');
  for (var i = 0; i < modals.length; i++) {
    var modal = modals[i];
    if (event.target === modal) {
      closeModal();
    }
  }
});

// Close modal on Escape key
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    closeModal();
  }
});

// Patient Settings Functions
function savePatientSettings() {
  var statusEl = document.getElementById('patient-settings-status');
  var enableFileNumbers = document.getElementById('enable-file-numbers').checked;

  statusEl.style.display = 'none';
  statusEl.textContent = '';
  statusEl.className = 'alert';

  fetch('/api/admin/patient-settings', {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': CSRF_TOKEN
    },
    body: JSON.stringify({
      enable_file_numbers: enableFileNumbers,
      csrf_token: CSRF_TOKEN
    })
  })
    .then(function(res) {
      return res.json().then(function(data) {
        return { res: res, data: data };
      });
    })
    .then(function(result) {
      var res = result.res;
      var data = result.data;
      if (!res.ok || !data.success) {
        var errs = (data.errors || ['Failed to save patient settings']).join(', ');
        statusEl.textContent = errs;
        statusEl.className = 'alert alert-error';
        statusEl.style.display = 'block';
        return;
      }
      statusEl.textContent = 'Patient settings saved successfully.';
      statusEl.className = 'alert alert-success';
      statusEl.style.display = 'block';
    })
    .catch(function() {
      statusEl.textContent = 'An error occurred while saving patient settings.';
      statusEl.className = 'alert alert-error';
      statusEl.style.display = 'block';
    });
}

function saveImportSettings() {
  var statusEl = document.getElementById('data-import-settings-status');
  var skipDup = document.getElementById('data-import-skip-duplicates');
  var importZero = document.getElementById('data-import-import-zero');
  var neverAutoMerge = document.getElementById('data-import-never-auto-merge');
  if (!statusEl || !neverAutoMerge) return;

  statusEl.style.display = 'none';
  statusEl.textContent = '';
  statusEl.className = 'alert';

  fetch('/api/admin/patient-settings', {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': CSRF_TOKEN
    },
    body: JSON.stringify({
      import_skip_duplicates: Boolean(skipDup && skipDup.checked),
      import_import_zero_entries: Boolean(importZero && importZero.checked),
      import_never_auto_merge: Boolean(neverAutoMerge.checked),
      csrf_token: CSRF_TOKEN
    })
  })
    .then(function(res) {
      return res.json().then(function(data) {
        return { res: res, data: data };
      });
    })
    .then(function(result) {
      var res = result.res;
      var data = result.data || {};
      if (!res.ok || !data.success) {
        var errs = (data.errors || [L.genericError || 'Error']).join(', ');
        statusEl.textContent = errs;
        statusEl.className = 'alert alert-error';
        statusEl.style.display = 'block';
        return;
      }
      statusEl.textContent = '{{ tf("data_import_settings_saved", "Import settings saved.") }}';
      statusEl.className = 'alert alert-success';
      statusEl.style.display = 'block';
    })
    .catch(function() {
      statusEl.textContent = L.genericError || 'Error';
      statusEl.className = 'alert alert-error';
      statusEl.style.display = 'block';
    });
}

function addPageRange() {
  var container = document.getElementById('page-ranges-container');
  var rangeCount = container.querySelectorAll('.page-range-row').length;

  var rangeRow = document.createElement('div');
  rangeRow.className = 'page-range-row';
  rangeRow.setAttribute('data-range-id', rangeCount);
  rangeRow.innerHTML = `
    <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
      <input type="text" class="form-input" style="flex: 1;"
             placeholder="{{ tf('range_name', 'Range name') }}">
      <input type="text" class="form-input" style="width: 120px;"
             placeholder="{{ tf('start', 'Start') }}">
      <input type="text" class="form-input" style="width: 120px;"
             placeholder="{{ tf('end', 'End') }}">
      <button type="button" class="btn btn-danger btn-sm" onclick="removePageRange(${rangeCount})">{{ tf('remove', 'Remove') }}</button>
    </div>
  `;

  container.appendChild(rangeRow);
}

function removePageRange(rangeId) {
  var row = document.querySelector(`[data-range-id="${rangeId}"]`);
  if (row) {
    row.remove();
  }
}

// Handle custom format visibility
document.addEventListener('DOMContentLoaded', function() {
  var pageFormatSelect = document.getElementById('default-page-format');
  var customFormatGroup = document.getElementById('custom-format-group');

  if (pageFormatSelect && customFormatGroup) {
    pageFormatSelect.addEventListener('change', function() {
      if (this.value === 'custom') {
        customFormatGroup.style.display = 'block';
      } else {
        customFormatGroup.style.display = 'none';
      }
    });
  }
});

// Theme preview on load
document.addEventListener('DOMContentLoaded', function() {
  if (typeof attachThemePreview === 'function') {
    attachThemePreview();
  }
  // Activate tab from hash if present
  var hash = window.location.hash.replace('#', '');
  if (hash) {
    switchTab(null, hash);
  } else {
    var firstTab = document.querySelector('.admin-tab');
    if (firstTab) {
      firstTab.classList.add('active');
    }
  }
  initDataTabUi();
  initSelectedDataFileUi();
  initAnalyzeUi();
  loadDeletedDoctors();
  refreshBackups();
});
</script>

{% endblock %}
