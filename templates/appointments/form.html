{% extends '_base.html' %}
{% block content %}
<style>
.patient-suggestions {
  position: absolute;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 1000;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.patient-suggestion {
  padding: 8px 12px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
}

.patient-suggestion:hover {
  background-color: #f5f5f5;
}

.patient-suggestion:last-child {
  border-bottom: none;
}

.patient-suggestion-name {
  font-weight: bold;
}

.patient-suggestion-details {
  font-size: 0.9em;
  color: #666;
}

.selected-patient-card {
  display: block;
  margin-bottom: 20px;
  padding: 16px;
  border: 2px solid #3b82f6;
  border-radius: 10px;
  background: #eff6ff;
  color: #1e3a8a;
  text-decoration: none;
  transition: box-shadow 0.2s ease;
}

.selected-patient-card:hover {
  box-shadow: 0 4px 16px rgba(59, 130, 246, 0.25);
}

.selected-patient-card .patient-meta {
  display: flex;
  gap: 16px;
  font-size: 0.95rem;
  color: #1f2937;
}

.selected-patient-card .patient-id {
  font-weight: 700;
  font-size: 1.1rem;
}
</style>
<div class="card appointment-form">
  <h1>{{ t('appointments_new') }}</h1>
  {% if patient_card %}
    <a class="selected-patient-card" href="{{ url_for('patients.patient_detail', pid=patient_card.id) }}">
      <div class="patient-id">{{ patient_card.short_id or 'â€”' }}</div>
      <div class="patient-meta">
        <div>{{ patient_card.name or '-' }}</div>
        <div>{{ patient_card.phone or 'No phone' }}</div>
      </div>
      <small>{{ t('click_to_view_patient') if t('click_to_view_patient') != 'click_to_view_patient' else 'Click to open patient file' }}</small>
    </a>
  {% endif %}
  <form method="post">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="appointment_id" value="{{ defaults.appointment_id if defaults else '' }}">
    <input type="hidden" name="patient_short_id" id="patient-short-id" value="{{ defaults.patient_short_id if defaults else '' }}">
    <div class="form-grid">
      <label>
        <span>{{ t('appointments_day_label') }}</span>
        <input type="date" name="day" value="{{ defaults.day if defaults else '' }}">
      </label>
      <label>
        <span>{{ t('appointments_slot_label') }}</span>
        <input type="time" name="start_time" value="{{ defaults.start_time if defaults else '09:00' }}">
      </label>
      <label>
        <span>{{ t('appointments_doctor_label') }}</span>
        <select name="doctor_id">
          {% for value, label in doctors %}
            <option value="{{ value }}" {% if defaults and defaults.doctor_id == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </label>
      <label>
        <span>{{ t('appointments_title_label') }}</span>
        <input name="title" required value="{{ defaults.title if defaults else '' }}">
      </label>
      {% if not editing %}
      <label>
        <span>Search Patient</span>
        <input type="text" name="patient_search" id="patient-search" placeholder="Search by name, phone, or file number" value="{{ defaults.patient_search if defaults else '' }}" autocomplete="off">
        <input type="hidden" name="patient_id" id="patient-id" value="{{ defaults.patient_id if defaults else '' }}">
        <div id="patient-suggestions" class="patient-suggestions" style="display: none;"></div>
      </label>
      {% else %}
        <input type="hidden" name="patient_id" id="patient-id" value="{{ defaults.patient_id if defaults else '' }}">
      {% endif %}
      <label>
        <span>Patient Name</span>
        <input name="patient_name" id="patient-name" value="{{ defaults.patient_name if defaults else '' }}" readonly>
      </label>
      <label>
        <span>Patient Phone</span>
        <input name="patient_phone" id="patient-phone" value="{{ defaults.patient_phone if defaults else '' }}" readonly>
      </label>
      <label class="notes-field">
        <span>{{ t('appointments_notes_label') }}</span>
        <textarea name="notes">{{ defaults.notes if defaults else '' }}</textarea>
      </label>
    </div>
    <div class="form-actions">
      <button class="btn">{{ t('appointments_submit') }}</button>
      <a class="btn secondary" href="{{ url_for('appointments.table') }}">{{ t('back') }}</a>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('patient-search');
    const patientIdInput = document.getElementById('patient-id');
    const patientNameInput = document.getElementById('patient-name');
    const patientPhoneInput = document.getElementById('patient-phone');
    const patientShortIdInput = document.getElementById('patient-short-id');
    const suggestionsContainer = document.getElementById('patient-suggestions');
    let searchTimeout;

    if (!searchInput) {
        return;
    }

    function showSuggestions(suggestions) {
        suggestionsContainer.innerHTML = '';
        if (suggestions.length === 0) {
            suggestionsContainer.style.display = 'none';
            return;
        }

        suggestions.forEach(patient => {
            const suggestion = document.createElement('div');
            suggestion.className = 'patient-suggestion';
            suggestion.innerHTML = `
                <div class="patient-suggestion-name">${patient.full_name}</div>
                <div class="patient-suggestion-details">${patient.short_id || 'No ID'} | ${patient.phone || 'No phone'}</div>
            `;
            suggestion.addEventListener('click', () => selectPatient(patient));
            suggestionsContainer.appendChild(suggestion);
        });

        suggestionsContainer.style.display = 'block';
    }

    function selectPatient(patient) {
        patientIdInput.value = patient.id;
        patientNameInput.value = patient.full_name;
        patientPhoneInput.value = patient.phone || '';
        patientShortIdInput.value = patient.short_id || '';
        searchInput.value = patient.full_name;
        suggestionsContainer.style.display = 'none';
    }

    function hideSuggestions() {
        setTimeout(() => {
            suggestionsContainer.style.display = 'none';
        }, 200);
    }

    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        // Clear previous patient selection
            if (!query) {
                patientIdInput.value = '';
                patientNameInput.value = '';
                patientPhoneInput.value = '';
                patientShortIdInput.value = '';
                suggestionsContainer.style.display = 'none';
                return;
            }

        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            if (query.length < 2) {
                suggestionsContainer.style.display = 'none';
                return;
            }

            // Make API call to search patients
            fetch(`/patients/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(patients => {
                    showSuggestions(patients);
                })
                .catch(error => {
                    console.error('Error searching patients:', error);
                    suggestionsContainer.style.display = 'none';
                });
        }, 300);
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
            suggestionsContainer.style.display = 'none';
        }
    });

    // Hide suggestions when search input loses focus
    searchInput.addEventListener('blur', hideSuggestions);
});
</script>
{% endblock %}
