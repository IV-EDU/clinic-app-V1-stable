{% extends '_base.html' %}
{% block content %}
<style>
/* Doctor Color Coding */
.appt-card.doctor-dr-omar {
  border-left-color: #3B82F6 !important;
}

.appt-card.doctor-dr-lina {
  border-left-color: #10B981 !important;
}

.appt-card.doctor-on-call {
  border-left-color: #F59E0B !important;
}

.appt-card.doctor-default {
  border-left-color: #6B7280 !important;
}

/* Time-based Visual Cues */
.appt-card.time-scheduled {
  background-color: #f8fafc;
}

.appt-card.time-upcoming {
  background-color: #fffbeb;
  border-left-width: 6px;
}

.appt-card.time-in-progress {
  background-color: #eff6ff;
  box-shadow: 0 0 0 2px #3B82F6;
}

.appt-card.time-overdue {
  background-color: #fef2f2;
  border-left-color: #EF4444 !important;
  border-left-width: 6px;
}

.appt-head {
  display: flex;
  justify-content: space-between;
  gap: 12px;
}

.appt-head-right {
  display: flex;
  align-items: center;
  gap: 6px;
}

.filters-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
  width: 100%;
}

.filter-field {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.filter-actions {
  display: flex;
  align-items: flex-end;
  gap: 12px;
  flex-wrap: wrap;
}

.view-selector select {
  width: 100%;
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  font-size: 0.95rem;
}

.appt-card {
  cursor: default;
}

.appt-actions {
  position: relative;
  display: inline-block;
  margin-left: 8px;
}

.appt-actions button {
  background: transparent;
  border: none;
  font-size: 18px;
  cursor: pointer;
  color: #6b7280;
  padding: 0 6px;
}

.action-menu {
  position: absolute;
  right: 0;
  top: 28px;
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  box-shadow: 0 8px 24px rgba(15, 23, 42, 0.15);
  display: none;
  min-width: 140px;
  z-index: 20;
  padding: 6px 0;
}

.action-menu.open {
  display: block;
}

.action-menu a,
.action-menu button {
  display: block;
  width: 100%;
  text-align: left;
  padding: 8px 14px;
  background: transparent;
  border: none;
  font-size: 14px;
  color: #1f2937;
  cursor: pointer;
}

.action-menu button.menu-danger {
  color: #b91c1c;
}

.action-menu a:hover,
.action-menu button:hover {
  background: #f3f4f6;
}

.patient-badge {
  display: flex;
  flex-direction: column;
  gap: 2px;
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid #bfdbfe;
  background: #eff6ff;
  color: #1e3a8a;
  font-size: 0.8rem;
  margin-bottom: 8px;
}

.patient-badge .badge-name {
  font-weight: 600;
  color: #0f172a;
}

.patient-badge .badge-meta {
  color: #475569;
  font-size: 0.72rem;
}

.patient-badge--link {
  text-decoration: none;
}

.patient-badge--link:hover {
  box-shadow: 0 2px 6px rgba(37, 99, 235, 0.25);
}

.patient-badge--static {
  cursor: default;
}

.patient-chip {
  display: flex;
  flex-direction: column;
  gap: 4px;
  padding: 12px 14px;
  border-radius: 14px;
  border: 1px solid #c7d2fe;
  background: #eef2ff;
  color: #1e1b4b;
}

.patient-chip--link {
  text-decoration: none;
}

.patient-chip--link:hover {
  box-shadow: 0 12px 25px rgba(79, 70, 229, 0.25);
}

.patient-chip__name {
  font-weight: 600;
  font-size: 1rem;
}

.patient-chip__meta {
  font-size: 0.85rem;
  color: #4338ca;
}

.chip-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 10px;
}

.info-chip {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 6px 12px;
  border-radius: 999px;
  border: 1px solid #c7d2fe;
  background: #f4f4ff;
  color: #4338ca;
  font-size: 0.78rem;
}

.info-chip--time {
  background: #f8fafc;
  border-color: #cbd5f5;
  color: #0f172a;
}

.doctor-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 8px;
}

.expandable-chip {
  padding: 6px 10px;
  border-radius: 6px;
  background: #fef3c7;
  color: #92400e;
  border: 1px solid #fcd34d;
  max-height: 38px;
  overflow: hidden;
  cursor: pointer;
  transition: box-shadow 0.2s ease;
}

.expandable-chip.expanded {
  max-height: none;
  box-shadow: 0 2px 6px rgba(146, 64, 14, 0.2);
}

.status-chip {
  border: 1px solid #93c5fd;
  color: #1d4ed8;
  background: #eff6ff;
  padding: 6px 10px;
  border-radius: 14px;
  font-size: 12px;
  cursor: pointer;
}
.status-chip.is-done {
  background: #dcfce7;
  border-color: #86efac;
  color: #065f46;
}
.status-chip.saving { opacity: .6; cursor: progress; }
.status-chip.error { box-shadow: 0 0 0 2px rgba(239,68,68,.3); }

.ghost-btn {
  border: 1px solid #dbeafe;
  background: #fff;
  color: #1d4ed8;
  border-radius: 999px;
  padding: 6px 14px;
  font-size: 0.85rem;
}

.ghost-btn:hover {
  background: #1d4ed8;
  color: #fff;
}

.appt-footer {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 14px;
  flex-wrap: wrap;
}

.timeline-day {
  margin-bottom: 32px;
}

.timeline-day__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.timeline-day__eyebrow {
  text-transform: uppercase;
  font-size: 12px;
  color: #94a3b8;
  letter-spacing: 0.08em;
}
</style>
<div class="card appointment-hero">
  <div>
    <div class="eyebrow">{{ t('appointments') }}</div>
    <h1>{{ t('appointments_today') }}</h1>
    <p class="muted">{{ t('appointments_filters') }}</p>
  </div>
  <form method="get" class="filters filters-grid">
    <div class="filter-field">
      <label>{{ t('appointments_day_label') }}</label>
      <input type="date" name="day" value="{{ day }}">
    </div>
    <div class="filter-field">
      <label>{{ t('appointments_doctor_label') }}</label>
      <select name="doctor">
        {% for value, label in doctors %}
          <option value="{{ value }}" {% if value == selected_doctor %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="filter-field">
      <label>{{ t('appointments_range_label') }}</label>
      <select name="range">
        {% for value, label in range_choices %}
          <option value="{{ value }}" {% if value == selected_range %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="filter-field view-selector">
      <label>{{ t('view') }}</label>
      <select id="view-selector"
              data-current="{{ current_view or 'timeline' }}"
              data-day="{{ day }}"
              data-doctor="{{ selected_doctor }}"
              data-range="{{ selected_range }}"
              data-search="{{ search_query }}"
              data-table-base="{{ url_for('appointments.table') }}"
              data-multi-base="{{ url_for('multi_doctor.multi_doctor') }}">
        <option value="table">{{ t('appointments_table_view') if t('appointments_table_view') != 'appointments_table_view' else 'Table View' }}</option>
        <option value="multi">{{ t('appointments_multi_view') if t('appointments_multi_view') != 'appointments_multi_view' else 'Multi-Doctor View' }}</option>
      </select>
    </div>
    <div class="filter-field">
      <label>{{ t('appointments_search_label') }}</label>
      <input type="text" name="q" placeholder="{{ t('appointments_search_placeholder') }}" value="{{ search_query }}">
    </div>
    <div class="filter-actions">
      <button class="btn">{{ t('filter') }}</button>
      <a class="btn primary" href="{{ url_for('appointments.new', day=day, doctor=selected_doctor) }}">➕ {{ t('appointments_new') }}</a>
    </div>
  </form>
</div>

<div class="card appointment-stats">
  {% for label, value in stats %}
    <div class="stat-tile">
      <div class="stat-label">{{ t(label) }}</div>
      <div class="stat-value">{{ value }}</div>
    </div>
  {% endfor %}
</div>

{% include 'appointments/_schedule_modal.html' %}

<div class="card timeline-card">
  {% for section in timeline_sections %}
    <div class="timeline-day">
      <div class="timeline-day__header">
        <div>
          <div class="timeline-day__eyebrow">{{ t('appointments_day_label') }}</div>
          <h2>{{ section.day }}</h2>
        </div>
      </div>
      <div class="timeline-grid">
        {% for block in section.blocks %}
          <div class="timeline-hour">
            <div class="hour-label">{{ block.hour|int % 12 if block.hour|int % 12 != 0 else 12 }}:00 {{ 'PM' if block.hour|int >= 12 else 'AM' }}</div>
            <div class="hour-body">
              {% if block.entries %}
                {% for appt in block.entries %}
                  {%- set patient_url = url_for('patients.patient_detail', pid=appt.patient_id) if appt.patient_id else '' -%}
                  {% set badge_file = appt.patient_short_id or '—' %}
                  {% set chip_time = appt.time_label or appt.starts_at[11:16] ~ ' → ' ~ appt.ends_at[11:16] %}
                  {% set modal_payload = {
                    'patient_name': appt.patient_name or '-',
                    'file_no': badge_file,
                    'phone': appt.patient_phone or '—',
                    'selected': {
                      'doctor': appt.doctor_label,
                      'time': chip_time,
                      'title': appt.title,
                      'status_label': t('appointment_status_' + appt.status),
                      'notes': appt.notes or '',
                    },
                    'schedules': [
                      {
                        'id': appt.id,
                        'title': appt.title,
                        'doctor': appt.doctor_label,
                        'time': chip_time,
                        'notes': appt.notes or '',
                        'status': appt.status,
                        'status_label': t('appointment_status_' + appt.status),
                        'edit_url': url_for('appointments.edit', appt_id=appt.id),
                      }
                    ],
                  } %}
                  <div class="appt-card status-{{ appt.status }} time-{{ appt.time_status }} doctor-{{ appt.doctor_id }}">
                    {% if patient_url %}
                      <a class="patient-chip patient-chip--link" href="{{ patient_url }}">
                        <span class="patient-chip__name">{{ appt.patient_name or '-' }}</span>
                        <span class="patient-chip__meta">{{ t('file_no') }}: {{ badge_file }} · {{ appt.patient_phone or '—' }}</span>
                      </a>
                    {% else %}
                      <div class="patient-chip">
                        <span class="patient-chip__name">{{ appt.patient_name or '-' }}</span>
                        <span class="patient-chip__meta">{{ t('file_no') }}: {{ badge_file }} · {{ appt.patient_phone or '—' }}</span>
                      </div>
                    {% endif %}
                    <div class="chip-row">
                      <span class="info-chip">{{ appt.doctor_label }}</span>
                      <span class="info-chip info-chip--time">{{ chip_time }}</span>
                    </div>
                    <div class="appt-body">
                      <div class="visit-title">{{ appt.title }}</div>
                      {% if appt.notes %}
                        <p class="visit-notes">{{ appt.notes[:160] }}{% if appt.notes|length > 160 %}…{% endif %}</p>
                      {% endif %}
                    </div>
                    <div class="appt-footer">
                      <button type="button" class="ghost-btn" data-group='{{ modal_payload | tojson }}'>{{ t('view') }}</button>
                      <button type="button"
                              class="status-chip {{ 'is-done' if appt.status=='done' else 'is-scheduled' }}"
                              data-appt-id="{{ appt.id }}"
                              data-status="{{ 'done' if appt.status=='done' else 'scheduled' }}"
                              data-label-scheduled="{{ t('appointment_status_scheduled') }}"
                              data-label-done="{{ t('appointment_status_done') }}"
                              aria-pressed="{{ 'true' if appt.status=='done' else 'false' }}">
                        {{ t('appointment_status_' + appt.status) }}
                      </button>
                      <div class="appt-actions">
                        <button type="button" aria-label="{{ t('actions') }}" data-menu-trigger>⋮</button>
                        <div class="action-menu">
                          <a href="{{ url_for('appointments.edit', appt_id=appt.id) }}">{{ t('edit') }}</a>
                          <form method="post" action="{{ url_for('appointments.delete', appt_id=appt.id) }}" onsubmit="return confirm('{{ t('confirm_delete') if t('confirm_delete') != 'confirm_delete' else 'Delete this appointment?' }}')">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="next" value="{{ request.full_path }}">
                            <button type="submit" class="menu-danger">{{ t('delete') }}</button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <div class="empty-hour">{{ t('appointments_empty_hour') }}</div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endfor %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const viewSelector = document.getElementById('view-selector');
    if (viewSelector) {
        const current = viewSelector.dataset.current || 'timeline';
        viewSelector.value = current;
        viewSelector.addEventListener('change', function() {
            const target = this.value;
            const day = this.dataset.day;
            const doctor = this.dataset.doctor;
            const tableBase = this.dataset.tableBase;
                        const multiBase = this.dataset.multiBase;
            const rangeVal = this.dataset.range;
            const searchVal = this.dataset.search;
            const query = new URLSearchParams();
            if (day) query.set('day', day);
            if (doctor && doctor !== 'all') query.set('doctor', doctor);
            if (rangeVal && rangeVal !== 'today') query.set('range', rangeVal);
            if (searchVal) query.set('q', searchVal);

            if (target === 'multi') {
                const multiParams = new URLSearchParams();
                if (day) multiParams.set('day', day);
                if (rangeVal && rangeVal !== 'today') multiParams.set('range', rangeVal);
                if (searchVal) multiParams.set('q', searchVal);
                window.location.href = `${multiBase}?${multiParams.toString()}`;
                return;
            }

            window.location.href = `${tableBase}?${query.toString()}`;
        });
    }

    const closeMenus = () => {
        document.querySelectorAll('.action-menu.open, .action-menu__panel.open').forEach(menu => menu.classList.remove('open'));
    };

    document.querySelectorAll('[data-menu-trigger]').forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
            const menu = this.nextElementSibling;
            if (!menu) return;
            const isOpen = menu.classList.contains('open');
            closeMenus();
            if (!isOpen) {
                menu.classList.add('open');
            }
        });
    });

    document.querySelectorAll('.action-menu, .action-menu__panel').forEach(panel => {
        panel.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });

    document.addEventListener('click', closeMenus);

    document.querySelectorAll('[data-expandable]').forEach(chip => {
        chip.addEventListener('click', function() {
            this.classList.toggle('expanded');
        });
    });
});
</script>

{% endblock %}
