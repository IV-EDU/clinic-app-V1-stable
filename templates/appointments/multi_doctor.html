{% extends '_base.html' %}
{% block content %}
<style>
.multi-doctor-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin: 20px 0;
}

.doctor-column {
  background: #f8fafc;
  border-radius: 10px;
  border: 1px solid #e5e7eb;
  display: flex;
  flex-direction: column;
  min-height: 300px;
}

.doctor-header {
  background: #1f2937;
  color: white;
  padding: 16px;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-left: 4px solid;
}

.doctor-appointments {
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  max-height: 65vh;
  overflow-y: auto;
}

.doctor-appointment-card {
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  position: relative;
  cursor: default;
  border-left: 4px solid var(--doctor-color, #6b7280);
}

.doctor-appointment-card:hover {
  box-shadow: 0 4px 12px rgba(15, 23, 42, 0.12);
}

.doctor-card-head {
  display: flex;
  justify-content: space-between;
  gap: 16px;
}

.doctor-card-meta {
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-size: 0.9rem;
  color: #475569;
}

.patient-badge {
  display: flex;
  flex-direction: column;
  gap: 2px;
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid #bfdbfe;
  background: #eff6ff;
  color: #1e3a8a;
  font-size: 0.8rem;
}

.patient-badge .badge-name {
  font-weight: 600;
  color: #0f172a;
}

.patient-badge .badge-meta {
  color: #475569;
  font-size: 0.72rem;
}

.patient-badge--link {
  text-decoration: none;
}

.patient-badge--link:hover {
  box-shadow: 0 2px 6px rgba(37, 99, 235, 0.25);
}

.patient-badge--static {
  cursor: default;
}

.patient-chip {
  display: flex;
  flex-direction: column;
  gap: 4px;
  padding: 12px 14px;
  border-radius: 14px;
  border: 1px solid #c7d2fe;
  background: #eef2ff;
  color: #1e1b4b;
  margin-bottom: 8px;
}

.patient-chip--link {
  text-decoration: none;
}

.patient-chip--link:hover {
  box-shadow: 0 12px 25px rgba(79, 70, 229, 0.25);
}

.patient-chip__name {
  font-weight: 600;
  font-size: 1rem;
}

.patient-chip__meta {
  font-size: 0.85rem;
  color: #4338ca;
}

.chip-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.info-chip {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 6px 12px;
  border-radius: 999px;
  border: 1px solid #c7d2fe;
  background: #f4f4ff;
  color: #4338ca;
  font-size: 0.78rem;
}

.info-chip--time {
  background: #f8fafc;
  border-color: #cbd5f5;
  color: #0f172a;
}

.doctor-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.expandable-chip {
  padding: 4px 8px;
  border-radius: 6px;
  background: #fef3c7;
  color: #92400e;
  border: 1px solid #fcd34d;
  max-height: 34px;
  overflow: hidden;
  cursor: pointer;
  transition: box-shadow 0.2s ease;
}

.expandable-chip.expanded {
  max-height: none;
  box-shadow: 0 2px 6px rgba(146, 64, 14, 0.2);
}

.status-chip {
  border: 1px solid #93c5fd;
  color: #1d4ed8;
  background: #eff6ff;
  padding: 6px 10px;
  border-radius: 14px;
  font-size: 12px;
  cursor: pointer;
}
.status-chip.is-done {
  background: #dcfce7;
  border-color: #86efac;
  color: #065f46;
}
.status-chip.saving { opacity: .6; cursor: progress; }
.status-chip.error { box-shadow: 0 0 0 2px rgba(239,68,68,.3); }

.status-toggle {
  display: inline-flex;
  border: 1px solid #93c5fd;
  border-radius: 999px;
  overflow: hidden;
}
.status-toggle .status-chip {
  border: none;
  border-radius: 0;
  background: transparent;
  color: #1d4ed8;
  flex: 1;
  margin: 0;
  justify-content: center;
}
.status-toggle .status-chip + .status-chip {
  border-left: 1px solid #bfdbfe;
}
.status-toggle .status-chip.is-active {
  background: #1d4ed8;
  color: #fff;
}
.status-toggle .status-chip[aria-pressed="true"] {
  font-weight: 600;
}
.status-toggle.saving {
  opacity: .7;
}

.ghost-btn {
  border: 1px solid #dbeafe;
  background: #fff;
  color: #1d4ed8;
  border-radius: 999px;
  padding: 6px 14px;
  font-size: 0.85rem;
}

.ghost-btn:hover {
  background: #1d4ed8;
  color: #fff;
}

.visit-notes {
  color: #475569;
  font-size: 0.9rem;
  margin: 8px 0 0;
}

.filters-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  width: 100%;
}

.filter-field {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.filter-actions {
  display: flex;
  align-items: flex-end;
  gap: 12px;
  flex-wrap: wrap;
}

.view-selector select {
  width: 100%;
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  font-size: 0.95rem;
}

.action-menu {
  position: relative;
}

.action-menu button {
  background: transparent;
  border: none;
  font-size: 18px;
  cursor: pointer;
  color: #6b7280;
  padding: 0 6px;
}

.action-menu__panel {
  position: absolute;
  right: 0;
  top: 28px;
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  box-shadow: 0 8px 24px rgba(15, 23, 42, 0.15);
  display: none;
  min-width: 140px;
  z-index: 20;
  padding: 6px 0;
}

.action-menu__panel.open {
  display: block;
}

.action-menu__panel a,
.action-menu__panel button {
  display: block;
  width: 100%;
  text-align: left;
  padding: 8px 14px;
  background: transparent;
  border: none;
  font-size: 14px;
  color: #1f2937;
  cursor: pointer;
}

.action-menu__panel button.menu-danger {
  color: #b91c1c;
}

.patient-badge {
  display: flex;
  flex-direction: column;
  gap: 2px;
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid #bfdbfe;
  background: #eff6ff;
  color: #1e3a8a;
  font-size: 0.8rem;
  margin-bottom: 8px;
}

.patient-badge .badge-name {
  font-weight: 600;
  color: #0f172a;
}

.patient-badge .badge-meta {
  color: #475569;
  font-size: 0.72rem;
}

.patient-badge--link {
  text-decoration: none;
}

.patient-badge--link:hover {
  box-shadow: 0 2px 6px rgba(37, 99, 235, 0.25);
}

.patient-badge--static {
  cursor: default;
}

.empty-column-state {
  padding: 20px;
  text-align: center;
  color: #6b7280;
  border: 1px dashed #cbd5f5;
  border-radius: 8px;
  background: #f8fafc;
}
</style>

<div class="card">
  <div class="card-header">
    <h1>{{ t('appointments_multi_view') if t('appointments_multi_view') != 'appointments_multi_view' else 'Multi-Doctor View' }}</h1>
    <p>{{ selected_range_label }} · {{ selected_show_label }}</p>
  </div>
  
  <form method="get" class="filters filters-grid">
    <div class="filter-field">
      <label>{{ t('appointments_day_label') }}</label>
      <input type="date" name="day" value="{{ day }}">
    </div>
    <div class="filter-field">
      <label>{{ t('appointments_show_label') }}</label>
      <select name="show">
        {% for value, label in show_choices %}
          <option value="{{ value }}" {% if value == selected_show %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="filter-field">
      <label>{{ t('appointments_range_label') }}</label>
      <select name="range">
        {% for value, label in range_choices %}
          <option value="{{ value }}" {% if value == selected_range %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="filter-field view-selector">
      <label>{{ t('view') }}</label>
      <select id="view-selector"
              data-current="{{ current_view or 'multi' }}"
              data-day="{{ day }}"
              data-doctor="all"
              data-range="{{ selected_range or 'today' }}"
              data-show="{{ selected_show or 'upcoming' }}"
              data-search="{{ search_query or '' }}"
              data-table-base="{{ url_for('appointments.table') }}"
              data-multi-base="{{ url_for('multi_doctor.multi_doctor') }}">
        <option value="table">{{ t('appointments_table_view') if t('appointments_table_view') != 'appointments_table_view' else 'Table View' }}</option>
        <option value="multi">{{ t('appointments_multi_view') if t('appointments_multi_view') != 'appointments_multi_view' else 'Multi-Doctor View' }}</option>
      </select>
    </div>
    <div class="filter-field">
      <label>{{ t('appointments_search_label') }}</label>
      <input type="text" name="q" placeholder="{{ t('appointments_search_placeholder') }}" value="{{ search_query }}">
    </div>
    <div class="filter-actions">
      <button class="btn">{{ t('filter') }}</button>
      <a class="btn primary" href="{{ url_for('appointments.new', day=day) }}">➕ {{ t('appointments_new') }}</a>
    </div>
  </form>
</div>

{% include 'appointments/_schedule_modal.html' %}

<div class="card">
  <div class="multi-doctor-container">
    {% for doctor_id, doctor_data in all_appointments.items() %}
    <div class="doctor-column" data-doctor="{{ doctor_id }}">
      <div class="doctor-header" 
           style="border-left-color: {{ doctor_colors.get(doctor_id, '#6B7280') }};">
        <div>{{ doctor_data.label }}</div>
        <div class="doctor-stats">
          <small>{{ doctor_data.appointments|length }} appointments</small>
        </div>
      </div>
      
      <div class="doctor-appointments">
        {% if doctor_data.appointments %}
          {% for appt in doctor_data.appointments %}
            {%- set patient_url = url_for('patients.patient_detail', pid=appt.patient_id) if appt.patient_id else '' -%}
            {% set badge_file = appt.patient_short_id or '—' %}
            {% set chip_time = appt.time_label or appt.starts_at[11:16] ~ ' → ' ~ appt.ends_at[11:16] %}
            {% set modal_payload = {
              'patient_name': appt.patient_name or '-',
              'file_no': badge_file,
              'phone': appt.patient_phone or '—',
              'selected': {
                'doctor': appt.doctor_label,
                'time': chip_time,
                'title': appt.title,
                'status_label': t('appointment_status_' + appt.status),
                'notes': appt.notes or '',
              },
              'schedules': [
                {
                  'id': appt.id,
                  'title': appt.title,
                  'doctor': appt.doctor_label,
                  'time': chip_time,
                  'notes': appt.notes or '',
                  'status': appt.status,
                  'status_label': t('appointment_status_' + appt.status),
                  'edit_url': url_for('appointments.edit', appt_id=appt.id),
                }
              ],
            } %}
            {% set normalized_status = 'done' if appt.status == 'done' else 'scheduled' %}
            <div class="doctor-appointment-card time-{{ appt.time_status }}" style="--doctor-color: {{ doctor_colors.get(doctor_id, '#6B7280') }};">
              {% if patient_url %}
                <a class="patient-chip patient-chip--link" href="{{ patient_url }}">
                  <span class="patient-chip__name">{{ appt.patient_name or '-' }}</span>
                  <span class="patient-chip__meta">{{ t('file_no') }}: {{ badge_file }} · {{ appt.patient_phone or '—' }}</span>
                </a>
              {% else %}
                <div class="patient-chip">
                  <span class="patient-chip__name">{{ appt.patient_name or '-' }}</span>
                  <span class="patient-chip__meta">{{ t('file_no') }}: {{ badge_file }} · {{ appt.patient_phone or '—' }}</span>
                </div>
              {% endif %}
              <div class="chip-row">
                <span class="info-chip">{{ appt.title }}</span>
                <span class="info-chip info-chip--time">{{ chip_time }}</span>
                {% if selected_range != 'today' %}
                  <span class="info-chip info-chip--tiny">{{ appt.starts_at[:10] }}</span>
                {% endif %}
              </div>
              {% if appt.notes %}
                <p class="visit-notes">{{ appt.notes[:120] }}{% if appt.notes|length > 120 %}…{% endif %}</p>
              {% endif %}
              <div class="doctor-card-head" style="justify-content:space-between;align-items:center;">
                <button type="button" class="ghost-btn" data-group='{{ modal_payload | tojson }}'>{{ t('view') }}</button>
                <div class="action-menu">
                  <button type="button" aria-label="{{ t('actions') }}" data-menu-trigger>⋮</button>
                  <div class="action-menu__panel">
                    <a href="{{ url_for('appointments.edit', appt_id=appt.id) }}">{{ t('edit') }}</a>
                    <form method="post" action="{{ url_for('appointments.delete', appt_id=appt.id) }}" onsubmit="return confirm('{{ t('confirm_delete') if t('confirm_delete') != 'confirm_delete' else 'Delete this appointment?' }}')">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <input type="hidden" name="next" value="{{ request.full_path }}">
                      <button type="submit" class="menu-danger">{{ t('delete') }}</button>
                    </form>
                  </div>
                </div>
              </div>
              <div class="doctor-card-meta" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                <form class="status-toggle"
                      method="post"
                      action="{{ url_for('appointments.status', appt_id=appt.id) }}"
                      data-appt-id="{{ appt.id }}"
                      data-status="{{ normalized_status }}"
                      data-status-url="{{ url_for('appointments.status', appt_id=appt.id) }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <input type="hidden" name="next" value="{{ request.full_path }}">
                  <button type="submit"
                          name="status"
                          value="scheduled"
                          class="status-chip status-option {{ 'is-active' if normalized_status == 'scheduled' else '' }}"
                          data-status-choice="scheduled"
                          aria-pressed="{{ 'true' if normalized_status == 'scheduled' else 'false' }}">
                    {{ t('appointment_status_scheduled') }}
                  </button>
                  <button type="submit"
                          name="status"
                          value="done"
                          class="status-chip status-option {{ 'is-active' if normalized_status == 'done' else '' }}"
                          data-status-choice="done"
                          aria-pressed="{{ 'true' if normalized_status == 'done' else 'false' }}">
                    {{ t('appointment_status_done') }}
                  </button>
                </form>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="empty-column-state">
            {{ t('appointments_empty_hour') }}
          </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const viewSelector = document.getElementById('view-selector');
  if (viewSelector) {
    const current = viewSelector.dataset.current || 'multi';
    viewSelector.value = current;
    viewSelector.addEventListener('change', function() {
      const target = this.value;
      const day = this.dataset.day;
      const doctor = this.dataset.doctor;
      const tableBase = this.dataset.tableBase;
      const multiBase = this.dataset.multiBase;
      const rangeVal = this.dataset.range;
      const showVal = this.dataset.show;
      const searchVal = this.dataset.search;
      const query = new URLSearchParams();
      if (day) query.set('day', day);
      if (doctor && doctor !== 'all') query.set('doctor', doctor);
      if (rangeVal && rangeVal !== 'today') query.set('range', rangeVal);
      if (showVal && showVal !== 'upcoming') query.set('show', showVal);
      if (searchVal) query.set('q', searchVal);

      if (target === 'table') {
        window.location.href = `${tableBase}?${query.toString()}`;
        return;
      }

      const multiParams = new URLSearchParams();
      if (day) multiParams.set('day', day);
      if (rangeVal && rangeVal !== 'today') multiParams.set('range', rangeVal);
      if (showVal && showVal !== 'upcoming') multiParams.set('show', showVal);
      if (searchVal) multiParams.set('q', searchVal);
      window.location.href = `${multiBase}?${multiParams.toString()}`;
    });
  }

  const closeMenus = () => {
    document.querySelectorAll('.action-menu__panel.open').forEach(menu => menu.classList.remove('open'));
  };

  document.querySelectorAll('[data-menu-trigger]').forEach(button => {
    button.addEventListener('click', function(e) {
      e.stopPropagation();
      const panel = this.nextElementSibling;
      if (!panel) return;
      const isOpen = panel.classList.contains('open');
      closeMenus();
      if (!isOpen) {
        panel.classList.add('open');
      }
    });
  });

  document.querySelectorAll('.action-menu__panel').forEach(panel => {
    panel.addEventListener('click', function(e) {
      e.stopPropagation();
    });
  });

  document.addEventListener('click', closeMenus);
  document.querySelectorAll('[data-expandable]').forEach(chip => {
    chip.addEventListener('click', function() {
      this.classList.toggle('expanded');
    });
  });
});
</script>
{% endblock %}
