{% extends '_base.html' %}
{% block content %}
<style>
.table-view-modern .table-container {
  width: 100%;
  overflow-x: auto;
  padding-bottom: 16px;
}

.appointment-table.modern-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 16px;
  font-size: 14px;
}

.appointment-table.modern-table thead th {
  background: #f8fafc;
  color: #475569;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  font-size: 12px;
  font-weight: 600;
  padding: 14px 18px;
  position: sticky;
  top: 0;
  z-index: 2;
}

.appointment-table.modern-table tbody tr {
  background: #fff;
  border-radius: 16px;
  border-left: 4px solid #cbd5f5;
  box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
  transition: transform 0.15s ease, box-shadow 0.15s ease;
}

.appointment-table.modern-table tbody tr:hover {
  transform: translateY(-2px);
  box-shadow: 0 24px 55px rgba(15, 23, 42, 0.12);
}

.appointment-table.modern-table tbody tr.doctor-dr-omar { border-left-color: #3B82F6; }
.appointment-table.modern-table tbody tr.doctor-dr-lina { border-left-color: #10B981; }
.appointment-table.modern-table tbody tr.doctor-on-call { border-left-color: #F59E0B; }
.appointment-table.modern-table tbody tr.doctor-default { border-left-color: #94a3b8; }
.appointment-table.modern-table tbody tr.time-overdue { border-left-color: #EF4444; }

.appointment-table.modern-table tbody td {
  border: none;
  padding: 18px;
  vertical-align: top;
}

.appointment-table.modern-table tbody td:first-child {
  border-top-left-radius: 16px;
  border-bottom-left-radius: 16px;
}

.appointment-table.modern-table tbody td:last-child {
  border-top-right-radius: 16px;
  border-bottom-right-radius: 16px;
}

.patient-chip {
  display: flex;
  flex-direction: column;
  gap: 4px;
  padding: 12px 14px;
  border-radius: 14px;
  border: 1px solid #c7d2fe;
  background: #eef2ff;
  color: #1e1b4b;
}

.patient-chip--link {
  text-decoration: none;
}

.patient-chip--link:hover {
  box-shadow: 0 12px 25px rgba(79, 70, 229, 0.25);
}

.patient-chip__name {
  font-weight: 600;
  font-size: 1rem;
}

.patient-chip__meta {
  font-size: 0.85rem;
  color: #4338ca;
}

.chip-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 10px;
}

.info-chip {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 6px 12px;
  border-radius: 999px;
  border: 1px solid #c7d2fe;
  background: #f4f4ff;
  color: #4338ca;
  font-size: 0.78rem;
}

.info-chip--time {
  background: #f8fafc;
  border-color: #cbd5f5;
  color: #0f172a;
}

.visit-title {
  font-weight: 600;
  color: #0f172a;
  margin-bottom: 4px;
}

.visit-notes {
  margin: 0;
  color: #475569;
  font-size: 0.92rem;
}

.link-chip {
  margin-top: 10px;
  border: none;
  background: none;
  color: #2563eb;
  padding: 0;
  font-size: 0.85rem;
  cursor: pointer;
  text-decoration: underline;
}

.status-chip {
  border: 1px solid #93c5fd;
  color: #1d4ed8;
  background: #eff6ff;
  padding: 8px 14px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.15s ease, color 0.15s ease, border 0.15s ease;
}

.status-chip.is-done {
  background: #dcfce7;
  border-color: #86efac;
  color: #065f46;
}

.status-chip.saving { opacity: 0.6; cursor: progress; }
.status-chip.error { box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.35); }
.status-toggle {
  display: inline-flex;
  border: 1px solid #93c5fd;
  border-radius: 999px;
  overflow: hidden;
}
.status-toggle .status-chip {
  border: none;
  border-radius: 0;
  background: transparent;
  color: #1d4ed8;
  flex: 1;
  margin: 0;
  justify-content: center;
}
.status-toggle .status-chip + .status-chip {
  border-left: 1px solid #bfdbfe;
}
.status-toggle .status-chip.is-active {
  background: #1d4ed8;
  color: #fff;
}
.status-toggle .status-chip[aria-pressed="true"] {
  font-weight: 600;
}
.status-toggle.saving {
  opacity: 0.7;
}

.action-cell {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.ghost-btn {
  border: 1px solid #dbeafe;
  background: #fff;
  color: #1d4ed8;
  border-radius: 999px;
  padding: 6px 14px;
  font-size: 0.85rem;
}

.ghost-btn:hover {
  background: #1d4ed8;
  color: #fff;
}

.action-menu {
  position: relative;
}

.action-menu button {
  background: transparent;
  border: none;
  font-size: 18px;
  cursor: pointer;
  color: #6b7280;
  padding: 0 6px;
}

.action-menu__panel {
  position: absolute;
  right: 0;
  top: 28px;
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  box-shadow: 0 12px 32px rgba(15, 23, 42, 0.18);
  display: none;
  min-width: 150px;
  z-index: 20;
  padding: 6px 0;
}

.action-menu__panel.open { display: block; }

.action-menu__panel a,
.action-menu__panel button {
  display: block;
  width: 100%;
  text-align: left;
  padding: 8px 14px;
  background: none;
  border: none;
  font-size: 14px;
  color: #1f2937;
  cursor: pointer;
}

.action-menu__panel button.menu-danger { color: #b91c1c; }

.no-appointments {
  text-align: center;
  padding: 40px 12px;
  color: #64748b;
}

.filters-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
  width: 100%;
}

.filter-field {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.filter-actions {
  display: flex;
  align-items: flex-end;
  gap: 12px;
  flex-wrap: wrap;
}

.view-selector select {
  width: 100%;
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  font-size: 0.95rem;
}



@media (max-width: 900px) {
  .appointment-table.modern-table thead { display: none; }
  .appointment-table.modern-table tbody tr {
    display: block;
    border-left-width: 6px;
  }
  .appointment-table.modern-table tbody td {
    display: block;
    padding: 12px 16px;
  }
  .appointment-table.modern-table tbody td + td {
    margin-top: 8px;
    border-top: 1px solid #f1f5f9;
  }
  .action-cell { justify-content: flex-start; }
}
</style>

<div class="card appointment-hero">
  <div>
    <div class="eyebrow">{{ t('appointments') }}</div>
    <h1>{{ selected_range_label }}</h1>
    <p class="muted">{{ selected_show_label }}</p>
  </div>
  <form method="get" class="filters filters-grid">
    <div class="filter-field">
      <label>{{ t('appointments_day_label') }}</label>
      <input type="date" name="day" value="{{ day }}">
    </div>
    <div class="filter-field">
      <label>{{ t('appointments_show_label') }}</label>
      <select name="show">
        {% for value, label in show_choices %}
          <option value="{{ value }}" {% if value == selected_show %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="filter-field">
      <label>{{ t('appointments_range_label') }}</label>
      <select name="range">
        {% for value, label in range_choices %}
          <option value="{{ value }}" {% if value == selected_range %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="filter-field">
      <label>{{ t('appointments_doctor_label') }}</label>
      <select name="doctor">
        {% for value, label in doctors %}
          <option value="{{ value }}" {% if value == selected_doctor %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="filter-field">
      <label>{{ t('appointments_search_label') }}</label>
      <input type="text" name="q" placeholder="{{ t('appointments_search_placeholder') }}" value="{{ search_query }}">
    </div>
    <div class="filter-field view-selector">
      <label>{{ t('view') }}</label>
      <select id="view-selector"
              data-current="{{ current_view or 'table' }}"
              data-day="{{ day }}"
              data-doctor="{{ selected_doctor }}"
              data-range="{{ selected_range or 'today' }}"
              data-show="{{ selected_show or 'upcoming' }}"
              data-search="{{ search_query or '' }}"
              data-table-base="{{ url_for('appointments.table') }}"
              data-multi-base="{{ url_for('multi_doctor.multi_doctor') }}">
        <option value="table">{{ t('appointments_table_view') if t('appointments_table_view') != 'appointments_table_view' else 'Table View' }}</option>
        <option value="multi">{{ t('appointments_multi_view') if t('appointments_multi_view') != 'appointments_multi_view' else 'Multi-Doctor View' }}</option>
      </select>
    </div>
    <div class="filter-actions">
      <button class="btn">{{ t('filter') }}</button>
      <a class="btn primary" href="{{ url_for('appointments.new', day=day, doctor=selected_doctor) }}">➕ {{ t('appointments_new') }}</a>
    </div>
  </form>
</div>

{% include 'appointments/_schedule_modal.html' %}

<div class="card appointment-stats">
  {% for label, value in stats %}
    <div class="stat-tile">
      <div class="stat-label">{{ t(label) }}</div>
      <div class="stat-value">{{ value }}</div>
    </div>
  {% endfor %}
</div>

<div class="card table-view-modern">
  <div class="table-container">
    <table class="appointment-table modern-table">
      <thead>
        <tr>
          <th>{{ t('name') }}</th>
          <th>{{ t('appointments_title_label') }}</th>
          <th>{{ t('status') }}</th>
          <th>{{ t('actions') }}</th>
        </tr>
      </thead>
      {% set rows = groups if groups is defined else (appts if appts is defined else []) %}
      <tbody>
        {% if rows %}
          {% for group in rows %}
          {%- set patient_url = url_for('patients.patient_detail', pid=group.patient_id) if group.patient_id else '' -%}
          {% set badge_file = group.patient_short_id or '—' %}
          {% set normalized_status = 'done' if group.selected.status == 'done' else 'scheduled' %}
          <tr class="doctor-{{ group.selected.doctor_id or 'default' }} time-{{ group.selected.time_status }} status-{{ group.selected.status }}"
              data-status="{{ group.selected.status }}"
              data-doctor="{{ group.selected.doctor_id }}">
            <td class="patient-cell">
              {% if group.patient_id %}
                <a href="{{ patient_url }}" class="patient-chip patient-chip--link">
                  <span class="patient-chip__name">{{ group.patient_name }}</span>
                  <span class="patient-chip__meta">{{ t('file_no') }}: {{ badge_file }} · {{ group.patient_phone or '—' }}</span>
                </a>
              {% else %}
                <div class="patient-chip">
                  <span class="patient-chip__name">{{ group.patient_name }}</span>
                  <span class="patient-chip__meta">{{ t('file_no') }}: {{ badge_file }} · {{ group.patient_phone or '—' }}</span>
                </div>
              {% endif %}
              <div class="chip-row">
                <span class="info-chip">{{ group.doctor_label }}</span>
                <span class="info-chip info-chip--time">{{ group.time_display }}</span>
                {% if selected_range != 'today' %}
                  <span class="info-chip info-chip--tiny">{{ group.selected.starts_at[:10] }}</span>
                {% endif %}
              </div>
            </td>
            <td class="visit-cell">
              <div class="visit-title">{{ group.selected.title }}</div>
            </td>
            <td class="status-cell">
              <form class="status-toggle"
                    method="post"
                    action="{{ url_for('appointments.status', appt_id=group.selected.id) }}"
                    data-appt-id="{{ group.selected.id }}"
                    data-status="{{ normalized_status }}"
                    data-status-url="{{ url_for('appointments.status', appt_id=group.selected.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="next" value="{{ request.full_path }}">
                <button type="submit"
                        name="status"
                        value="scheduled"
                        class="status-chip status-option {{ 'is-active' if normalized_status == 'scheduled' else '' }}"
                        data-status-choice="scheduled"
                        aria-pressed="{{ 'true' if normalized_status == 'scheduled' else 'false' }}">
                  {{ t('appointment_status_scheduled') }}
                </button>
                <button type="submit"
                        name="status"
                        value="done"
                        class="status-chip status-option {{ 'is-active' if normalized_status == 'done' else '' }}"
                        data-status-choice="done"
                        aria-pressed="{{ 'true' if normalized_status == 'done' else 'false' }}">
                  {{ t('appointment_status_done') }}
                </button>
              </form>
            </td>
            <td class="action-cell">
              <button type="button" class="ghost-btn" data-group='{{ group.modal_payload | tojson }}'>{{ t('view') }}</button>
              <div class="action-menu">
                <button type="button" aria-label="{{ t('actions') }}" data-menu-trigger>⋮</button>
                <div class="action-menu__panel">
                  <a href="{{ url_for('appointments.edit', appt_id=group.selected.id) }}">{{ t('edit') }}</a>
                  <form method="post" action="{{ url_for('appointments.delete', appt_id=group.selected.id) }}" onsubmit="return confirm('{{ t('confirm_delete') if t('confirm_delete') != 'confirm_delete' else 'Delete this appointment?' }}')">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="next" value="{{ request.full_path }}">
                    <button type="submit" class="menu-danger">{{ t('delete') }}</button>
                  </form>
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="4" class="no-appointments">{{ t('appointments_empty_hour') }}</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const viewSelector = document.getElementById('view-selector');
    if (viewSelector) {
        const current = viewSelector.dataset.current || 'table';
        viewSelector.value = current;
        viewSelector.addEventListener('change', function() {
            const target = this.value;
            const day = this.dataset.day;
            const doctor = this.dataset.doctor;
            const tableBase = this.dataset.tableBase;
            const multiBase = this.dataset.multiBase;
            const query = new URLSearchParams();
            if (day) query.set('day', day);
            if (doctor && doctor !== 'all') query.set('doctor', doctor);
            const rangeVal = this.dataset.range;
            const showVal = this.dataset.show;
            const searchVal = this.dataset.search;
            if (rangeVal && rangeVal !== 'today') query.set('range', rangeVal);
            if (showVal && showVal !== 'upcoming') query.set('show', showVal);
            if (searchVal) query.set('q', searchVal);

            if (target === 'multi') {
                const multiParams = new URLSearchParams();
                if (day) multiParams.set('day', day);
                if (rangeVal && rangeVal !== 'today') multiParams.set('range', rangeVal);
                if (showVal && showVal !== 'upcoming') multiParams.set('show', showVal);
                if (searchVal) multiParams.set('q', searchVal);
                window.location.href = `${multiBase}?${multiParams.toString()}`;
                return;
            }

            window.location.href = `${tableBase}?${query.toString()}`;
        });
    }

    const closeMenus = () => {
        document.querySelectorAll('.action-menu__panel.open').forEach(menu => menu.classList.remove('open'));
    };

    document.querySelectorAll('[data-menu-trigger]').forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
            const panel = this.nextElementSibling;
            if (!panel) return;
            const isOpen = panel.classList.contains('open');
            closeMenus();
            if (!isOpen) {
                panel.classList.add('open');
            }
        });
    });

    document.querySelectorAll('.action-menu__panel').forEach(panel => {
        panel.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });

    document.addEventListener('click', closeMenus);

    document.querySelectorAll('[data-expandable]').forEach(chip => {
        chip.addEventListener('click', function() {
            this.classList.toggle('expanded');
        });
    });
});
</script>

{% endblock %}
