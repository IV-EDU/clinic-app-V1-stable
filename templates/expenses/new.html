{% extends 'expenses/base.html' %}

{% block title %}New Expense Receipt{% endblock %}

{% block expenses_content %}
<div class="card">
  <div class="card-header">
    <h3>Create New Expense Receipt</h3>
  </div>
  <div class="card-body">
    <form method="POST" class="expense-form" id="expenseForm">
      {{ form.hidden_tag() }}
      
      <!-- Receipt Information -->
      <div class="form-section">
        <h4>Receipt Information</h4>
        <div class="form-row">
          <div class="form-group">
            {{ form.supplier_id.label(class="form-label") }}
            {{ form.supplier_id(class="form-control") }}
            {% for error in form.supplier_id.errors %}
              <div class="field-error">{{ error }}</div>
            {% endfor %}
          </div>
          <div class="form-group">
            {{ form.receipt_date.label(class="form-label") }}
            {{ form.receipt_date(class="form-control", type="date") }}
            {% for error in form.receipt_date.errors %}
              <div class="field-error">{{ error }}</div>
            {% endfor %}
          </div>
          <div class="form-group">
            {{ form.tax_rate.label(class="form-label") }}
            {{ form.tax_rate(class="form-control", placeholder="14.0") }}
            {% for error in form.tax_rate.errors %}
              <div class="field-error">{{ error }}</div>
            {% endfor %}
          </div>
        </div>
        <div class="form-group">
          {{ form.notes.label(class="form-label") }}
          {{ form.notes(class="form-control", rows="3", placeholder="Additional notes...") }}
          {% for error in form.notes.errors %}
            <div class="field-error">{{ error }}</div>
          {% endfor %}
        </div>
      </div>

      <!-- Items Section -->
      <div class="form-section">
        <div class="section-header">
          <h4>Expense Items</h4>
          <button type="button" class="btn secondary" id="addItemBtn">
            <i class="fa fa-plus"></i> Add Item
          </button>
        </div>
        
        <div id="itemsContainer">
          {% for item_form in form.items %}
            <div class="expense-item" data-item-index="{{ loop.index0 }}">
              <div class="item-header">
                <span class="item-title">Item {{ loop.index }}</span>
                <button type="button" class="btn btn-sm danger remove-item-btn" onclick="removeItem(this)">
                  <i class="fa fa-trash"></i>
                </button>
              </div>
              <div class="form-row">
                <div class="form-group">
                  {{ item_form.material_name.label(class="form-label") }}
                  {{ item_form.material_name(class="form-control material-name") }}
                  {% for error in item_form.material_name.errors %}
                    <div class="field-error">{{ error }}</div>
                  {% endfor %}
                </div>
                <div class="form-group">
                  {{ item_form.quantity.label(class="form-label") }}
                  {{ item_form.quantity(class="form-control quantity-input", placeholder="1.00") }}
                  {% for error in item_form.quantity.errors %}
                    <div class="field-error">{{ error }}</div>
                  {% endfor %}
                </div>
                <div class="form-group">
                  {{ item_form.unit_price.label(class="form-label") }}
                  {{ item_form.unit_price(class="form-control unit-price", placeholder="0.00") }}
                  {% for error in item_form.unit_price.errors %}
                    <div class="field-error">{{ error }}</div>
                  {% endfor %}
                </div>
                <div class="form-group">
                  <label class="form-label">Total Price</label>
                  <div class="total-price-display">0.00 EGP</div>
                </div>
              </div>
              <div class="form-group">
                {{ item_form.notes.label(class="form-label") }}
                {{ item_form.notes(class="form-control", placeholder="Item notes...") }}
                {% for error in item_form.notes.errors %}
                  <div class="field-error">{{ error }}</div>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

      <!-- Summary Section -->
      <div class="form-section summary-section">
        <h4>Summary</h4>
        <div class="summary-grid">
          <div class="summary-item">
            <label>Subtotal:</label>
            <span id="subtotalDisplay">0.00 EGP</span>
          </div>
          <div class="summary-item">
            <label>Tax Amount:</label>
            <span id="taxAmountDisplay">0.00 EGP</span>
          </div>
          <div class="summary-item total">
            <label>Total Amount:</label>
            <span id="totalAmountDisplay">0.00 EGP</span>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        {{ form.submit(class="btn primary") }}
        <a href="{{ url_for('expenses.index') }}" class="btn secondary">Cancel</a>
      </div>
    </form>
  </div>
</div>

<!-- Item Template for JavaScript -->
<template id="itemTemplate">
  <div class="expense-item" data-item-index="">
    <div class="item-header">
      <span class="item-title">Item</span>
      <button type="button" class="btn btn-sm danger remove-item-btn" onclick="removeItem(this)">
        <i class="fa fa-trash"></i>
      </button>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Material Name</label>
        <input type="text" class="form-control material-name" name="items-__INDEX__-material_name" required>
      </div>
      <div class="form-group">
        <label class="form-label">Quantity</label>
        <input type="number" step="0.01" min="0.01" class="form-control quantity-input" name="items-__INDEX__-quantity" required>
      </div>
      <div class="form-group">
        <label class="form-label">Unit Price</label>
        <input type="number" step="0.01" min="0.01" class="form-control unit-price" name="items-__INDEX__-unit_price" required>
      </div>
      <div class="form-group">
        <label class="form-label">Total Price</label>
        <div class="total-price-display">0.00 EGP</div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Notes</label>
      <textarea class="form-control" name="items-__INDEX__-notes" placeholder="Item notes..."></textarea>
    </div>
  </div>
</template>

<script>
// Initialize calculations on page load
document.addEventListener('DOMContentLoaded', function() {
    updateFormTotals();
});
</script>
{% endblock %}