<form method="post" class="row" action="{{ action }}">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  {% set primary_phone = (phone_rows[0].phone if phone_rows and phone_rows|length > 0 else (p['phone'] or '')) %}
  {% set primary_page = (page_rows[0].page_number if page_rows and page_rows|length > 0 else (p['primary_page_number'] or '')) %}
  {% set primary_notebook = (page_rows[0].notebook_name if page_rows and page_rows|length > 0 else '') %}
  {% set primary_color = (page_rows[0].notebook_color if page_rows and page_rows|length > 0 else '') %}
  <div class="row" style="flex-basis:100%">
    {{ macros.labeled_input('short_id', t('file_no'), value=p['short_id'] or '', placeholder=t('file_no_hint')) }}
    {% if show_file_numbers %}
      <div style="flex:1;min-width:220px">
        <label class="h">{{ t('page_numbers') }}</label>
        <div class="page-number-input-wrap">
          <input class="form-input page-number-input" name="primary_page_number" value="{{ primary_page or '' }}" placeholder="{{ t('page_number_placeholder') }}">
          <input type="hidden" name="primary_notebook_name" value="{{ primary_notebook or '' }}">
          <input type="hidden" name="primary_notebook_color" data-color-hidden value="{{ primary_color or '' }}">
          <input
            type="color"
            class="page-color-picker"
            data-color-picker
            value="{{ primary_color or '#e5e7eb' }}"
            aria-label="{{ t('notebook_color') }}"
            title="{{ t('notebook_color') }}"
          >
        </div>
      </div>
    {% endif %}
    {{ macros.labeled_input('full_name', t('name'), value=p['full_name'], required=True) }}
    {{ macros.labeled_input('phone', t('phone'), value=primary_phone or '', placeholder=t('optional')) }}
  </div>

  <div style="flex-basis:100%;margin-top:6px">
    <div class="h" style="margin-bottom:6px">{{ t('additional_phones') }}</div>
    <div id="extra-phone-rows-edit" style="display:flex;flex-direction:column;gap:8px">
      {% if phone_rows %}
        {% for phone_row in phone_rows %}
          {% if not loop.first %}
            <div class="row extra-phone-row" data-repeater-row>
              <input class="form-input" style="flex:1;min-width:220px" name="extra_phone_number" value="{{ phone_row.phone or '' }}" placeholder="{{ t('phone') }}">
              <button type="button" class="btn secondary repeater-remove-btn" data-repeater-remove aria-label="{{ t('remove') }}" title="{{ t('remove') }}">&times;</button>
            </div>
          {% endif %}
        {% endfor %}
      {% endif %}
    </div>
    <button
      type="button"
      class="btn secondary"
      style="margin-top:8px"
      data-repeater-add="phone"
      data-container-id="extra-phone-rows-edit"
      data-template-id="phone-row-template-edit"
    >{{ t('add_phone') }}</button>
  </div>

  {% if show_file_numbers %}
  <div style="flex-basis:100%;margin-top:10px">
    <div class="h" style="margin-bottom:6px">{{ t('additional_pages') }}</div>
    <div id="extra-page-rows-edit" style="display:flex;flex-direction:column;gap:8px">
      {% if page_rows %}
        {% for page_row in page_rows %}
          {% if not loop.first %}
            <div class="row extra-page-row" data-repeater-row>
              <div style="flex:2;min-width:220px">
                <div class="page-number-input-wrap">
                  <input class="form-input page-number-input" name="extra_page_number" value="{{ page_row.page_number or '' }}" placeholder="{{ t('page_number_placeholder') }}">
                  <input type="hidden" name="extra_notebook_name" value="{{ page_row.notebook_name or '' }}">
                  <input type="hidden" name="extra_notebook_color" data-color-hidden value="{{ page_row.notebook_color or '' }}">
                  <input
                    type="color"
                    class="page-color-picker"
                    data-color-picker
                    value="{{ page_row.notebook_color or '#e5e7eb' }}"
                    aria-label="{{ t('notebook_color') }}"
                    title="{{ t('notebook_color') }}"
                  >
                </div>
              </div>
              <button type="button" class="btn secondary repeater-remove-btn" data-repeater-remove aria-label="{{ t('remove') }}" title="{{ t('remove') }}">&times;</button>
            </div>
          {% endif %}
        {% endfor %}
      {% endif %}
    </div>
    <button
      type="button"
      class="btn secondary"
      style="margin-top:8px"
      data-repeater-add="page"
      data-container-id="extra-page-rows-edit"
      data-template-id="page-row-template-edit"
    >{{ t('add_page_number') }}</button>
  </div>
  {% endif %}

  {{ macros.labeled_textarea('notes', t('notes'), value=p['notes'] or '', placeholder=t('optional')) }}
  <div style="flex-basis:100%;display:flex;gap:8px;justify-content:center">
    <a class="btn secondary" href="{{ url_for('patients.patient_detail', pid=p['id']) }}">{{ t('back_to_patient') }}</a>
    <button class="btn">{{ t('update') }}</button>
  </div>
</form>

<template id="phone-row-template-edit">
  <div class="row extra-phone-row" data-repeater-row>
    <input class="form-input" style="flex:1;min-width:220px" name="extra_phone_number" placeholder="{{ t('phone') }}">
    <button type="button" class="btn secondary repeater-remove-btn" data-repeater-remove aria-label="{{ t('remove') }}" title="{{ t('remove') }}">&times;</button>
  </div>
</template>

{% if show_file_numbers %}
<template id="page-row-template-edit">
  <div class="row extra-page-row" data-repeater-row>
    <div style="flex:2;min-width:220px">
      <div class="page-number-input-wrap">
        <input class="form-input page-number-input" name="extra_page_number" placeholder="{{ t('page_number_placeholder') }}">
        <input type="hidden" name="extra_notebook_name" value="">
        <input type="hidden" name="extra_notebook_color" data-color-hidden value="">
        <input type="color" class="page-color-picker" data-color-picker value="#e5e7eb" aria-label="{{ t('notebook_color') }}" title="{{ t('notebook_color') }}">
      </div>
    </div>
    <button type="button" class="btn secondary repeater-remove-btn" data-repeater-remove aria-label="{{ t('remove') }}" title="{{ t('remove') }}">&times;</button>
  </div>
</template>
{% endif %}
