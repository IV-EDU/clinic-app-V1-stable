<div class="card patient-header-card" style="margin:0; border: 2px solid var(--border-strong);">
  <div class="patient-summary-grid">
    <div class="summary-item">
      <div class="summary-label">{{ t('file_no') }}</div>
      <div class="summary-value">
        <span class="page-chip">{{ p['short_id'] or 'â€”' }}</span>
      </div>
    </div>
    <div class="summary-item">
      <div class="summary-label">{{ t('page_numbers') }}</div>
      <div class="summary-value">
        <span class="page-chip">ðŸ“„ <span class="page-chip-notebook">{{ primary_page_number or 'â€”' }}</span></span>
      </div>
    </div>
    <div class="summary-item">
      <div class="summary-label">{{ t('name') }}</div>
      <div class="summary-value" style="font-size: 1.1rem; font-weight: 800;">{{ p['full_name'] }}</div>
    </div>
    <div class="summary-item">
      <div class="summary-label">{{ t('phone') }}</div>
      <div class="summary-value">{{ p['phone'] or 'â€”' }}</div>
    </div>
    <div class="summary-item" style="background: {{ 'var(--success-bg)' if overall_fmt == '0.00' else 'var(--danger-bg)' }}; border-color: {{ 'var(--success-color)' if overall_fmt == '0.00' else 'var(--danger-color)' }};">
      <div class="summary-label" style="color: {{ 'var(--success-color)' if overall_fmt == '0.00' else 'var(--danger-color)' }};">{{ t('overall_balance') }}</div>
      <div class="summary-value">
        <div class="bal-box {{ overall_class }}" style="border: none; background: transparent; font-weight: 800;">{{ overall_fmt }}</div>
      </div>
    </div>
  </div>
  {% if p['notes'] %}
  <div class="patient-notes" style="margin-top:0.75rem;">
    <div class="summary-label">{{ t('sheet_notes') }}</div>
    <div class="summary-value wrap-text">{{ p['notes'] }}</div>
  </div>
  {% endif %}
  <div class="actions-row" style="justify-content:flex-end;margin-top:0.75rem;">
    <a class="btn secondary" href="{{ url_for('patients.patient_detail', pid=p['id']) }}" target="_blank" rel="noopener">{{ t('open') }}</a>
  </div>
</div>

{% if treatments %}
<div class="u-stack-sm" style="margin-top: 1rem;">
  <h4 style="font-size: 1rem; font-weight: 800; color: var(--text-secondary); padding: 0 4px;">{{ t('recent_treatments', 'Recent Treatments') }}</h4>

  {% for t in treatments %}
  <div class="card" style="padding: 16px; border-left: 4px solid var(--primary-color);">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
      <div>
        <div style="font-weight: 800; font-size: 1.1rem; color: var(--text-primary);">{{ t.treatment_type or t('treatment') }}</div>
        <div style="font-size: 0.85rem; color: var(--text-muted);">{{ t.created_at }} â€¢ {{ t.doctor_label or t('any_doctor') }}</div>
      </div>
      <div class="bal-box {{ 'bal-0' if t.remaining_cents == 0 else 'bal-pos' }}">
        {{ t.remaining_fmt }}
      </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; background: var(--bg-strong); padding: 12px; border-radius: 12px;">
      <div>
        <div style="font-size: 0.7rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">{{ t('total') }}</div>
        <div style="font-weight: 700;">{{ t.total_fmt }}</div>
      </div>
      <div>
        <div style="font-size: 0.7rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">{{ t('discount') }}</div>
        <div style="font-weight: 700;">{{ t.discount_fmt }}</div>
      </div>
      <div>
        <div style="font-size: 0.7rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">{{ t('remaining') }}</div>
        <div style="font-weight: 700;">{{ t.remaining_fmt }}</div>
      </div>
    </div>

    {% if t.notes %}
    <div style="margin-top: 12px; font-size: 0.9rem; color: var(--text-secondary); border-top: 1px solid var(--border-strong); padding-top: 8px;">
      {{ t.notes }}
    </div>
    {% endif %}
  </div>
  {% endfor %}
</div>
{% else %}
<div class="u-text-muted" style="text-align: center; padding: 2rem;">
  {{ t('no_treatments_recorded', 'No treatments recorded for this patient.') }}
</div>
{% endif %}
