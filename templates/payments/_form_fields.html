<div class="card payment-form-card" style="border: none; box-shadow: none; padding: 0;">
  <form method="post" action="{{ action }}" id="paymentForm" class="admin-form u-stack-md">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
      <div class="form-group">
        <label class="form-label">{{ t('visit_type') }}</label>
        {% set vt = form.visit_type|default('none') %}
        <select name="visit_type" id="visit_type" class="form-control">
          <option value="none" {{ 'selected' if vt=='none' else '' }}>{{ t('vt_none') }}</option>
          <option value="exam" {{ 'selected' if vt=='exam' else '' }}>{{ t('vt_exam') }}</option>
          <option value="followup" {{ 'selected' if vt=='followup' else '' }}>{{ t('vt_follow') }}</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">{{ t('doctor') }}</label>
        {% set selected_doctor = form.doctor_id|default('') %}
        <select name="doctor_id" id="doctor_id" class="form-control" required>
          <option value="" disabled {{ 'selected' if not selected_doctor else '' }}>{{ t('select_doctor') }}</option>
          {% for doctor in doctor_options or [] %}
            <option value="{{ doctor['doctor_id'] }}" {{ 'selected' if selected_doctor == doctor['doctor_id'] else '' }}>
              {{ doctor['doctor_label'] }}
            </option>
          {% endfor %}
        </select>
        {% if doctor_error %}
          <div class="field-error doctor-error" style="color: var(--danger-color); font-size: 0.85rem; margin-top: 4px;">{{ doctor_error }}</div>
        {% endif %}
      </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px;">
      <div class="form-group">
        <label class="form-label">{{ t('total_amount') }}</label>
        <input class="form-control" name="total_amount" id="total_amount" inputmode="decimal" style="font-weight: 800; color: var(--primary-color);" placeholder="0" value="{{ form.total_amount|default('') }}">
        <input type="hidden" name="total_amount_effective" id="total_amount_effective" value="{{ form.total_amount_effective|default('') }}">
      </div>

      <div class="form-group">
        <label class="form-label">{{ t('discount') }}</label>
        <input class="form-control" name="discount" inputmode="decimal" style="color: var(--danger-color); font-weight: 700;" placeholder="0" value="{{ form.discount|default('') }}">
      </div>

      <div class="form-group">
        <label class="form-label">{{ t('down_payment') }}</label>
        <input class="form-control" name="down_payment" inputmode="decimal" style="font-weight: 800; color: var(--success-color);" placeholder="0" value="{{ form.down_payment|default('') }}">
      </div>

      <div class="form-group">
        <label class="form-label">{{ t('summary_remaining') }}</label>
        <input class="form-control" id="remaining_amount" name="remaining_amount" inputmode="decimal" style="background: var(--bg-strong); font-weight: 800;" placeholder="0" value="{{ form.remaining_amount|default('') }}" readonly>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">{{ t('treatment_type') }}</label>
      <textarea name="treatment_type" class="form-control" rows="1" placeholder="{{ t('treatment_type_placeholder') }}">{{ form.treatment_type|default('') }}</textarea>
    </div>

    <div class="form-group">
      <label class="form-label">{{ t('sheet_notes') }}</label>
      <textarea name="notes" class="form-control" rows="1" placeholder="{{ t('notes_placeholder') }}">{{ form.notes|default('') }}</textarea>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
      <div class="form-group">
        <label class="form-label">{{ t('date') }}</label>
        <input name="paid_at" type="date" class="form-control" value="{{ form.paid_at|default(today) }}">
      </div>

      <div class="form-group">
        <label class="form-label">{{ t('method') }}</label>
        {% set m = form.method|default('cash') %}
        <select name="method" class="form-control">
          <option value="cash" {{ 'selected' if m=='cash' else '' }}>{{ t('cash') }}</option>
          <option value="card" {{ 'selected' if m=='card' else '' }}>{{ t('card') }}</option>
          <option value="transfer" {{ 'selected' if m=='transfer' else '' }}>{{ t('transfer') }}</option>
        </select>
      </div>
    </div>

    <div class="modal-footer" style="padding: 24px 0 0 0; margin-top: 12px; border-top: 1px solid var(--border-strong); display: flex; justify-content: flex-end; gap: 12px;">
      {% set is_modal = in_modal|default(False) %}
      {% if is_modal %}
        <button type="button" class="u-btn ghost" onclick="hideFormModal()">{{ t('cancel') }}</button>
        <button class="u-btn primary" type="submit">{{ submit_label }}</button>
      {% else %}
        <a class="u-btn ghost" href="{{ url_for('patients.patient_detail', pid=p['id']) }}">{{ t('back') }}</a>
        <button class="u-btn primary" type="submit">{{ submit_label }}</button>
      {% endif %}
    </div>
  </form>
</div>
