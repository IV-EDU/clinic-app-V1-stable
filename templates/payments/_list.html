<div class="card payments-card">
  <div class="payments-header">
    <strong class="payments-title">{{ t('payments') }}</strong>
    <a class="btn primary new-payment-btn" href="{{ url_for('patients.excel_entry_get', pid=p['id']) }}">{{ t('new_payment') }}</a>
  </div>
  {% if pays %}
    {% for pay in pays %}
      {% set due_cents_raw = (pay['total_amount_cents'] or 0) - (pay['discount_cents'] or 0) %}
      {% set bal_cents_raw = (due_cents_raw - (pay['amount_cents'] or 0)) %}
      {% set bal_cents = 0 if bal_cents_raw < 0 else bal_cents_raw %}
      {% set bal_class_name = 'bal-0' if bal_cents==0 else 'bal-pos' %}
      {% set card_class = 'ok' if bal_cents==0 else 'due' %}
      <div class="card payment-card {{ card_class }}">
        <div class="payment-card-header">
          <div class="payment-amount">
            <div class="payment-amount-value">{{ pay['amount_fmt'] }}</div>
            <div class="payment-amount-label">{{ t('down_payment') }}</div>
          </div>
          <div class="payment-card-meta">
            <div class="payment-date">{{ pay['paid_at'] }}</div>
            <div class="payment-method">{{ t('method') }}: {{ pay['method'] or '—' }}</div>
            {% if pay.get('doctor_label') %}
              {% set chip_color = pay.get('doctor_color') %}
              <span class="payment-doctor-chip" {% if chip_color %}style="--chip-color: {{ chip_color }};"{% endif %}>
                {{ pay.get('doctor_label') }}
              </span>
            {% endif %}
          </div>
        </div>
        <div class="payment-card-body">
          <div class="payment-info-grid">
            <div class="payment-field">
              <div class="payment-label">{{ t('summary_total') }}</div>
              <div class="payment-value">{{ pay['total_fmt'] }}</div>
            </div>
            <div class="payment-field">
              <div class="payment-label">{{ t('summary_discount') }}</div>
              <div class="payment-value">{{ pay['discount_fmt'] }}</div>
            </div>
            <div class="payment-field">
              <div class="payment-label">{{ t('summary_remaining') }}</div>
              <div class="payment-value"><div class="bal-box {{ bal_class_name }}">{{ '{:.2f}'.format((bal_cents or 0)/100) }}</div></div>
            </div>
            <div class="payment-field">
              <div class="payment-label">{{ t('treatment_type') }}</div>
              <div class="payment-value">{{ pay['treatment'] or '—' }}</div>
            </div>
          </div>
          <div class="payment-note">
            <div class="payment-label">{{ t('sheet_notes') }}</div>
            <div class="payment-value">{{ pay['note'] or '—' }}</div>
          </div>
        </div>
        <div class="payment-card-footer">
          <div class="payment-actions payment-actions-main">
            <a class="btn secondary edit-payment-btn"
               href="{{ url_for('payments.edit_payment_get', pid=p['id'], pay_id=pay['id']) }}"
               data-payment-id="{{ pay['id'] }}"
               data-patient-id="{{ p['id'] }}">
              {{ t('edit_payment') }}
            </a>
            <a class="btn secondary view-receipt-btn"
               href="{{ url_for('payments.view_payment_receipt', pid=p['id'], pay_id=pay['id']) }}"
               data-payment-id="{{ pay['id'] }}"
               data-patient-id="{{ p['id'] }}">
              {{ t('view') }}
            </a>
            <button class="btn print-receipt-btn"
                    data-payment-id="{{ pay['id'] }}"
                    data-patient-id="{{ p['id'] }}"
                    title="{{ t('print_receipt_title') }}"
                    aria-label="{{ t('print_receipt') }}">
              <i class="fa fa-print"></i> {{ t('print_receipt') }}
            </button>
          </div>
          <div class="payment-actions payment-actions-danger">
            <a class="btn danger" href="{{ url_for('payments.delete_payment_confirm', pid=p['id'], pay_id=pay['id']) }}">{{ t('delete_payment') }}</a>
          </div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="no-payments">{{ t('no_rows') }}</div>
  {% endif %}
</div>

{% include 'patients/print_receipt_modal.html' %}
