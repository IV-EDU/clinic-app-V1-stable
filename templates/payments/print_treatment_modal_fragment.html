{% macro kv_row(label, value, is_bold=false) -%}
  <div style="display: flex; justify-content: space-between; align-items: baseline; gap: 12px; margin-bottom: 8px;">
    <span style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 600;">{{ label }}</span>
    <span style="{% if is_bold %}font-weight: 800; color: var(--primary-color);{% else %}font-weight: 700; color: var(--text-primary);{% endif %}">{{ value }}</span>
  </div>
{%- endmacro %}

<div class="receipt-modal-host" style="background: var(--bg-surface);">
  <div class="receipt-card" dir="{{ dir|default('ltr') }}" style="border: none; box-shadow: none; padding: 0;">
    {% set clinic_title = clinic.name or t('treatment_summary') %}

    <header class="receipt-header" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px dashed var(--border-strong); padding-bottom: 24px; margin-bottom: 24px; gap: 24px;">
      <div class="clinic-block" style="flex: 1;">
        <div class="clinic-brand">
          {% if pdf_logo_url %}
            <div class="clinic-logo-wrapper" style="margin-bottom: 8px;">
              <img src="{{ pdf_logo_url }}" alt="{{ clinic_title }}" style="max-height: 50px; width: auto; object-fit: contain;" onerror="this.closest('.clinic-logo-wrapper').style.display='none';this.closest('.clinic-brand').querySelector('.clinic-name-fallback').style.display='block';">
            </div>
            <div class="clinic-name clinic-name-fallback" style="display:none; font-weight: 800; font-size: 1.25rem;">{{ clinic_title }}</div>
          {% else %}
            <div class="clinic-name" style="font-weight: 800; font-size: 1.25rem;">{{ clinic_title }}</div>
          {% endif %}
        </div>
        {% if clinic.address %}<div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 600;">{{ clinic.address }}</div>{% endif %}
        {% if clinic.phone %}<div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 600;">{{ clinic.phone }}</div>{% endif %}
      </div>

      <div class="receipt-meta" style="flex: 0 0 auto; text-align: {{ 'left' if dir == 'rtl' else 'right' }};">
        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em; margin-bottom: 4px;">{{ t('treatment_id') }}</div>
        <div style="font-weight: 800; font-size: 1.1rem; color: var(--text-primary);">#{{ (treatment.id or '')[-8:].upper() }}</div>
        <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); margin-top: 4px;">{{ treatment.paid_at }}</div>
      </div>
    </header>

    <div class="info-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
      <div class="info-block" style="background: var(--bg-strong); padding: 16px; border-radius: 16px;">
        <div style="font-size: 0.75rem; text-transform: uppercase; font-weight: 800; color: var(--text-muted); margin-bottom: 12px; letter-spacing: 0.05em;">{{ t('receipt_patient_label') }}</div>
        {{ kv_row(t('name'), patient.full_name or '—') }}
        {{ kv_row(t('file_no'), patient.short_id or '—') }}
        {{ kv_row(t('phone'), patient.phone or '—') }}
      </div>
      <div class="info-block" style="background: var(--primary-color); color: white; padding: 16px; border-radius: 16px; box-shadow: var(--shadow-soft);">
        <div style="font-size: 0.75rem; text-transform: uppercase; font-weight: 800; opacity: 0.8; margin-bottom: 12px; letter-spacing: 0.05em;">{{ t('treatment_summary') }}</div>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <div style="display: flex; justify-content: space-between; font-size: 0.85rem; opacity: 0.9;">
            <span>{{ t('summary_total') }}</span>
            <span style="font-weight: 700;">{{ totals.total_fmt }}</span>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: 0.85rem; opacity: 0.9;">
            <span>{{ t('summary_paid') }}</span>
            <span style="font-weight: 700;">{{ totals.paid_fmt }}</span>
          </div>
          <div style="height: 1px; background: rgba(255,255,255,0.2); margin: 4px 0;"></div>
          <div style="display: flex; justify-content: space-between; font-weight: 800; font-size: 1.1rem;">
            <span>{{ t('summary_remaining') }}</span>
            <span>{{ totals.remaining_fmt }}</span>
          </div>
        </div>
      </div>
    </div>

    <div style="background: var(--bg-strong); padding: 20px; border-radius: 20px; margin-bottom: 24px;">
      <div style="font-size: 0.75rem; text-transform: uppercase; font-weight: 800; color: var(--text-muted); margin-bottom: 12px; letter-spacing: 0.05em;">{{ t('treatment_details') }}</div>
      <div style="display: grid; gap: 16px;">
        {% if treatment.treatment %}
          <div>
            <div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 600;">{{ t('treatment_type') }}</div>
            <div style="font-weight: 700; color: var(--text-primary); font-size: 1.1rem; margin-top: 4px;">{{ treatment.treatment }}</div>
          </div>
        {% endif %}
        {% if treatment.note %}
          <div>
            <div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 600;">{{ t('treatment_notes') }}</div>
            <div style="font-weight: 500; color: var(--text-secondary); margin-top: 4px; line-height: 1.5;" dir="auto">{{ treatment.note }}</div>
          </div>
        {% endif %}
        <div>
          <div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 600;">{{ t('visit_type') }}</div>
          <div style="font-weight: 700; color: var(--text-primary); margin-top: 4px;">{{ t(visit_type_key or 'vt_none') }}</div>
        </div>
      </div>
    </div>

    <div style="margin-bottom: 24px;">
      <div style="font-size: 0.75rem; text-transform: uppercase; font-weight: 800; color: var(--text-muted); margin-bottom: 12px; letter-spacing: 0.05em;">{{ t('payment_history') }}</div>
      {% if payments %}
        <div style="display: grid; gap: 12px;">
          {% for payment in payments %}
            <div style="background: var(--bg-surface); border: 1px solid var(--border-strong); padding: 16px; border-radius: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <span style="font-weight: 700; color: var(--text-primary);">{{ payment.paid_at or '—' }}</span>
                  {% if payment.is_initial %}
                    <span class="pill sm" style="background: var(--bg-strong); color: var(--primary-color); font-size: 0.7rem; font-weight: 800;">{{ t('initial') }}</span>
                  {% endif %}
                  <span style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 600;">{{ payment.doctor_label }}</span>
                </div>
                <div style="display: flex; align-items: center; gap: 16px;">
                  <span style="font-size: 0.85rem; color: var(--text-muted); font-weight: 600;">{{ payment.method or '—' }}</span>
                  <span style="font-weight: 800; color: var(--primary-color);">{{ payment.amount_fmt }}</span>
                </div>
              </div>
              {% if payment.note %}
                <div style="font-size: 0.85rem; color: var(--text-secondary); border-top: 1px solid var(--border-strong); padding-top: 8px; margin-top: 8px;" dir="auto">
                  <span style="font-weight: 700;">{{ t('payment_notes') }}:</span> {{ payment.note }}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div style="text-align: center; padding: 24px; color: var(--text-muted);">{{ t('no_rows') }}</div>
      {% endif %}
    </div>

    <footer style="text-align: center; padding-top: 24px; border-top: 1px solid var(--border-strong);">
      <div style="font-family: 'Tajawal', sans-serif; font-weight: 800; color: var(--primary-color); font-size: 1.1rem;">{{ t('thank_you_message') }}</div>
    </footer>
  </div>
</div>
