{% extends "_base.html" %}

{% macro kv_row(label, value, dir) -%}
  <div class="kv-line">
    <span class="kv-label">{{ label }}</span>
    <strong class="kv-value">{{ value }}</strong>
  </div>
{%- endmacro %}

{% block content %}
<div class="receipt-page" dir="{{ dir }}">
  <div class="action-bar">
    <a class="btn secondary" href="{{ back_url(p) }}">{{ t('back') }}</a>
    <div class="action-buttons">
      <a class="btn secondary" href="{{ url_for('payments.print_payment_receipt', pid=patient.id, pay_id=payment_id) }}">
        {{ t('download_pdf') }}
      </a>
      <button class="btn primary" type="button" onclick="window.print()">
        {{ t('print_receipt') }}
      </button>
    </div>
  </div>

  <div class="receipt-card">
    <header class="receipt-header">
      {% if dir == 'rtl' %}
        <div class="receipt-meta">
          {{ kv_row(t('receipt_number_label'), receipt.number, dir) }}
          {{ kv_row(t('receipt_date_label'), receipt.date, dir) }}
          {{ kv_row(t('payment_method'), receipt.method or t('method_cash'), dir) }}
        </div>
        <div class="clinic-block">
          <div class="clinic-brand">
            {% if pdf_logo_url %}
              <div class="clinic-logo-wrapper">
                <img src="{{ pdf_logo_url }}" alt="{{ clinic.name }}" class="clinic-logo-img">
              </div>
            {% else %}
              <div class="clinic-name">{{ clinic.name }}</div>
            {% endif %}
          </div>
          {% if clinic.address %}
            <div class="clinic-meta">{{ clinic.address }}</div>
          {% endif %}
          {% if clinic.phone %}
            <div class="clinic-meta">{{ clinic.phone }}</div>
          {% endif %}
        </div>
      {% else %}
        <div class="clinic-block">
          <div class="clinic-brand">
            {% if pdf_logo_url %}
              <div class="clinic-logo-wrapper">
                <img src="{{ pdf_logo_url }}" alt="{{ clinic.name }}" class="clinic-logo-img">
              </div>
            {% else %}
              <div class="clinic-name">{{ clinic.name }}</div>
            {% endif %}
          </div>
          {% if clinic.address %}
            <div class="clinic-meta">{{ clinic.address }}</div>
          {% endif %}
          {% if clinic.phone %}
            <div class="clinic-meta">{{ clinic.phone }}</div>
          {% endif %}
        </div>
        <div class="receipt-meta">
          {{ kv_row(t('receipt_number_label'), receipt.number, dir) }}
          {{ kv_row(t('receipt_date_label'), receipt.date, dir) }}
          {{ kv_row(t('payment_method'), receipt.method or t('method_cash'), dir) }}
        </div>
      {% endif %}
    </header>

    <section class="info-grid">
      {% if dir == 'rtl' %}
      <div class="info-block">
        <div class="block-title">{{ t('payments') }}</div>
        {{ kv_row(t('summary_total'), receipt.total, dir) }}
        {{ kv_row(t('summary_discount'), receipt.discount, dir) }}
        {{ kv_row(t('summary_paid'), receipt.paid, dir) }}
        {{ kv_row(t('summary_remaining'), receipt.remaining, dir) }}
      </div>
      <div class="info-block">
        <div class="block-title">{{ t('receipt_patient_label') }}</div>
        {{ kv_row(t('name'), patient.name, dir) }}
        {{ kv_row(t('file_no'), patient.file_no, dir) }}
        {{ kv_row(t('phone'), patient.phone or '—', dir) }}
      </div>
      {% else %}
      <div class="info-block">
        <div class="block-title">{{ t('receipt_patient_label') }}</div>
        {{ kv_row(t('name'), patient.name, dir) }}
        {{ kv_row(t('file_no'), patient.file_no, dir) }}
        {{ kv_row(t('phone'), patient.phone or '—', dir) }}
      </div>
      <div class="info-block">
        <div class="block-title">{{ t('payments') }}</div>
        {{ kv_row(t('summary_total'), receipt.total, dir) }}
        {{ kv_row(t('summary_discount'), receipt.discount, dir) }}
        {{ kv_row(t('summary_paid'), receipt.paid, dir) }}
        {{ kv_row(t('summary_remaining'), receipt.remaining, dir) }}
      </div>
      {% endif %}
    </section>

    {% if receipt.treatment %}
      <section class="note-block" data-section="treatment">
        <div class="block-title">{{ t('treatment') }}</div>
        <p class="note-text">{{ receipt.treatment }}</p>
      </section>
    {% endif %}

    {% if receipt.notes %}
      <section class="note-block" data-section="notes">
        <div class="block-title">{{ t('sheet_notes') }}</div>
        <p class="note-text">{{ receipt.notes }}</p>
      </section>
    {% endif %}

    <footer class="receipt-footer">
      <div class="thanks">{{ t('thank_you_message') }}</div>
    </footer>
  </div>
</div>
{% endblock %}
