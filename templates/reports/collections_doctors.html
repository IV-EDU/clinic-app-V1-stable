{% extends '_base.html' %}
{% block content %}
<div class="reports-page u-stack-lg">
  <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 24px;">
    <div>
      <h1 class="page-title" style="margin: 0; font-weight: 800; font-size: 2.5rem;">{{ t('collections') }}</h1>
      <p style="color: var(--text-secondary); margin-top: 4px; font-weight: 500;">{{ t('collections_any_hint_doctor') }}</p>
    </div>

    <div class="header-actions" style="display: flex; gap: 12px; background: var(--bg-surface); padding: 8px; border-radius: 16px; border: 1px solid var(--border-strong);">
      <a class="u-btn ghost sm" href="{{ url_for('reports.collections', tab=tab, f=from_date, t=to_date, view=view_mode) }}">{{ t('collections') }}</a>
      <a class="u-btn sm primary" href="{{ url_for('reports.collections_doctors', tab=tab, f=from_date, t=to_date, doctor=doctor_filter, view=view_mode) }}">{{ t('collections_by_doctor') }}</a>
      <a class="u-btn ghost sm" href="{{ url_for('reports.receivables') }}">{{ t('receivables') }}</a>
    </div>
  </div>

  <div class="analytics-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 24px;">
    <div class="analytics-card" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-hover)); color: white; padding: 24px; border-radius: 24px; box-shadow: var(--shadow-soft);">
      <p style="margin: 0; font-weight: 700; opacity: 0.8; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">{{ t('period_total') }}</p>
      <h2 style="margin: 8px 0 0 0; font-size: 2rem; font-weight: 800;">{{ summary_total_fmt }} <span style="font-size: 1rem; opacity: 0.7;">EGP</span></h2>
    </div>

    <div class="analytics-card" style="background: var(--bg-surface); border: 1px solid var(--border-strong); padding: 24px; border-radius: 24px; box-shadow: var(--shadow-soft);">
      <p style="margin: 0; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; font-size: 0.75rem;">{{ t('all_time_total') }}</p>
      <h2 style="margin: 8px 0 0 0; font-size: 2rem; font-weight: 800; color: var(--text-primary);">{{ all_time_total_fmt }} <span style="font-size: 1rem; color: var(--text-muted);">EGP</span></h2>
    </div>

    <div class="analytics-card" style="background: var(--bg-surface); border: 1px solid var(--border-strong); padding: 24px; border-radius: 24px; box-shadow: var(--shadow-soft);">
      <p style="margin: 0; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; font-size: 0.75rem;">{{ t('payments') }}</p>
      <h2 style="margin: 8px 0 0 0; font-size: 2rem; font-weight: 800; color: var(--text-primary);">{{ summary_payments_count }}</h2>
    </div>

    <div class="analytics-card" style="background: var(--bg-surface); border: 1px solid var(--border-strong); padding: 24px; border-radius: 24px; box-shadow: var(--shadow-soft);">
      <p style="margin: 0; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; font-size: 0.75rem;">{{ t('patients') }}</p>
      <h2 style="margin: 8px 0 0 0; font-size: 2rem; font-weight: 800; color: var(--text-primary);">{{ summary_unique_patients }}</h2>
    </div>
  </div>

  <div class="card" style="background: var(--bg-surface); border: 1px solid var(--border-strong); border-radius: 24px; padding: 24px; box-shadow: var(--shadow-soft);">
    <form method="get" style="display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end;">
      <input type="hidden" name="tab" value="{{ tab }}">

      <div style="flex-grow: 1; min-width: 200px;">
        <label style="display: block; font-weight: 700; margin-bottom: 8px; font-size: 0.85rem; color: var(--text-secondary);">{{ t('doctor') }}</label>
        <select name="doctor" class="form-control" style="width: 100%; border-radius: 12px;">
          {% for doc in doctors %}
            <option value="{{ doc.doctor_id }}" {% if doctor_filter == doc.doctor_id %}selected{% endif %}>
              {{ doc.doctor_label }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div style="flex-grow: 1; min-width: 150px;">
        <label style="display: block; font-weight: 700; margin-bottom: 8px; font-size: 0.85rem; color: var(--text-secondary);">{{ t('view') }}</label>
        <select name="view" class="form-control" style="width: 100%; border-radius: 12px;">
          <option value="payments" {% if view_mode == 'payments' %}selected{% endif %}>{{ t('payments') }}</option>
          <option value="treatments" {% if view_mode == 'treatments' %}selected{% endif %}>{{ t('treatments') }}</option>
        </select>
      </div>

      <div style="flex-grow: 1; min-width: 150px;">
        <label style="display: block; font-weight: 700; margin-bottom: 8px; font-size: 0.85rem; color: var(--text-secondary);">{{ t('from') }}</label>
        <input type="date" name="f" value="{{ from_date or '' }}" class="form-control" style="width: 100%; border-radius: 12px;">
      </div>

      <div style="flex-grow: 1; min-width: 150px;">
        <label style="display: block; font-weight: 700; margin-bottom: 8px; font-size: 0.85rem; color: var(--text-secondary);">{{ t('to') }}</label>
        <input type="date" name="t" value="{{ to_date or '' }}" class="form-control" style="width: 100%; border-radius: 12px;">
      </div>

      <div style="display: flex; gap: 12px;">
        <button class="u-btn primary" type="submit" style="padding: 10px 24px;">{{ t('filter') }}</button>
        <a class="u-btn ghost" href="{{ url_for('reports.collections_doctors', tab=tab, view=view_mode) }}">{{ t('reset') }}</a>
        {% if export_url %}
          <a class="u-btn ghost" href="{{ export_url }}" style="color: var(--primary-color);">
            <i class="fa fa-download"></i> {{ t('export') }}
          </a>
        {% endif %}
      </div>
    </form>
  </div>

  <div class="tabs-nav" style="display: flex; gap: 8px; margin-bottom: -1px; position: relative; z-index: 1;">
    <a href="{{ url_for('reports.collections_doctors', tab='daily', f=from_date, t=to_date, doctor=doctor_filter, view=view_mode) }}"
       style="padding: 12px 24px; border-radius: 16px 16px 0 0; font-weight: 700; text-decoration: none; {{ 'background: var(--bg-surface); border: 1px solid var(--border-strong); border-bottom-color: var(--bg-surface); color: var(--primary-color);' if tab=='daily' else 'color: var(--text-secondary);' }}">
      {{ t('tab_daily') }}
    </a>
    <a href="{{ url_for('reports.collections_doctors', tab='monthly', f=from_date, t=to_date, doctor=doctor_filter, view=view_mode) }}"
       style="padding: 12px 24px; border-radius: 16px 16px 0 0; font-weight: 700; text-decoration: none; {{ 'background: var(--bg-surface); border: 1px solid var(--border-strong); border-bottom-color: var(--bg-surface); color: var(--primary-color);' if tab=='monthly' else 'color: var(--text-secondary);' }}">
      {{ t('tab_monthly') }}
    </a>
  </div>

<div class="card" style="background: var(--bg-surface); border: 1px solid var(--border-strong); border-radius: 0 0 24px 24px; padding: 0; box-shadow: var(--shadow-soft); overflow: hidden;">
  {% if rows %}
    <table class="u-table">
      <thead>
        <tr style="background: var(--bg-strong);">
          <th style="padding: 16px 24px;">{% if tab=='daily' %}{{ t('date') }}{% else %}{{ t('month') }}{% endif %}</th>
          <th class="numeric" style="padding: 16px 24px;">{{ t('collected') }}</th>
          <th style="width: 150px; padding: 16px 24px;"></th>
        </tr>
      </thead>
      <tbody>
      {% for r in rows %}
        <tr style="border-bottom: 1px solid var(--border-strong);">
          <td style="padding: 16px 24px; font-weight: 700; color: var(--text-primary);">
            {% if tab=='daily' %}{{ r['paid_at'] }}{% else %}{{ r['month'] }}{% endif %}
          </td>
          <td class="numeric" style="padding: 16px 24px; font-weight: 800; color: var(--primary-color); font-size: 1.1rem;">
            {{ '{:,.2f}'.format((r['amt'] or 0)/100) }} <span style="font-size: 0.8rem; font-weight: 600; opacity: 0.6;">EGP</span>
          </td>
          <td style="padding: 16px 24px; text-align: right;">
            {% if tab=='daily' %}
              <button type="button"
                      class="u-btn ghost sm reports-view-btn"
                      data-kind="day"
                      data-label="{{ r['paid_at'] }}"
                      data-url="{{ url_for('reports.collections_day', d=r['paid_at'], format='json', doctor=doctor_filter, view=view_mode) }}">
                {{ t('view_day') }}
              </button>
            {% else %}
              <button type="button"
                      class="u-btn ghost sm reports-view-btn"
                      data-kind="{{ 'range' if range_mode else 'month' }}"
                      data-label="{{ r['month'] }}"
                      data-url="{% if range_mode %}{{ url_for('reports.collections_range', f=from_date or '', t=to_date or '', format='json', doctor=doctor_filter, view=view_mode) }}{% else %}{{ url_for('reports.collections_month', m=r['month'], f=from_date or '', t=to_date or '', format='json', doctor=doctor_filter, view=view_mode) }}{% endif %}">
                {% if range_mode %}{{ t('view_range') }}{% else %}{{ t('view_month') }}{% endif %}
              </button>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>

    <div style="padding: 24px; display: flex; justify-content: space-between; align-items: center; background: var(--bg-strong);">
      <div style="font-weight: 700; color: var(--text-secondary); font-size: 0.9rem;">
        {{ t('page') }} {{ page }} / {{ total_pages }}
      </div>
      <div style="display: flex; gap: 8px;">
        {% if has_prev %}
          <a class="u-btn ghost sm" href="{{ url_for('reports.collections_doctors', tab=tab, f=from_date, t=to_date, doctor=doctor_filter, view=view_mode, page=page-1) }}">
            <i class="fa fa-chevron-left"></i>
          </a>
        {% endif %}

        {% for pnum in range(1, total_pages + 1) %}
          {% if pnum == page %}
            <span class="u-btn primary sm" style="min-width: 40px; justify-content: center;">{{ pnum }}</span>
          {% elif pnum <= 3 or pnum > total_pages - 2 or (pnum >= page - 1 and pnum <= page + 1) %}
             <a class="u-btn ghost sm" style="min-width: 40px; justify-content: center;" href="{{ url_for('reports.collections_doctors', tab=tab, f=from_date, t=to_date, doctor=doctor_filter, view=view_mode, page=pnum) }}">{{ pnum }}</a>
          {% elif pnum == 4 or pnum == total_pages - 2 %}
            <span style="padding: 8px;">...</span>
          {% endif %}
        {% endfor %}

        {% if has_next %}
          <a class="u-btn ghost sm" href="{{ url_for('reports.collections_doctors', tab=tab, f=from_date, t=to_date, doctor=doctor_filter, view=view_mode, page=page+1) }}">
            <i class="fa fa-chevron-right"></i>
          </a>
        {% endif %}
      </div>
    </div>
  {% else %}
    <div style="text-align: center; padding: 80px 24px;">
      <div style="font-size: 4rem; margin-bottom: 24px; opacity: 0.2;">ðŸ“Š</div>
      <h3 style="margin: 0; font-weight: 700; color: var(--text-primary);">{{ t('no_rows') }}</h3>
      <p style="color: var(--text-muted); margin-top: 8px;">{{ t('collections_any_hint') }}</p>
    </div>
  {% endif %}
</div>

<div id="reports-modal" class="modal" aria-hidden="true">
  <div class="modal-backdrop"></div>
  <div class="modal-dialog" style="max-width: 900px;">
    <div class="modal-content" style="border-radius: 24px; overflow: hidden; border: none;">
      <div class="modal-header" style="background: var(--bg-strong); padding: 24px;">
        <h2 id="reports-modal-title" style="margin: 0; font-weight: 800; color: var(--text-primary);"></h2>
        <button type="button" class="close-btn" id="reports-modal-close-x" style="background: var(--bg-surface); border: 1px solid var(--border-strong); width: 40px; height: 40px; border-radius: 12px; cursor: pointer;">âœ•</button>
      </div>
      <div class="modal-body" style="padding: 24px; max-height: 70vh; overflow-y: auto;">
        <div id="reports-modal-content"></div>
      </div>
      <div class="modal-footer" style="padding: 20px 24px; background: var(--bg-strong); display: flex; justify-content: space-between; align-items: center;">
        <a id="reports-modal-export" href="#" class="u-btn ghost sm" target="_blank" rel="noopener">
          <i class="fa fa-download"></i> {{ t('export') }}
        </a>
        <button type="button" class="u-btn primary sm" id="reports-modal-close-btn">{{ t('close') }}</button>
      </div>
    </div>
  </div>
</div>

{% block extra_js %}
{{ super() }}
<script>
(function(){
  function qs(sel){ return document.querySelector(sel); }
  function qsa(sel){ return Array.prototype.slice.call(document.querySelectorAll(sel)); }

  var modal = qs('#reports-modal');
  var titleEl = qs('#reports-modal-title');
  var contentEl = qs('#reports-modal-content');
  var exportEl = qs('#reports-modal-export');
  var closeBtn = qs('#reports-modal-close-btn');
  var closeX = qs('.reports-modal-close');

  function openModal(){
    if(!modal) return;
    modal.setAttribute('aria-hidden', 'false');
    modal.style.display = 'flex';
  }

  function closeModal(){
    if(!modal) return;
    modal.setAttribute('aria-hidden', 'true');
    modal.style.display = 'none';
  }

  function renderModal(data){
    var rows = data && data.rows ? data.rows : [];
    if(!rows.length){
      contentEl.innerHTML = '<div style="text-align:center; padding: 40px;">{{ t("no_rows") }}</div>';
      return;
    }
    var viewMode = (data && data.view_mode) ? data.view_mode : 'payments';
    var html = [];
    html.push('<div style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">');
    html.push('<div style="background: var(--bg-strong); padding: 16px; border-radius: 16px;"><p style="margin:0; font-size:0.75rem; color:var(--text-secondary); font-weight:700; text-transform:uppercase;">{{ t("collections_total") }}</p><p style="margin:4px 0 0 0; font-size:1.25rem; font-weight:800; color:var(--primary-color);">'+ (data.summary_total_fmt || '') +' EGP</p></div>');
    if(viewMode === 'treatments'){
      html.push('<div style="background: var(--bg-strong); padding: 16px; border-radius: 16px;"><p style="margin:0; font-size:0.75rem; color:var(--text-secondary); font-weight:700; text-transform:uppercase;">{{ t("treatments") }}</p><p style="margin:4px 0 0 0; font-size:1.25rem; font-weight:800; color:var(--text-primary);">'+ (data.treatments_count || 0) +'</p></div>');
    }else{
      html.push('<div style="background: var(--bg-strong); padding: 16px; border-radius: 16px;"><p style="margin:0; font-size:0.75rem; color:var(--text-secondary); font-weight:700; text-transform:uppercase;">{{ t("payments") }}</p><p style="margin:4px 0 0 0; font-size:1.25rem; font-weight:800; color:var(--text-primary);">'+ (data.payments_count || 0) +'</p></div>');
    }
    html.push('<div style="background: var(--bg-strong); padding: 16px; border-radius: 16px;"><p style="margin:0; font-size:0.75rem; color:var(--text-secondary); font-weight:700; text-transform:uppercase;">{{ t("patients") }}</p><p style="margin:4px 0 0 0; font-size:1.25rem; font-weight:800; color:var(--text-primary);">'+ (data.patients_count || 0) +'</p></div>');
    html.push('</div>');

    html.push('<table class="u-table" style="font-size: 0.9rem;">');
    html.push('<thead><tr style="background: var(--bg-strong);">');
    if(viewMode === 'treatments'){
      html.push('<th style="padding:12px;">{{ t("patient") }}</th>');
      html.push('<th style="padding:12px;">{{ t("treatment_name") }}</th>');
      html.push('<th class="numeric" style="padding:12px;">{{ t("amount") }}</th>');
      html.push('<th class="numeric" style="padding:12px;">{{ t("payments") }}</th>');
    }else{
      html.push('<th style="padding:12px;">{{ t("date") }}</th>');
      html.push('<th style="padding:12px;">{{ t("patient") }}</th>');
      html.push('<th class="numeric" style="padding:12px;">{{ t("amount") }}</th>');
      html.push('<th style="padding:12px;">{{ t("method") }}</th>');
      html.push('<th style="padding:12px;">{{ t("doctor") }}</th>');
    }
    html.push('</tr></thead><tbody>');
    rows.forEach(function(r){
      html.push('<tr style="border-bottom: 1px solid var(--border-strong);">');
      var patientCell = (r.patient_url ? '<a href="'+ r.patient_url +'" target="_blank" rel="noopener" style="font-weight:700; color:var(--primary-color);">'+ (r.full_name || '') +'</a>' : (r.full_name || ''));
      if(viewMode === 'treatments'){
        html.push('<td style="padding:12px;">'+ patientCell +'</td>');
        html.push('<td style="padding:12px;">'+ (r.treatment || 'â€”') +'</td>');
        html.push('<td class="numeric" style="padding:12px; font-weight:700;">'+ (r.amount_fmt || '') +'</td>');
        html.push('<td class="numeric" style="padding:12px;">'+ (r.payments_count || 0) +'</td>');
      }else{
        html.push('<td style="padding:12px; font-weight:600; color:var(--text-secondary);">'+ (r.paid_at || '') +'</td>');
        html.push('<td style="padding:12px;">'+ patientCell +'</td>');
        html.push('<td class="numeric" style="padding:12px; font-weight:700;">'+ (r.amount_fmt || '') +'</td>');
        html.push('<td style="padding:12px;"><span class="pill sm" style="background:var(--bg-strong); color:var(--text-secondary); font-size:0.75rem;">'+ (r.method || '') +'</span></td>');
        var doctorLabel = r.doctor_label || '';
        var doctorCell = doctorLabel ? '<span style="font-weight:600; font-size:0.85rem;">'+ doctorLabel +'</span>' : '';
        html.push('<td style="padding:12px;">'+ doctorCell +'</td>');
      }
      html.push('</tr>');
    });
    html.push('</tbody></table>');
    contentEl.innerHTML = html.join('');
  }

  function attachHandlers(){
    var closeX = qs('#reports-modal-close-x');
    if(closeBtn){ closeBtn.addEventListener('click', closeModal); }
    if(closeX){ closeX.addEventListener('click', closeModal); }
    if(modal){
      modal.addEventListener('click', function(evt){
        if(evt.target === modal){ closeModal(); }
      });
    }

    qsa('.reports-view-btn').forEach(function(btn){
      btn.addEventListener('click', function(){
        var url = btn.getAttribute('data-url');
        var label = btn.getAttribute('data-label') || '';
        if(!url) return;
        fetch(url, { credentials: 'same-origin' })
          .then(function(res){ return res.json(); })
          .then(function(data){
            if(titleEl){
              titleEl.textContent = data.title || label;
            }
            if(exportEl && data.export_url){
              exportEl.href = data.export_url;
            }
            renderModal(data);
            openModal();
          })
          .catch(function(){
            contentEl.innerHTML = '<div class="reports-empty">{{ t("admin_generic_error") }}</div>';
            openModal();
          });
      });
    });
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', attachHandlers);
  }else{
    attachHandlers();
  }
})();
</script>
{% endblock %}
{% endblock %}
