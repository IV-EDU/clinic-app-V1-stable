{% extends '_base.html' %}
{% block content %}
<div class="card reports-header-card">
  <div class="reports-header-main">
    <div>
      <p class="eyebrow">{{ t('reports') }}</p>
      <h1 class="reports-title">{{ t('receivables') }}</h1>
    </div>
    <div class="reports-header-right">
      <div class="reports-view-switch">
        <a class="btn secondary" href="{{ url_for('reports.collections', tab='daily') }}">{{ t('collections') }}</a>
        <a class="btn secondary" href="{{ url_for('reports.collections_doctors', tab='daily') }}">{{ t('collections_by_doctor') }}</a>
        <a class="btn secondary active" href="{{ url_for('reports.receivables') }}">{{ t('receivables') }}</a>
      </div>
    </div>
  </div>
</div>

<style>
  .debt-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-strong);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: var(--shadow-soft);
  }

  .debt-metric {
    display: flex;
    align-items: center;
    gap: 20px;
    background: #fff5f5;
    border: 2px solid #feb2b2;
    padding: 24px;
    border-radius: 18px;
  }

  .debt-icon {
    font-size: 2.5rem;
    width: 64px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #fff;
    border-radius: 50%;
    box-shadow: 0 4px 10px rgba(229, 62, 62, 0.1);
  }

  .debt-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .debt-label {
    font-size: 0.9rem;
    text-transform: uppercase;
    font-weight: 700;
    color: #c53030;
  }

  .debt-total {
    font-size: 2.5rem;
    font-weight: 800;
    color: #9b2c2c;
    line-height: 1;
    margin: 0;
  }

  .row-highlight-red {
    background: #fff5f5 !important;
  }

  .debt-heavy {
    color: #c53030;
    font-weight: 800;
  }
</style>

<div class="debt-card">
  <div class="metric-grid">
    <div class="debt-metric">
      <div class="debt-icon">ðŸ’¸</div>
      <div class="debt-info">
        <div class="debt-label">{{ t('receivables_total') }}</div>
        <h2 class="debt-total">{{ total_owed_fmt }} <span style="font-size: 1rem;">EGP</span></h2>
      </div>
    </div>

    <div class="metric-item">
      <div class="metric-label">{{ t('receivables_patients') }}</div>
      <h2 class="metric-value">{{ patients_count }}</h2>
      <div class="metric-subtext">{{ t('patients_with_balance') or 'Patients with outstanding balance' }}</div>
    </div>
  </div>
</div>

<div class="card reports-table-card" style="border-radius: 20px; padding: 0; overflow: hidden;">
  {% if receivables %}
    <table class="reports-table">
      <thead>
        <tr>
          <th>{{ t('file_number') }}</th>
          <th>{{ t('name') }}</th>
          <th>{{ t('phone') }}</th>
          <th class="numeric">{{ t('overall_balance') }}</th>
          <th class="actions"></th>
        </tr>
      </thead>
      <tbody>
      {% for row in receivables %}
        <tr class="{{ 'row-highlight-red' if (row.balance_cents or 0) > 500000 else '' }}">
          <td class="c">{{ row.short_id or 'â€”' }}</td>
          <td class="c" style="font-weight: 700;">{{ row.full_name or 'â€”' }}</td>
          <td class="c">{{ row.phone or 'â€”' }}</td>
          <td class="c numeric {{ 'debt-heavy' if (row.balance_cents or 0) > 100000 else '' }}">{{ row.balance_fmt }}</td>
          <td class="c actions">
            <a class="btn secondary" href="{{ url_for('patients.patient_detail', pid=row.id) }}" target="_blank" rel="noopener">{{ t('view') }}</a>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
    <div class="pagination-row">
      <div class="pagination-info">
        {{ t('page') }} {{ page }}{% if total_pages %} / {{ total_pages }}{% endif %}
      </div>
      <div class="pagination-controls">
        {% if has_prev %}
          <a class="btn secondary" href="{{ url_for('reports.receivables', page=page-1) }}">{{ t('prev') }}</a>
        {% else %}
          <button class="btn secondary" disabled>{{ t('prev') }}</button>
        {% endif %}

        {% for pnum in range(1, total_pages + 1) %}
          {% if pnum == page %}
            <span class="btn primary">{{ pnum }}</span>
          {% else %}
            <a class="btn secondary" href="{{ url_for('reports.receivables', page=pnum) }}">{{ pnum }}</a>
          {% endif %}
        {% endfor %}

        {% if has_next %}
          <a class="btn primary" href="{{ url_for('reports.receivables', page=page+1) }}">{{ t('next') }}</a>
        {% else %}
          <button class="btn secondary" disabled>{{ t('next') }}</button>
        {% endif %}
      </div>
    </div>
  {% else %}
    <div class="reports-empty">{{ t('no_rows') }}</div>
  {% endif %}
</div>
{% endblock %}
